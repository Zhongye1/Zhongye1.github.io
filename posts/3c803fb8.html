<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><div id="myscoll"></div><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>AIç»˜ç”»ä¸æ‰©æ•£æ¨¡å‹ | å››æœˆ</title><meta name="keywords" content="Java,MySQL,ç®—æ³•,ä»£ç ,åšå®¢,Butterfly,Hexo,FomalhautğŸ¥,Fomalhaut"><meta name="author" content="æŸŠé‡"><meta name="copyright" content="æŸŠé‡"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="SDæ¨¡å‹åŸç† SDæ˜¯CompVisã€Stability AIå’ŒLAIONç­‰å…¬å¸ç ”å‘çš„ä¸€ä¸ªæ–‡ç”Ÿå›¾æ¨¡å‹ï¼Œå®ƒçš„æ¨¡å‹å’Œä»£ç æ˜¯å¼€æºçš„ï¼Œè€Œä¸”è®­ç»ƒæ•°æ®LAION-5Bä¹Ÿæ˜¯å¼€æºçš„ã€‚SDåœ¨å¼€æº90å¤©githubä»“åº“å°±æ”¶è·äº†33Kçš„starsï¼Œå¯è§è¿™ä¸ªæ¨¡å‹æ˜¯å¤šå—æ¬¢è¿ã€‚  SDæ˜¯ä¸€ä¸ªåŸºäºlatentçš„æ‰©æ•£æ¨¡å‹ï¼Œå®ƒåœ¨UNetä¸­å¼•å…¥text conditionæ¥å®ç°åŸºäºæ–‡æœ¬ç”Ÿæˆå›¾åƒã€‚SDçš„æ ¸å¿ƒæ¥æºäºLatent Diffu">
<meta property="og:type" content="article">
<meta property="og:title" content="AIç»˜ç”»ä¸æ‰©æ•£æ¨¡å‹">
<meta property="og:url" content="https://www.fomal.cc/posts/3c803fb8.html">
<meta property="og:site_name" content="å››æœˆ">
<meta property="og:description" content="SDæ¨¡å‹åŸç† SDæ˜¯CompVisã€Stability AIå’ŒLAIONç­‰å…¬å¸ç ”å‘çš„ä¸€ä¸ªæ–‡ç”Ÿå›¾æ¨¡å‹ï¼Œå®ƒçš„æ¨¡å‹å’Œä»£ç æ˜¯å¼€æºçš„ï¼Œè€Œä¸”è®­ç»ƒæ•°æ®LAION-5Bä¹Ÿæ˜¯å¼€æºçš„ã€‚SDåœ¨å¼€æº90å¤©githubä»“åº“å°±æ”¶è·äº†33Kçš„starsï¼Œå¯è§è¿™ä¸ªæ¨¡å‹æ˜¯å¤šå—æ¬¢è¿ã€‚  SDæ˜¯ä¸€ä¸ªåŸºäºlatentçš„æ‰©æ•£æ¨¡å‹ï¼Œå®ƒåœ¨UNetä¸­å¼•å…¥text conditionæ¥å®ç°åŸºäºæ–‡æœ¬ç”Ÿæˆå›¾åƒã€‚SDçš„æ ¸å¿ƒæ¥æºäºLatent Diffu">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://picss.sunbangyan.cn/2023/12/09/38a386e44035563b5554b58bffb506fa.jpeg%20-%20https://picss.sunbangyan.cn/2023/12/09/38a386e44035563b5554b58bffb506fa.jpeg">
<meta property="article:published_time" content="2023-10-29T13:50:19.000Z">
<meta property="article:modified_time" content="2023-12-08T12:52:06.633Z">
<meta property="article:author" content="æŸŠé‡">
<meta property="article:tag" content="Java,MySQL,ç®—æ³•,ä»£ç ,åšå®¢,Butterfly,Hexo,FomalhautğŸ¥,Fomalhaut">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://picss.sunbangyan.cn/2023/12/09/38a386e44035563b5554b58bffb506fa.jpeg%20-%20https://picss.sunbangyan.cn/2023/12/09/38a386e44035563b5554b58bffb506fa.jpeg"><link rel="shortcut icon" href="https://picss.sunbangyan.cn/2023/12/09/4f6102198c8763d95a33921cf7fd498f.jpeg"><link rel="canonical" href="https://www.fomal.cc/posts/3c803fb8"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'AIç»˜ç”»ä¸æ‰©æ•£æ¨¡å‹',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-12-08 20:52:06'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><style id="themeColor"></style><style id="rightSide"></style><style id="transPercent"></style><style id="blurNum"></style><style id="settingStyle"></style><span id="fps"></span><style id="defineBg"></style><style id="menu_shadow"></style><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="å››æœˆ" type="application/atom+xml">
</head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://picss.sunbangyan.cn/2023/12/09/1e9a9e9a65498d83fad24f1c8872f82e.jpeg" onerror="onerror=null;src='/assets/r1.jpg'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">53</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">11</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">10</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> ä¼‘é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> å…«éŸ³ç›’</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½±é™¢</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xiangzi"></use></svg><span class="menu_word" style="font-size:17px"> å…«å®ç®±</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-tubiaozhizuomoban">                   </use></svg><span class="menu_word" style="font-size:17px"> ç”»å»Š</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-nvwumao">                   </use></svg><span class="menu_word" style="font-size:17px"> åŠ¨ç”»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘å€å¯¼èˆª</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> æœ‹å‹åœˆ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> å‹äººå¸</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> æ—§æ—¶å…‰</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-maoliang"></use></svg><span class="menu_word" style="font-size:17px"> ä¸ªäºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/personal/bb/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-qunliaotian">                   </use></svg><span class="menu_word" style="font-size:17px"> å” å¨</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/love/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-love-sign">                   </use></svg><span class="menu_word" style="font-size:17px"> æ‹çˆ±å°å±‹</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane">                   </use></svg><span class="menu_word" style="font-size:17px"> å…³äº</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">å››æœˆ</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> ä¼‘é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> å…«éŸ³ç›’</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½±é™¢</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xiangzi"></use></svg><span class="menu_word" style="font-size:17px"> å…«å®ç®±</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-tubiaozhizuomoban">                   </use></svg><span class="menu_word" style="font-size:17px"> ç”»å»Š</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-nvwumao">                   </use></svg><span class="menu_word" style="font-size:17px"> åŠ¨ç”»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘å€å¯¼èˆª</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> æœ‹å‹åœˆ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> å‹äººå¸</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> æ—§æ—¶å…‰</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-maoliang"></use></svg><span class="menu_word" style="font-size:17px"> ä¸ªäºº</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/personal/bb/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-qunliaotian">                   </use></svg><span class="menu_word" style="font-size:17px"> å” å¨</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/love/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-love-sign">                   </use></svg><span class="menu_word" style="font-size:17px"> æ‹çˆ±å°å±‹</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/personal/about/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-paperplane">                   </use></svg><span class="menu_word" style="font-size:17px"> å…³äº</span></a></li></ul></div></div><center id="name-container"><a id="page-name" href="javascript:scrollToTop()">PAGE_NAME</a></center><div id="nav-right"><div id="search-button"><a class="search faa-parent animated-hover" title="æ£€ç´¢ç«™å†…ä»»ä½•ä½ æƒ³è¦çš„ä¿¡æ¯"><svg class="faa-tada icon" style="height:24px;width:24px;fill:currentColor;position:relative;top:6px" aria-hidden="true"><use xlink:href="#icon-valentine_-search-love-find-heart"></use></svg><span> æœç´¢</span></a></div><a class="meihua faa-parent animated-hover" onclick="toggleWinbox()" title="ç¾åŒ–è®¾ç½®-è‡ªå®šä¹‰ä½ çš„é£æ ¼" id="meihua-button"><svg class="faa-tada icon" style="height:26px;width:26px;fill:currentColor;position:relative;top:8px" aria-hidden="true"><use xlink:href="#icon-tupian1"></use></svg></a><a class="sun_moon faa-parent animated-hover" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢" id="nightmode-button"><svg class="faa-tada" style="height:25px;width:25px;fill:currentColor;position:relative;top:7px" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon">       </use></svg></a><div id="toggle-menu"><a><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav><div id="post-info"><h1 class="post-title">AIç»˜ç”»ä¸æ‰©æ•£æ¨¡å‹</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><svg class="meta_icon post-meta-icon" style="width:30px;height:30px;position:relative;top:10px"><use xlink:href="#icon-rili"></use></svg><span class="post-meta-label">å‘è¡¨äº </span><time class="post-meta-date-created" datetime="2023-10-29T13:50:19.000Z" title="å‘è¡¨äº 2023-10-29 21:50:19">2023-10-29</time><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-gengxin1"></use></svg><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2023-12-08T12:52:06.633Z" title="æ›´æ–°äº 2023-12-08 20:52:06">2023-12-08</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:8px"><use xlink:href="#icon-charuword"></use></svg><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">1.4w</span><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:20px;height:20px;position:relative;top:5px"><use xlink:href="#icon-shizhong"></use></svg><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>53åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="AIç»˜ç”»ä¸æ‰©æ•£æ¨¡å‹"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:5px"><use xlink:href="#icon-eye"></use></svg><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="SDæ¨¡å‹åŸç†"><strong>SDæ¨¡å‹åŸç†</strong></h2>
<p>SDæ˜¯<a href="https://link.zhihu.com/?target=https%3A//github.com/CompVis">CompVis</a>ã€<a href="https://link.zhihu.com/?target=https%3A//stability.ai/">Stability AI</a>å’Œ<a href="https://link.zhihu.com/?target=https%3A//laion.ai/">LAION</a>ç­‰å…¬å¸ç ”å‘çš„ä¸€ä¸ªæ–‡ç”Ÿå›¾æ¨¡å‹ï¼Œå®ƒçš„æ¨¡å‹å’Œä»£ç æ˜¯å¼€æºçš„ï¼Œè€Œä¸”è®­ç»ƒæ•°æ®<a href="https://link.zhihu.com/?target=https%3A//laion.ai/blog/laion-5b/">LAION-5B</a>ä¹Ÿæ˜¯å¼€æºçš„ã€‚SDåœ¨å¼€æº90å¤©githubä»“åº“å°±æ”¶è·äº†<strong>33Kçš„stars</strong>ï¼Œå¯è§è¿™ä¸ªæ¨¡å‹æ˜¯å¤šå—æ¬¢è¿ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic2.zhimg.com/80/v2-45c26a5ea3556598b5ce39348f672af5_1440w.webp" alt=""></p>
<p>SDæ˜¯ä¸€ä¸ª<strong>åŸºäºlatentçš„æ‰©æ•£æ¨¡å‹</strong>ï¼Œå®ƒåœ¨UNetä¸­å¼•å…¥text conditionæ¥å®ç°åŸºäºæ–‡æœ¬ç”Ÿæˆå›¾åƒã€‚SDçš„æ ¸å¿ƒæ¥æºäº<a href="https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2112.10752">Latent Diffusion</a>è¿™ä¸ªå·¥ä½œï¼Œå¸¸è§„çš„æ‰©æ•£æ¨¡å‹æ˜¯åŸºäºpixelçš„ç”Ÿæˆæ¨¡å‹ï¼Œè€ŒLatent Diffusionæ˜¯åŸºäºlatentçš„ç”Ÿæˆæ¨¡å‹ï¼Œå®ƒå…ˆé‡‡ç”¨ä¸€ä¸ªautoencoderå°†å›¾åƒå‹ç¼©åˆ°latentç©ºé—´ï¼Œç„¶åç”¨æ‰©æ•£æ¨¡å‹æ¥ç”Ÿæˆå›¾åƒçš„latentsï¼Œæœ€åé€å…¥autoencoderçš„decoderæ¨¡å—å°±å¯ä»¥å¾—åˆ°ç”Ÿæˆçš„å›¾åƒã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic4.zhimg.com/80/v2-649a55e230feba6997604da9724db197_1440w.webp" alt=""></p>
<p><strong>åŸºäºlatentçš„æ‰©æ•£æ¨¡å‹çš„ä¼˜åŠ¿åœ¨äºè®¡ç®—æ•ˆç‡æ›´é«˜æ•ˆï¼Œå› ä¸ºå›¾åƒçš„latentç©ºé—´è¦æ¯”å›¾åƒpixelç©ºé—´è¦å°ï¼Œè¿™ä¹Ÿæ˜¯SDçš„æ ¸å¿ƒä¼˜åŠ¿</strong>ã€‚æ–‡ç”Ÿå›¾æ¨¡å‹å¾€å¾€å‚æ•°é‡æ¯”è¾ƒå¤§ï¼ŒåŸºäºpixelçš„æ–¹æ³•å¾€å¾€é™äºç®—åŠ›åªç”Ÿæˆ64x64å¤§å°çš„å›¾åƒï¼Œæ¯”å¦‚OpenAIçš„DALL-E2å’Œè°·æ­Œçš„Imagenï¼Œç„¶åå†é€šè¿‡è¶…åˆ†è¾¨æ¨¡å‹å°†å›¾åƒåˆ†è¾¨ç‡æå‡è‡³256x256å’Œ1024x1024ï¼›è€ŒåŸºäºlatentçš„SDæ˜¯åœ¨latentç©ºé—´æ“ä½œçš„ï¼Œå®ƒå¯ä»¥ç›´æ¥ç”Ÿæˆ256x256å’Œ512x512ç”šè‡³æ›´é«˜åˆ†è¾¨ç‡çš„å›¾åƒã€‚</p>
<p>SDæ¨¡å‹çš„ä¸»ä½“ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸»è¦åŒ…æ‹¬ä¸‰ä¸ªæ¨¡å‹ï¼š</p>
<ul>
<li><strong>autoencoder</strong>ï¼šencoderå°†å›¾åƒå‹ç¼©åˆ°latentç©ºé—´ï¼Œè€Œdecoderå°†latentè§£ç ä¸ºå›¾åƒï¼›</li>
<li><strong>CLIP text encoder</strong>ï¼šæå–è¾“å…¥textçš„text embeddingsï¼Œé€šè¿‡cross attentionæ–¹å¼é€å…¥æ‰©æ•£æ¨¡å‹çš„UNetä¸­ä½œä¸ºconditionï¼›</li>
<li><strong>UNet</strong>ï¼šæ‰©æ•£æ¨¡å‹çš„ä¸»ä½“ï¼Œç”¨æ¥å®ç°æ–‡æœ¬å¼•å¯¼ä¸‹çš„latentç”Ÿæˆã€‚</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.zhimg.com/80/v2-fddf45ed17a509336d1550833a257684_1440w.webp" alt=""></p>
<p>å¯¹äºSDæ¨¡å‹ï¼Œå…¶autoencoderæ¨¡å‹å‚æ•°å¤§å°ä¸º84Mï¼ŒCLIP text encoderæ¨¡å‹å¤§å°ä¸º123Mï¼Œè€ŒUNetå‚æ•°å¤§å°ä¸º860Mï¼Œæ‰€ä»¥<strong>SDæ¨¡å‹çš„æ€»å‚æ•°é‡çº¦ä¸º1B</strong>ã€‚</p>
<h3 id="autoencoder"><strong>autoencoder</strong></h3>
<p>autoencoderæ˜¯ä¸€ä¸ªåŸºäºencoder-decoderæ¶æ„çš„å›¾åƒå‹ç¼©æ¨¡å‹ï¼Œå¯¹äºä¸€ä¸ªå¤§å°ä¸ºçš„è¾“å…¥å›¾åƒï¼Œencoderæ¨¡å—å°†å…¶ç¼–ç ä¸ºä¸€ä¸ªå¤§å°ä¸ºçš„latentï¼Œå…¶ä¸­ä¸ºä¸‹é‡‡æ ·ç‡ï¼ˆdownsampling factorï¼‰ã€‚åœ¨è®­ç»ƒautoencoderè¿‡ç¨‹ä¸­ï¼Œé™¤äº†é‡‡ç”¨<strong>L1é‡å»ºæŸå¤±</strong>å¤–ï¼Œè¿˜å¢åŠ äº†<strong>æ„ŸçŸ¥æŸå¤±</strong>ï¼ˆperceptual lossï¼Œå³LPIPSï¼Œå…·ä½“è§è®ºæ–‡<a href="https://link.zhihu.com/?target=https%3A//richzhang.github.io/PerceptualSimilarity/">The Unreasonable Effectiveness of Deep Features as a Perceptual Metric</a>ï¼‰ä»¥åŠ<strong>åŸºäºpatchçš„å¯¹æŠ—è®­ç»ƒ</strong>ã€‚è¾…åŠ©lossä¸»è¦æ˜¯ä¸ºäº†ç¡®ä¿é‡å»ºçš„å›¾åƒå±€éƒ¨çœŸå®æ€§ä»¥åŠé¿å…æ¨¡ç³Šï¼Œå…·ä½“æŸå¤±å‡½æ•°è§<a href="https://link.zhihu.com/?target=https%3A//github.com/CompVis/latent-diffusion/tree/main/ldm/modules/losses">latent diffusionçš„losséƒ¨åˆ†</a>ã€‚åŒæ—¶ä¸ºäº†é˜²æ­¢å¾—åˆ°çš„latentçš„æ ‡å‡†å·®è¿‡å¤§ï¼Œé‡‡ç”¨äº†ä¸¤ç§æ­£åˆ™åŒ–æ–¹æ³•ï¼šç¬¬ä¸€ç§æ˜¯<strong>KL-reg</strong>ï¼Œç±»ä¼¼VAEå¢åŠ ä¸€ä¸ªlatentå’Œæ ‡å‡†æ­£æ€åˆ†å¸ƒçš„KL lossï¼Œä¸è¿‡è¿™é‡Œä¸ºäº†ä¿è¯é‡å»ºæ•ˆæœï¼Œé‡‡ç”¨æ¯”è¾ƒå°çš„æƒé‡ï¼ˆï½10e-6ï¼‰ï¼›ç¬¬äºŒç§æ˜¯<strong>VQ-reg</strong>ï¼Œå¼•å…¥ä¸€ä¸ªVQ ï¼ˆvector quantizationï¼‰layerï¼Œæ­¤æ—¶çš„æ¨¡å‹å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªVQ-GANï¼Œä¸è¿‡VQå±‚æ˜¯åœ¨decoderæ¨¡å—ä¸­ï¼Œè¿™é‡ŒVQçš„codebooké‡‡æ ·è¾ƒé«˜çš„ç»´åº¦ï¼ˆ8192ï¼‰æ¥é™ä½æ­£åˆ™åŒ–å¯¹é‡å»ºæ•ˆæœçš„å½±å“ã€‚ latent diffusionè®ºæ–‡ä¸­å®éªŒäº†ä¸åŒå‚æ•°ä¸‹çš„autoencoderæ¨¡å‹ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼Œå¯ä»¥çœ‹åˆ°å½“è¾ƒå°å’Œè¾ƒå¤§æ—¶ï¼Œé‡å»ºæ•ˆæœè¶Šå¥½ï¼ˆPSNRè¶Šå¤§ï¼‰ï¼Œè¿™ä¹Ÿæ¯”è¾ƒç¬¦åˆé¢„æœŸï¼Œæ¯•ç«Ÿæ­¤æ—¶å‹ç¼©ç‡å°ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic3.zhimg.com/80/v2-e4e760f8a0762f1cb7130e9d99b602d6_1440w.webp" alt=""></p>
<p>è®ºæ–‡è¿›ä¸€æ­¥å°†ä¸åŒçš„autoencoderåœ¨æ‰©æ•£æ¨¡å‹ä¸Šè¿›è¡Œå®éªŒï¼Œåœ¨ImageNetæ•°æ®é›†ä¸Šè®­ç»ƒåŒæ ·çš„æ­¥æ•°ï¼ˆ2M stepsï¼‰ï¼Œå…¶è®­ç»ƒè¿‡ç¨‹çš„ç”Ÿæˆè´¨é‡å¦‚ä¸‹æ‰€ç¤ºï¼Œå¯ä»¥çœ‹åˆ°è¿‡å°çš„ï¼ˆæ¯”å¦‚1å’Œ2ï¼‰ä¸‹æ”¶æ•›é€Ÿåº¦æ…¢ï¼Œæ­¤æ—¶å›¾åƒçš„æ„ŸçŸ¥å‹ç¼©ç‡è¾ƒå°ï¼Œæ‰©æ•£æ¨¡å‹éœ€è¦è¾ƒé•¿çš„å­¦ä¹ ï¼›è€Œè¿‡å¤§çš„å…¶ç”Ÿæˆè´¨é‡è¾ƒå·®ï¼Œæ­¤æ—¶å‹ç¼©æŸå¤±è¿‡å¤§ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic2.zhimg.com/80/v2-e35e58a520fa825f64e89eea4422ea89_1440w.webp" alt=""></p>
<p>å½“åœ¨4ï½16æ—¶ï¼Œå¯ä»¥å–å¾—ç›¸å¯¹å¥½çš„æ•ˆæœã€‚SDé‡‡ç”¨åŸºäºKL-regçš„autoencoderï¼Œå…¶ä¸­ä¸‹é‡‡æ ·ç‡ï¼Œç‰¹å¾ç»´åº¦ä¸ºï¼Œå½“è¾“å…¥å›¾åƒä¸º512x512å¤§å°æ—¶å°†å¾—åˆ°64x64x4å¤§å°çš„latentã€‚ autoencoderæ¨¡å‹æ—¶åœ¨OpenImagesæ•°æ®é›†ä¸ŠåŸºäº256x256å¤§å°è®­ç»ƒçš„ï¼Œä½†æ˜¯ç”±äºautoencoderçš„æ¨¡å‹æ˜¯å…¨å·ç§¯ç»“æ„çš„ï¼ˆåŸºäºResnetBlockï¼Œåªæœ‰æ¨¡å‹çš„ä¸­é—´å­˜åœ¨ä¸¤ä¸ªself attentionå±‚ï¼‰ï¼Œæ‰€ä»¥å®ƒå¯ä»¥æ‰©å±•åº”ç”¨åœ¨å°ºå¯¸&gt;256çš„å›¾åƒä¸Šã€‚ä¸‹é¢æˆ‘ä»¬ç»™å‡ºä½¿ç”¨diffusersåº“æ¥åŠ è½½autoencoderæ¨¡å‹ï¼Œå¹¶ä½¿ç”¨autoencoderæ¥å®ç°å›¾åƒçš„å‹ç¼©å’Œé‡å»ºï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> diffusers <span class="keyword">import</span> AutoencoderKL</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"><span class="comment">#åŠ è½½æ¨¡å‹: autoencoderå¯ä»¥é€šè¿‡SDæƒé‡æŒ‡å®šsubfolderæ¥å•ç‹¬åŠ è½½</span></span><br><span class="line">autoencoder = AutoencoderKL.from_pretrained(<span class="string">&quot;runwayml/stable-diffusion-v1-5&quot;</span>, subfolder=<span class="string">&quot;vae&quot;</span>)</span><br><span class="line">autoencoder.to(<span class="string">&quot;cuda&quot;</span>, dtype=torch.float16)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å–å›¾åƒå¹¶é¢„å¤„ç†</span></span><br><span class="line">raw_image = Image.<span class="built_in">open</span>(<span class="string">&quot;boy.png&quot;</span>).convert(<span class="string">&quot;RGB&quot;</span>).resize((<span class="number">256</span>, <span class="number">256</span>))</span><br><span class="line">image = np.array(raw_image).astype(np.float32) / <span class="number">127.5</span> - <span class="number">1.0</span></span><br><span class="line">image = image[<span class="literal">None</span>].transpose(<span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">image = torch.from_numpy(image)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‹ç¼©å›¾åƒä¸ºlatentå¹¶é‡å»º</span></span><br><span class="line"><span class="keyword">with</span> torch.inference_mode():</span><br><span class="line">    latent = autoencoder.encode(image.to(<span class="string">&quot;cuda&quot;</span>, dtype=torch.float16)).latent_dist.sample()</span><br><span class="line">    rec_image = autoencoder.decode(latent).sample</span><br><span class="line">    rec_image = (rec_image / <span class="number">2</span> + <span class="number">0.5</span>).clamp(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    rec_image = rec_image.cpu().permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>).numpy()</span><br><span class="line">    rec_image = (rec_image * <span class="number">255</span>).<span class="built_in">round</span>().astype(<span class="string">&quot;uint8&quot;</span>)</span><br><span class="line">    rec_image = Image.fromarray(rec_image[<span class="number">0</span>])</span><br><span class="line">rec_image</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬ç»™å‡ºäº†ä¸¤å¼ å›¾ç‰‡åœ¨256x256å’Œ512x512ä¸‹çš„é‡å»ºæ•ˆæœå¯¹æ¯”ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œç¬¬ä¸€åˆ—ä¸ºåŸå§‹å›¾ç‰‡ï¼Œç¬¬äºŒåˆ—ä¸º512x512å°ºå¯¸ä¸‹çš„é‡å»ºå›¾ï¼Œç¬¬ä¸‰åˆ—ä¸º256x256å°ºå¯¸ä¸‹çš„é‡å»ºå›¾ã€‚å¯¹æ¯”å¯ä»¥çœ‹å‡ºï¼Œautoencoderå°†å›¾ç‰‡å‹ç¼©åˆ°latentåå†é‡å»ºå…¶å®æ˜¯æœ‰æŸçš„ï¼Œæ¯”å¦‚ä¼šå‡ºç°æ–‡å­—å’Œäººè„¸çš„ç•¸å˜ï¼Œåœ¨256x256åˆ†è¾¨ç‡ä¸‹æ˜¯æ¯”è¾ƒæ˜æ˜¾çš„ï¼Œ512x512ä¸‹æ•ˆæœä¼šå¥½å¾ˆå¤šã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic3.zhimg.com/80/v2-2f439931568ec63d03e40c1735f9264e_1440w.webp" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic3.zhimg.com/80/v2-cb198cc9134f4dab69ec7365b90078e6_1440w.webp" alt=""></p>
<p>è¿™ç§æœ‰æŸå‹ç¼©è‚¯å®šæ˜¯å¯¹SDçš„ç”Ÿæˆå›¾åƒè´¨é‡æ˜¯æœ‰ä¸€å®šå½±å“çš„ï¼Œä¸è¿‡å¥½åœ¨SDæ¨¡å‹åŸºæœ¬ä¸Šæ˜¯åœ¨512x512ä»¥ä¸Šåˆ†è¾¨ç‡ä¸‹ä½¿ç”¨çš„ã€‚ä¸ºäº†æ”¹å–„è¿™ç§ç•¸å˜ï¼Œstabilityaiåœ¨å‘å¸ƒSD 2.0æ—¶åŒæ—¶å‘å¸ƒäº†ä¸¤ä¸ªåœ¨LAIONå­æ•°æ®é›†ä¸Š<a href="https://link.zhihu.com/?target=https%3A//huggingface.co/stabilityai/sd-vae-ft-mse-original">ç²¾è°ƒçš„autoencoder</a>ï¼Œæ³¨æ„è¿™é‡Œåªç²¾è°ƒautoencoderçš„decoderéƒ¨åˆ†ï¼ŒSDçš„UNetåœ¨è®­ç»ƒè¿‡ç¨‹åªéœ€è¦encoderéƒ¨åˆ†ï¼Œæ‰€ä»¥è¿™æ ·ç²¾è°ƒåçš„autoencoderå¯ä»¥ç›´æ¥ç”¨åœ¨å…ˆå‰è®­ç»ƒå¥½çš„UNetä¸Šï¼ˆè¿™ç§æŠ€å·§è¿˜æ˜¯æ¯”è¾ƒé€šç”¨çš„ï¼Œæ¯”å¦‚è°·æ­Œçš„<a href="https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2206.10789">Parti</a>ä¹Ÿæ˜¯åœ¨è®­ç»ƒå¥½åè‡ªå›å½’ç”Ÿæˆæ¨¡å‹åï¼Œæ‰©å¤§å¹¶ç²¾è°ƒViT-VQGANçš„decoderæ¨¡å—æ¥æå‡ç”Ÿæˆè´¨é‡ï¼‰ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥åœ¨diffusersä¸­ä½¿ç”¨è¿™äº›autoencoderï¼Œæ¯”å¦‚mseç‰ˆæœ¬ï¼ˆé‡‡ç”¨mseæŸå¤±æ¥finetuneçš„æ¨¡å‹ï¼‰ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">autoencoder = AutoencoderKL.from_pretrained(<span class="string">&quot;stabilityai/sd-vae-ft-mse/&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>å¯¹äºåŒæ ·çš„ä¸¤å¼ å›¾ï¼Œè¿™ä¸ªmseç‰ˆæœ¬çš„é‡å»ºæ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼Œå¯ä»¥çœ‹åˆ°ç›¸æ¯”åŸå§‹ç‰ˆæœ¬çš„autoencoderï¼Œç•¸å˜æ˜¯æœ‰ä¸€å®šæ”¹å–„çš„ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic4.zhimg.com/80/v2-ee18f2e828fd1357b2c29c2355439fcb_1440w.webp" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic3.zhimg.com/80/v2-818195b8ac7730ab632ae32b47f9272e_1440w.webp" alt=""></p>
<p>ç”±äºSDé‡‡ç”¨çš„autoencoderæ˜¯åŸºäºKL-regçš„ï¼Œæ‰€ä»¥è¿™ä¸ªautoencoderåœ¨ç¼–ç å›¾åƒæ—¶å…¶å®å¾—åˆ°çš„æ˜¯ä¸€ä¸ªé«˜æ–¯åˆ†å¸ƒ<a href="https://link.zhihu.com/?target=https%3A//github.com/huggingface/diffusers/blob/bbab8553224d12f7fd58b0e65b0daf899769ef0b/src/diffusers/models/vae.py%23L312">DiagonalGaussianDistribution</a>ï¼ˆåˆ†å¸ƒçš„å‡å€¼å’Œæ ‡å‡†å·®ï¼‰ï¼Œç„¶åé€šè¿‡è°ƒç”¨sampleæ–¹æ³•æ¥é‡‡æ ·ä¸€ä¸ªå…·ä½“çš„latentï¼ˆè°ƒç”¨modeæ–¹æ³•å¯ä»¥å¾—åˆ°å‡å€¼ï¼‰ã€‚ç”±äºKL-regçš„æƒé‡ç³»æ•°éå¸¸å°ï¼Œå®é™…å¾—åˆ°latentçš„æ ‡å‡†å·®è¿˜æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œlatent diffusionè®ºæ–‡ä¸­æå‡ºäº†ä¸€ç§rescalingæ–¹æ³•ï¼šé¦–å…ˆè®¡ç®—å‡ºç¬¬ä¸€ä¸ªbatchæ•°æ®ä¸­çš„latentçš„æ ‡å‡†å·®ï¼Œç„¶åé‡‡ç”¨çš„ç³»æ•°æ¥rescale latentï¼Œè¿™æ ·å°±å°½é‡ä¿è¯latentçš„æ ‡å‡†å·®æ¥è¿‘1ï¼ˆé˜²æ­¢æ‰©æ•£è¿‡ç¨‹çš„SNRè¾ƒé«˜ï¼Œå½±å“ç”Ÿæˆæ•ˆæœï¼Œå…·ä½“è§latent diffusionè®ºæ–‡çš„D1éƒ¨åˆ†è®¨è®ºï¼‰ï¼Œç„¶åæ‰©æ•£æ¨¡å‹ä¹Ÿæ˜¯åº”ç”¨åœ¨rescalingçš„latentä¸Šï¼Œåœ¨è§£ç æ—¶åªéœ€è¦å°†ç”Ÿæˆçš„latenté™¤ä»¥ï¼Œç„¶åå†é€å…¥autoencoderçš„decoderå³å¯ã€‚å¯¹äºSDæ‰€ä½¿ç”¨çš„autoencoderï¼Œè¿™ä¸ªrescalingç³»æ•°ä¸º0.18215ã€‚</p>
<h3 id="CLIP-text-encoder"><strong>CLIP text encoder</strong></h3>
<p>SD<strong>é‡‡ç”¨CLIP text encoderæ¥å¯¹è¾“å…¥textæå–text embeddings</strong>ï¼Œå…·ä½“çš„æ˜¯é‡‡ç”¨ç›®å‰OpenAIæ‰€å¼€æºçš„æœ€å¤§CLIPæ¨¡å‹ï¼š<a href="https://link.zhihu.com/?target=https%3A//huggingface.co/openai/clip-vit-large-patch14">clip-vit-large-patch14</a>ï¼Œè¿™ä¸ªCLIPçš„text encoderæ˜¯ä¸€ä¸ªtransformeræ¨¡å‹ï¼ˆåªæœ‰encoderæ¨¡å—ï¼‰ï¼šå±‚æ•°ä¸º12ï¼Œç‰¹å¾ç»´åº¦ä¸º768ï¼Œæ¨¡å‹å‚æ•°å¤§å°æ˜¯123Mã€‚å¯¹äºè¾“å…¥textï¼Œé€å…¥CLIP text encoderåå¾—åˆ°æœ€åçš„hidden statesï¼ˆå³æœ€åä¸€ä¸ªtransformer blockå¾—åˆ°çš„ç‰¹å¾ï¼‰ï¼Œå…¶ç‰¹å¾ç»´åº¦å¤§å°ä¸º77x768ï¼ˆ77æ˜¯tokençš„æ•°é‡ï¼‰ï¼Œ<strong>è¿™ä¸ªç»†ç²’åº¦çš„text embeddingså°†ä»¥cross attentionçš„æ–¹å¼é€å…¥UNetä¸­</strong>ã€‚åœ¨transofmersåº“ä¸­ï¼Œå¯ä»¥å¦‚ä¸‹ä½¿ç”¨CLIP text encoderï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> CLIPTextModel, CLIPTokenizer</span><br><span class="line"></span><br><span class="line">text_encoder = CLIPTextModel.from_pretrained(<span class="string">&quot;runwayml/stable-diffusion-v1-5&quot;</span>, subfolder=<span class="string">&quot;text_encoder&quot;</span>).to(<span class="string">&quot;cuda&quot;</span>)</span><br><span class="line"><span class="comment"># text_encoder = CLIPTextModel.from_pretrained(&quot;openai/clip-vit-large-patch14&quot;).to(&quot;cuda&quot;)</span></span><br><span class="line">tokenizer = CLIPTokenizer.from_pretrained(<span class="string">&quot;runwayml/stable-diffusion-v1-5&quot;</span>, subfolder=<span class="string">&quot;tokenizer&quot;</span>)</span><br><span class="line"><span class="comment"># tokenizer = CLIPTokenizer.from_pretrained(&quot;openai/clip-vit-large-patch14&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹è¾“å…¥çš„textè¿›è¡Œtokenizeï¼Œå¾—åˆ°å¯¹åº”çš„token ids</span></span><br><span class="line">prompt = <span class="string">&quot;a photograph of an astronaut riding a horse&quot;</span></span><br><span class="line">text_input_ids = text_tokenizer(</span><br><span class="line">    prompt,</span><br><span class="line">    padding=<span class="string">&quot;max_length&quot;</span>,</span><br><span class="line">    max_length=tokenizer.model_max_length,</span><br><span class="line">    truncation=<span class="literal">True</span>,</span><br><span class="line">    return_tensors=<span class="string">&quot;pt&quot;</span></span><br><span class="line">).input_ids</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†token idsé€å…¥text modelå¾—åˆ°77x768çš„ç‰¹å¾</span></span><br><span class="line">text_embeddings = text_encoder(text_input_ids.to(<span class="string">&quot;cuda&quot;</span>))[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„tokenizeræœ€å¤§é•¿åº¦ä¸º77ï¼ˆCLIPè®­ç»ƒæ—¶æ‰€é‡‡ç”¨çš„è®¾ç½®ï¼‰ï¼Œå½“è¾“å…¥textçš„tokensæ•°é‡è¶…è¿‡77åï¼Œå°†è¿›è¡Œæˆªæ–­ï¼Œå¦‚æœä¸è¶³åˆ™è¿›è¡Œpaddingsï¼Œè¿™æ ·å°†ä¿è¯æ— è®ºè¾“å…¥ä»»ä½•é•¿åº¦çš„æ–‡æœ¬ï¼ˆç”šè‡³æ˜¯ç©ºæ–‡æœ¬ï¼‰éƒ½å¾—åˆ°77x768å¤§å°çš„ç‰¹å¾ã€‚ åœ¨è®­ç»ƒSDçš„è¿‡ç¨‹ä¸­ï¼Œ<strong>CLIP text encoderæ¨¡å‹æ˜¯å†»ç»“çš„</strong>ã€‚åœ¨æ—©æœŸçš„å·¥ä½œä¸­ï¼Œæ¯”å¦‚OpenAIçš„<a href="https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2112.10741">GLIDE</a>å’Œlatent diffusionä¸­çš„LDMå‡é‡‡ç”¨ä¸€ä¸ªéšæœºåˆå§‹åŒ–çš„tranformeræ¨¡å‹æ¥æå–textçš„ç‰¹å¾ï¼Œä½†æ˜¯æœ€æ–°çš„å·¥ä½œéƒ½æ˜¯é‡‡ç”¨é¢„è®­ç»ƒå¥½çš„text modelã€‚æ¯”å¦‚è°·æ­Œçš„Imagené‡‡ç”¨çº¯æ–‡æœ¬æ¨¡å‹T5 encoderæ¥æå‡ºæ–‡æœ¬ç‰¹å¾ï¼Œè€ŒSDåˆ™é‡‡ç”¨CLIP text encoderï¼Œé¢„è®­ç»ƒå¥½çš„æ¨¡å‹å¾€å¾€å·²ç»åœ¨å¤§è§„æ¨¡æ•°æ®é›†ä¸Šè¿›è¡Œäº†è®­ç»ƒï¼Œå®ƒä»¬è¦æ¯”ç›´æ¥é‡‡ç”¨ä¸€ä¸ªä»é›¶è®­ç»ƒå¥½çš„æ¨¡å‹è¦å¥½ã€‚</p>
<h3 id="UNet"><strong>UNet</strong></h3>
<p>SDçš„æ‰©æ•£æ¨¡å‹æ˜¯ä¸€ä¸ª860Mçš„UNetï¼Œå…¶ä¸»è¦ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆè¿™é‡Œä»¥è¾“å…¥çš„latentä¸º64x64x4ç»´åº¦ä¸ºä¾‹ï¼‰ï¼Œå…¶ä¸­encoderéƒ¨åˆ†åŒ…æ‹¬3ä¸ªCrossAttnDownBlock2Dæ¨¡å—å’Œ1ä¸ªDownBlock2Dæ¨¡å—ï¼Œè€Œdecoderéƒ¨åˆ†åŒ…æ‹¬1ä¸ªUpBlock2Dæ¨¡å—å’Œ3ä¸ªCrossAttnUpBlock2Dæ¨¡å—ï¼Œä¸­é—´è¿˜æœ‰ä¸€ä¸ªUNetMidBlock2DCrossAttnæ¨¡å—ã€‚encoderå’Œdecoderä¸¤ä¸ªéƒ¨åˆ†æ˜¯å®Œå…¨å¯¹åº”çš„ï¼Œä¸­é—´å­˜åœ¨skip connectionã€‚æ³¨æ„3ä¸ªCrossAttnDownBlock2Dæ¨¡å—æœ€åå‡æœ‰ä¸€ä¸ª2xçš„downsampleæ“ä½œï¼Œè€ŒDownBlock2Dæ¨¡å—æ˜¯ä¸åŒ…å«ä¸‹é‡‡æ ·çš„ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic3.zhimg.com/80/v2-2c71f809868ea14d0e2f8caa024781e2_1440w.webp" alt=""></p>
<p>å…¶ä¸­CrossAttnDownBlock2Dæ¨¡å—çš„ä¸»è¦ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œtext conditionå°†é€šè¿‡CrossAttentionæ¨¡å—åµŒå…¥è¿›æ¥ï¼Œæ­¤æ—¶Attentionçš„queryæ˜¯UNetçš„ä¸­é—´ç‰¹å¾ï¼Œè€Œkeyå’Œvalueåˆ™æ˜¯text embeddingsã€‚ CrossAttnUpBlock2Dæ¨¡å—å’ŒCrossAttnDownBlock2Dæ¨¡å—æ˜¯ä¸€è‡´çš„ï¼Œä½†æ˜¯å°±æ˜¯æ€»å±‚æ•°ä¸º3ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic3.zhimg.com/80/v2-0eff7fa232e2d33aeb435132c4cd897a_1440w.webp" alt=""></p>
<p>SDå’ŒDDPMä¸€æ ·é‡‡ç”¨é¢„æµ‹noiseçš„æ–¹æ³•æ¥è®­ç»ƒUNetï¼Œå…¶è®­ç»ƒæŸå¤±ä¹Ÿå’ŒDDPMä¸€æ ·ï¼šÂ Â è¿™é‡Œçš„ä¸ºtext embeddingsï¼Œæ­¤æ—¶çš„æ¨¡å‹æ˜¯ä¸€ä¸ªæ¡ä»¶æ‰©æ•£æ¨¡å‹ã€‚åŸºäºdiffusersåº“ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå¿«å®ç°SDçš„è®­ç»ƒï¼Œå…¶æ ¸å¿ƒä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼ˆè¿™é‡Œå‚è€ƒdiffusersåº“ä¸‹examplesä¸­çš„<a href="https://link.zhihu.com/?target=https%3A//github.com/huggingface/diffusers/blob/main/examples/text_to_image/train_text_to_image.py">finetuneä»£ç </a>ï¼‰ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> diffusers <span class="keyword">import</span> AutoencoderKL, UNet2DConditionModel, DDPMScheduler</span><br><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> CLIPTextModel, CLIPTokenizer</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½autoencoder</span></span><br><span class="line">vae = AutoencoderKL.from_pretrained(<span class="string">&quot;runwayml/stable-diffusion-v1-5&quot;</span>, subfolder=<span class="string">&quot;vae&quot;</span>)</span><br><span class="line"><span class="comment"># åŠ è½½text encoder</span></span><br><span class="line">text_encoder = CLIPTextModel.from_pretrained(<span class="string">&quot;runwayml/stable-diffusion-v1-5&quot;</span>, subfolder=<span class="string">&quot;text_encoder&quot;</span>)</span><br><span class="line">tokenizer = CLIPTokenizer.from_pretrained(<span class="string">&quot;runwayml/stable-diffusion-v1-5&quot;</span>, subfolder=<span class="string">&quot;tokenizer&quot;</span>)</span><br><span class="line"><span class="comment"># åˆå§‹åŒ–UNet</span></span><br><span class="line">unet = UNet2DConditionModel(**model_config) <span class="comment"># model_configä¸ºæ¨¡å‹å‚æ•°é…ç½®</span></span><br><span class="line"><span class="comment"># å®šä¹‰scheduler</span></span><br><span class="line">noise_scheduler = DDPMScheduler(</span><br><span class="line">    beta_start=<span class="number">0.00085</span>, beta_end=<span class="number">0.012</span>, beta_schedule=<span class="string">&quot;scaled_linear&quot;</span>, num_train_timesteps=<span class="number">1000</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†»ç»“vaeå’Œtext_encoder</span></span><br><span class="line">vae.requires_grad_(<span class="literal">False</span>)</span><br><span class="line">text_encoder.requires_grad_(<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">opt = torch.optim.AdamW(unet.parameters(), lr=<span class="number">1e-4</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> step, batch <span class="keyword">in</span> <span class="built_in">enumerate</span>(train_dataloader):</span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        <span class="comment"># å°†imageè½¬åˆ°latentç©ºé—´</span></span><br><span class="line">        latents = vae.encode(batch[<span class="string">&quot;image&quot;</span>]).latent_dist.sample()</span><br><span class="line">        latents = latents * vae.config.scaling_factor <span class="comment"># rescaling latents</span></span><br><span class="line">        <span class="comment"># æå–text embeddings</span></span><br><span class="line">        text_input_ids = text_tokenizer(</span><br><span class="line">            batch[<span class="string">&quot;text&quot;</span>],</span><br><span class="line">            padding=<span class="string">&quot;max_length&quot;</span>,</span><br><span class="line">            max_length=tokenizer.model_max_length,</span><br><span class="line">            truncation=<span class="literal">True</span>,</span><br><span class="line">            return_tensors=<span class="string">&quot;pt&quot;</span></span><br><span class="line">  ).input_ids</span><br><span class="line">  text_embeddings = text_encoder(text_input_ids)[<span class="number">0</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># éšæœºé‡‡æ ·å™ªéŸ³</span></span><br><span class="line">    noise = torch.randn_like(latents)</span><br><span class="line">    bsz = latents.shape[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># éšæœºé‡‡æ ·timestep</span></span><br><span class="line">    timesteps = torch.randint(<span class="number">0</span>, noise_scheduler.num_train_timesteps, (bsz,), device=latents.device)</span><br><span class="line">    timesteps = timesteps.long()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å°†noiseæ·»åŠ åˆ°latentä¸Šï¼Œå³æ‰©æ•£è¿‡ç¨‹</span></span><br><span class="line">    noisy_latents = noise_scheduler.add_noise(latents, noise, timesteps)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># é¢„æµ‹noiseå¹¶è®¡ç®—loss</span></span><br><span class="line">    model_pred = unet(noisy_latents, timesteps, encoder_hidden_states=text_embeddings).sample</span><br><span class="line">    loss = F.mse_loss(model_pred.<span class="built_in">float</span>(), noise.<span class="built_in">float</span>(), reduction=<span class="string">&quot;mean&quot;</span>)</span><br><span class="line"></span><br><span class="line"> opt.step()</span><br><span class="line">    opt.zero_grad()</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„çš„æ˜¯SDçš„noise schedulerè™½ç„¶ä¹Ÿæ˜¯é‡‡ç”¨ä¸€ä¸ª1000æ­¥é•¿çš„schedulerï¼Œä½†æ˜¯ä¸æ˜¯linearçš„ï¼Œè€Œæ˜¯scaled linearï¼Œå…·ä½“çš„è®¡ç®—å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">betas = torch.linspace(beta_start**<span class="number">0.5</span>, beta_end**<span class="number">0.5</span>, num_train_timesteps, dtype=torch.float32) ** <span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>åœ¨è®­ç»ƒæ¡ä»¶æ‰©æ•£æ¨¡å‹æ—¶ï¼Œå¾€å¾€ä¼šé‡‡ç”¨<strong>Classifier-Free Guidance</strong>ï¼ˆè¿™é‡Œç®€ç§°ä¸ºCFGï¼‰ï¼Œæ‰€è°“çš„CFGç®€å•æ¥è¯´å°±æ˜¯åœ¨è®­ç»ƒæ¡ä»¶æ‰©æ•£æ¨¡å‹çš„åŒæ—¶ä¹Ÿè®­ç»ƒä¸€ä¸ªæ— æ¡ä»¶çš„æ‰©æ•£æ¨¡å‹ï¼ŒåŒæ—¶åœ¨é‡‡æ ·é˜¶æ®µå°†æ¡ä»¶æ§åˆ¶ä¸‹é¢„æµ‹çš„å™ªéŸ³å’Œæ— æ¡ä»¶ä¸‹çš„é¢„æµ‹å™ªéŸ³ç»„åˆåœ¨ä¸€èµ·æ¥ç¡®å®šæœ€ç»ˆçš„å™ªéŸ³ï¼Œå…·ä½“çš„è®¡ç®—å…¬å¼å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p>è¿™é‡Œçš„ä¸º<strong>guidance scale</strong>ï¼Œå½“è¶Šå¤§æ—¶ï¼Œconditionèµ·çš„ä½œç”¨è¶Šå¤§ï¼Œå³ç”Ÿæˆçš„å›¾åƒå…¶æ›´å’Œè¾“å…¥æ–‡æœ¬ä¸€è‡´ã€‚CFGçš„å…·ä½“å®ç°éå¸¸ç®€å•ï¼Œåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦<strong>ä»¥ä¸€å®šçš„æ¦‚ç‡ï¼ˆæ¯”å¦‚10%ï¼‰éšæœºdropæ‰text</strong>å³å¯ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥å°†textç½®ä¸ºç©ºå­—ç¬¦ä¸²ï¼ˆå‰é¢è¯´è¿‡æ­¤æ—¶ä¾ç„¶èƒ½å¤Ÿæå–text embeddingsï¼‰ã€‚è¿™é‡Œå¹¶æ²¡æœ‰ä»‹ç»CLFèƒŒåçš„æŠ€æœ¯åŸç†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥é˜…è¯»CFGçš„è®ºæ–‡<a href="https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2207.12598">Classifier-Free Diffusion Guidance</a>ä»¥åŠguided diffusionçš„è®ºæ–‡<a href="https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2105.05233">Diffusion Models Beat GANs on Image Synthesis</a>ã€‚<strong>CFGå¯¹äºæå‡æ¡ä»¶æ‰©æ•£æ¨¡å‹çš„å›¾åƒç”Ÿæˆæ•ˆæœæ˜¯è‡³å…³é‡è¦çš„</strong>ã€‚</p>
<h3 id="è®­ç»ƒç»†èŠ‚"><strong>è®­ç»ƒç»†èŠ‚</strong></h3>
<p>å‰é¢æˆ‘ä»¬ä»‹ç»äº†SDçš„æ¨¡å‹ç»“æ„ï¼Œè¿™é‡Œæˆ‘ä»¬ä¹Ÿç®€å•ä»‹ç»ä¸€ä¸‹SDçš„è®­ç»ƒç»†èŠ‚ï¼Œä¸»è¦åŒ…æ‹¬è®­ç»ƒæ•°æ®å’Œè®­ç»ƒèµ„æºï¼Œè¿™æ–¹é¢ä¹Ÿæ˜¯åœ¨SDçš„<a href="https://link.zhihu.com/?target=https%3A//huggingface.co/runwayml/stable-diffusion-v1-5">Model Card</a>ä¸Šæœ‰è¯´æ˜ã€‚ é¦–å…ˆæ˜¯è®­ç»ƒæ•°æ®ï¼ŒSDåœ¨<a href="https://link.zhihu.com/?target=https%3A//huggingface.co/datasets/laion/laion2B-en">laion2B-en</a><strong>æ•°æ®é›†</strong>ä¸Šè®­ç»ƒçš„ï¼Œå®ƒæ˜¯<a href="https://link.zhihu.com/?target=https%3A//laion.ai/blog/laion-5b/">laion-5b</a><strong>æ•°æ®é›†</strong>çš„ä¸€ä¸ªå­é›†ï¼Œæ›´å…·ä½“çš„è¯´å®ƒæ˜¯laion-5bä¸­çš„è‹±æ–‡ï¼ˆæ–‡æœ¬ä¸ºè‹±æ–‡ï¼‰æ•°æ®é›†ã€‚laion-5bæ•°æ®é›†æ˜¯ä»ç½‘é¡µæ•°æ®Common Crawlä¸­ç­›é€‰å‡ºæ¥çš„å›¾åƒ-æ–‡æœ¬å¯¹æ•°æ®é›†ï¼Œå®ƒåŒ…å«5.85Bçš„å›¾åƒ-æ–‡æœ¬å¯¹ï¼Œå…¶ä¸­æ–‡æœ¬ä¸ºè‹±æ–‡çš„æ•°æ®é‡ä¸º2.32Bï¼Œè¿™å°±æ˜¯laion2B-enæ•°æ®é›†ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic3.zhimg.com/80/v2-91d5227730b38d1c72d7858d3b67fbba_1440w.webp" alt=""></p>
<p>ä¸‹é¢æ˜¯laion2B-enæ•°æ®é›†çš„å…ƒä¿¡æ¯ï¼ˆå›¾ç‰‡widthå’Œheightï¼Œä»¥åŠæ–‡æœ¬é•¿åº¦ï¼‰ç»Ÿè®¡åˆ†æï¼šå…¶ä¸­å›¾ç‰‡çš„widthå’Œheightå‡åœ¨256ä»¥ä¸Šçš„æ ·æœ¬é‡ä¸º1324Mï¼Œåœ¨512ä»¥ä¸Šçš„æ ·æœ¬é‡ä¸º488Mï¼Œè€Œåœ¨1024ä»¥ä¸Šçš„æ ·æœ¬ä¸º76Mï¼›æ–‡æœ¬çš„å¹³å‡é•¿åº¦ä¸º67ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.zhimg.com/80/v2-7bc54f633af1760a97b5af05746a74a0_1440w.webp" alt=""></p>
<p>laionæ•°æ®é›†ä¸­é™¤äº†å›¾ç‰‡ï¼ˆä¸‹è½½URLï¼Œå›¾åƒwidthå’Œheightï¼‰å’Œæ–‡æœ¬ï¼ˆæè¿°æ–‡æœ¬ï¼‰çš„å…ƒä¿¡æ¯å¤–ï¼Œè¿˜åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š</p>
<ul>
<li>similarityï¼šä½¿ç”¨CLIP ViT-B/32è®¡ç®—å‡ºæ¥çš„å›¾åƒå’Œæ–‡æœ¬ä½™å¼¦ç›¸ä¼¼åº¦ï¼›</li>
<li>pwatermarkï¼šä½¿ç”¨ä¸€ä¸ªå›¾ç‰‡<a href="https://link.zhihu.com/?target=https%3A//github.com/LAION-AI/LAION-5B-WatermarkDetection">æ°´å°æ£€æµ‹å™¨</a>æ£€æµ‹çš„æ¦‚ç‡å€¼ï¼Œè¡¨ç¤ºå›¾ç‰‡å«æœ‰æ°´å°çš„æ¦‚ç‡ï¼›</li>
<li>punsafeï¼šå›¾ç‰‡æ˜¯å¦å®‰å…¨ï¼Œæˆ–è€…å›¾ç‰‡æ˜¯ä¸æ˜¯NSFWï¼Œä½¿ç”¨<a href="https://link.zhihu.com/?target=https%3A//github.com/LAION-AI/CLIP-based-NSFW-Detector">åŸºäºCLIPçš„æ£€æµ‹å™¨</a>æ¥ä¼°è®¡ï¼›</li>
<li>AESTHETIC_SCOREï¼šå›¾ç‰‡çš„ç¾å­¦è¯„åˆ†ï¼ˆ1-10ï¼‰ï¼Œè¿™ä¸ªæ˜¯åæ¥è¿½åŠ çš„ï¼Œé¦–å…ˆé€‰æ‹©ä¸€å°éƒ¨åˆ†å›¾ç‰‡æ•°æ®é›†è®©äººå¯¹å›¾ç‰‡çš„ç¾å­¦æ‰“åˆ†ï¼Œç„¶ååŸºäºè¿™ä¸ªæ ‡æ³¨æ•°æ®é›†æ¥è®­ç»ƒä¸€ä¸ª<a href="https://link.zhihu.com/?target=https%3A//laion.ai/blog/laion-aesthetics/">æ‰“åˆ†æ¨¡å‹</a>ï¼Œå¹¶å¯¹æ‰€æœ‰æ ·æœ¬è®¡ç®—ä¼°è®¡çš„ç¾å­¦è¯„åˆ†ã€‚</li>
</ul>
<p>ä¸Šé¢æ˜¯laionæ•°æ®é›†çš„æƒ…å†µï¼Œä¸‹é¢æˆ‘ä»¬æ¥ä»‹ç»SDè®­ç»ƒæ•°æ®é›†çš„å…·ä½“æƒ…å†µï¼Œ<strong>SDçš„è®­ç»ƒæ˜¯å¤šé˜¶æ®µçš„</strong>ï¼ˆå…ˆåœ¨256x256å°ºå¯¸ä¸Šé¢„è®­ç»ƒï¼Œç„¶ååœ¨512x512å°ºå¯¸ä¸Šç²¾è°ƒï¼‰ï¼Œä¸åŒçš„é˜¶æ®µäº§ç”Ÿäº†ä¸åŒçš„ç‰ˆæœ¬ï¼š</p>
<ul>
<li>SD v1.1ï¼šåœ¨laion2B-enæ•°æ®é›†ä¸Šä»¥256x256å¤§å°è®­ç»ƒ237,000æ­¥ï¼Œä¸Šé¢æˆ‘ä»¬å·²ç»è¯´äº†ï¼Œlaion2B-enæ•°æ®é›†ä¸­256ä»¥ä¸Šçš„æ ·æœ¬é‡å…±1324Mï¼›ç„¶ååœ¨laion5Bçš„<a href="https://link.zhihu.com/?target=https%3A//huggingface.co/datasets/laion/laion-high-resolution">é«˜åˆ†è¾¨ç‡æ•°æ®é›†</a>ä»¥512x512å°ºå¯¸è®­ç»ƒ194,000æ­¥ï¼Œè¿™é‡Œçš„é«˜åˆ†è¾¨ç‡æ•°æ®é›†æ˜¯å›¾åƒå°ºå¯¸åœ¨1024x1024ä»¥ä¸Šï¼Œå…±170Mæ ·æœ¬ã€‚</li>
<li>SD v1.2ï¼šä»¥SD v1.1ä¸ºåˆå§‹æƒé‡ï¼Œåœ¨<a href="https://link.zhihu.com/?target=https%3A//huggingface.co/datasets/ChristophSchuhmann/improved_aesthetics_5plus">improved_aesthetics_5plus</a>æ•°æ®é›†ä¸Šä»¥512x512å°ºå¯¸è®­ç»ƒ515,000æ­¥æ•°ï¼Œè¿™ä¸ªimproved_aesthetics_5plusæ•°æ®é›†ä¸Šlaion2B-enæ•°æ®é›†ä¸­ç¾å­¦è¯„åˆ†åœ¨5åˆ†ä»¥ä¸Šçš„å­é›†ï¼ˆå…±çº¦600Mæ ·æœ¬ï¼‰ï¼Œæ³¨æ„è¿™é‡Œè¿‡æ»¤äº†å«æœ‰æ°´å°çš„å›¾ç‰‡ï¼ˆpwatermark&gt;0.5)ä»¥åŠå›¾ç‰‡å°ºå¯¸åœ¨512x512ä»¥ä¸‹çš„æ ·æœ¬ã€‚</li>
<li>SD v1.3ï¼šä»¥SD v1.2ä¸ºåˆå§‹æƒé‡ï¼Œåœ¨improved_aesthetics_5plusæ•°æ®é›†ä¸Šç»§ç»­ä»¥512x512å°ºå¯¸è®­ç»ƒ195,000æ­¥æ•°ï¼Œä¸è¿‡è¿™é‡Œé‡‡ç”¨äº†CFGï¼ˆä»¥10%çš„æ¦‚ç‡éšæœºdropæ‰textï¼‰ã€‚</li>
<li>SD v1.4ï¼šä»¥SD v1.2ä¸ºåˆå§‹æƒé‡ï¼Œåœ¨improved_aesthetics_5plusæ•°æ®é›†ä¸Šé‡‡ç”¨CFGä»¥512x512å°ºå¯¸è®­ç»ƒ225,000æ­¥æ•°ã€‚</li>
<li>SD v1.5ï¼šä»¥SD v1.2ä¸ºåˆå§‹æƒé‡ï¼Œåœ¨improved_aesthetics_5plusæ•°æ®é›†ä¸Šé‡‡ç”¨CFGä»¥512x512å°ºå¯¸è®­ç»ƒ595,000æ­¥æ•°ã€‚</li>
</ul>
<p>å…¶å®å¯ä»¥çœ‹åˆ°SD v1.3ã€SD v1.4å’ŒSD v1.5å…¶å®æ˜¯ä»¥SD v1.2ä¸ºèµ·ç‚¹åœ¨improved_aesthetics_5plusæ•°æ®é›†ä¸Šé‡‡ç”¨CFGè®­ç»ƒè¿‡ç¨‹ä¸­çš„ä¸åŒcheckpointsï¼Œ<strong>ç›®å‰æœ€å¸¸ç”¨çš„ç‰ˆæœ¬æ˜¯SD v1.4å’ŒSD v1.5</strong>ã€‚ SDçš„è®­ç»ƒæ˜¯<strong>é‡‡ç”¨äº†32å°8å¡çš„A100æœºå™¨</strong>ï¼ˆ32 x 8 x A100_40GB GPUsï¼‰ï¼Œæ‰€éœ€è¦çš„è®­ç»ƒç¡¬ä»¶è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œä½†æ˜¯ç›¸æ¯”è¯­è¨€å¤§æ¨¡å‹è¿˜å¥½ã€‚å•å¡çš„è®­ç»ƒbatch sizeä¸º2ï¼Œå¹¶é‡‡ç”¨gradient accumulationï¼Œå…¶ä¸­gradient accumulation steps=2ï¼Œé‚£ä¹ˆè®­ç»ƒçš„<strong>æ€»batch sizeå°±æ˜¯32x8x2x2=2048</strong>ã€‚è®­ç»ƒ<strong>ä¼˜åŒ–å™¨é‡‡ç”¨AdamW</strong>ï¼Œè®­ç»ƒé‡‡ç”¨warmupï¼Œåœ¨åˆå§‹10,000æ­¥å<strong>å­¦ä¹ é€Ÿç‡å‡åˆ°0.0001</strong>ï¼Œåé¢ä¿æŒä¸å˜ã€‚è‡³äºè®­ç»ƒæ—¶é—´ï¼Œæ–‡æ¡£ä¸Šåªè¯´äº†ç”¨äº†150,000å°æ—¶ï¼Œè¿™ä¸ªåº”è¯¥æ˜¯A100å¡æ—¶ï¼Œå¦‚æœæŒ‰ç…§256å¡A100æ¥ç®—çš„è¯ï¼Œé‚£ä¹ˆå¤§çº¦<strong>éœ€è¦è®­ç»ƒ25å¤©å·¦å³</strong>ã€‚</p>
<h3 id="æ¨¡å‹è¯„æµ‹"><strong>æ¨¡å‹è¯„æµ‹</strong></h3>
<p>ä¸Šé¢ä»‹ç»äº†æ¨¡å‹è®­ç»ƒç»†èŠ‚ï¼Œé‚£ä¹ˆæœ€åçš„é—®é¢˜å°±æ˜¯æ¨¡å‹è¯„æµ‹äº†ã€‚å¯¹äºæ–‡ç”Ÿå›¾æ¨¡å‹ï¼Œç›®å‰å¸¸é‡‡ç”¨çš„å®šé‡æŒ‡æ ‡æ˜¯<strong>FID</strong>ï¼ˆFrÃ©chet inception distanceï¼‰å’ŒCLIP scoreï¼Œå…¶ä¸­FIDå¯ä»¥è¡¡é‡ç”Ÿæˆå›¾åƒçš„é€¼çœŸåº¦ï¼ˆimage fidelityï¼‰ï¼Œè€ŒCLIP scoreè¯„æµ‹çš„æ˜¯ç”Ÿæˆçš„å›¾åƒä¸è¾“å…¥æ–‡æœ¬çš„ä¸€è‡´æ€§ï¼Œå…¶ä¸­FIDè¶Šä½è¶Šå¥½ï¼Œè€ŒCLIP scoreæ˜¯è¶Šå¤§è¶Šå¥½ã€‚å½“CFGçš„gudiance scaleå‚æ•°è®¾ç½®ä¸åŒæ—¶ï¼ŒFIDå’ŒCLIP scoreä¼šå‘ç”Ÿå˜åŒ–ï¼Œä¸‹å›¾ä¸ºä¸åŒçš„gudiance scaleå‚æ•°ä¸‹ï¼ŒSDæ¨¡å‹åœ¨COCO2017éªŒè¯é›†ä¸Šçš„è¯„æµ‹ç»“æœï¼Œæ³¨æ„è¿™é‡Œæ˜¯zero-shotè¯„æµ‹ï¼Œå³SDæ¨¡å‹å¹¶æ²¡æœ‰åœ¨COCOè®­ç»ƒæ•°æ®é›†ä¸Šç²¾è°ƒã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.zhimg.com/80/v2-b7ef3c892c5b833191b483932c42fc1c_1440w.webp" alt=""></p>
<p>å¯ä»¥çœ‹åˆ°å½“gudiance scale=3æ—¶ï¼ŒFIDæœ€ä½ï¼›è€Œå½“gudiance scaleè¶Šå¤§æ—¶ï¼ŒCLIP scoreè¶Šå¤§ï¼Œä½†æ˜¯FIDåŒæ—¶ä¹Ÿå˜å¤§ã€‚åœ¨å®é™…åº”ç”¨æ—¶ï¼Œå¾€å¾€ä¼šé‡‡ç”¨è¾ƒå¤§çš„gudiance scaleï¼Œæ¯”å¦‚SDæ¨¡å‹é»˜è®¤é‡‡ç”¨7.5ï¼Œæ­¤æ—¶ç”Ÿæˆçš„å›¾åƒå’Œæ–‡æœ¬æœ‰è¾ƒå¥½çš„ä¸€è‡´æ€§ã€‚ä»ä¸åŒç‰ˆæœ¬çš„å¯¹æ¯”æ›²çº¿ä¸Šçœ‹ï¼ŒSDçš„é‡‡ç”¨CFGè®­ç»ƒåä¸‰ä¸ªç‰ˆæœ¬å…¶å®å·®åˆ«å¹¶æ²¡æœ‰é‚£ä¹ˆå¤§ï¼Œå…¶ä¸­SD v1.5ç›¸å¯¹å¥½ä¸€ç‚¹ï¼Œä½†æ˜¯æ˜æ˜¾è¦æœªé‡‡ç”¨CFGè®­ç»ƒçš„ç‰ˆæœ¬è¦å¥½çš„å¤šï¼Œè¿™è¯´æ˜CFGè®­ç»ƒæ˜¯æ¯”è¾ƒå…³é”®çš„ã€‚ ç›®å‰åœ¨æ¨¡å‹å¯¹æ¯”ä¸Šï¼Œå¤§å®¶å¾€å¾€æ˜¯æ¯”è¾ƒä¸åŒæ¨¡å‹åœ¨COCOéªŒè¯é›†ä¸Šçš„zero-shot FID-30Kï¼ˆé€‰æ‹©30Kçš„æ ·æœ¬ï¼‰ï¼Œå¤§å®¶å¾€å¾€å°±é€‰æ‹©æ¨¡å‹æ‰€èƒ½å¾—åˆ°çš„æœ€å°FIDæ¥æ¯”è¾ƒï¼Œä¸‹é¢ä¸ºeDiffå’ŒGigaGANä¸¤ç¯‡è®ºæ–‡æ‰€æŠ¥é“çš„ä¸åŒæ–‡ç”Ÿå›¾æ¨¡å‹çš„FIDå¯¹æ¯”ï¼ˆç”±äºSDå¹¶æ²¡æœ‰ç»™å‡ºFID-30Kï¼Œæ‰€ä»¥å¤§å®¶åº”è¯¥éƒ½æ˜¯è‡ªå·±ç”¨å¼€æºSDçš„æ¨¡å‹è®¡ç®—çš„ï¼Œç”±äºé€‰æ‹©æ ·æœ¬ä¸åŒï¼Œå¯èƒ½ç»“æœå­˜åœ¨å·®å¼‚ï¼‰ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.zhimg.com/80/v2-979a3b11b99fbd854f472e8902f578a0_1440w.webp" alt=""></p>
<p>å¯ä»¥çœ‹åˆ°SDè™½ç„¶FIDä¸æ˜¯æœ€å¥½çš„ï¼Œä½†æ˜¯ä¹Ÿèƒ½è¾¾åˆ°æ¯”è¾ƒä½çš„FIDï¼ˆå¤§çº¦åœ¨8ï½9ä¹‹é—´ï¼‰ã€‚ä¸è¿‡è™½ç„¶å­¦æœ¯ç•Œå¸¸é‡‡ç”¨FIDæ¥å®šé‡æ¯”è¾ƒæ¨¡å‹ï¼Œä½†æ˜¯FIDæœ‰å¾ˆå¤§çš„å±€é™æ€§ï¼Œå®ƒå¹¶ä¸èƒ½å¾ˆå¥½åœ°è¡¡é‡ç”Ÿæˆå›¾åƒçš„è´¨é‡ï¼Œä¹Ÿæ˜¯å› ä¸ºè¿™ä¸ªåŸå› ï¼Œè°·æ­Œçš„Imagenå¼•å…¥äº†äººå·¥è¯„ä»·ï¼Œå…ˆå»ºç«‹ä¸€ä¸ªè¯„æµ‹æ•°æ®é›†DrawBenchï¼ˆåŒ…å«200ä¸ªä¸åŒç±»å‹çš„textï¼‰ï¼Œç„¶åç”¨ä¸åŒçš„æ¨¡å‹æ¥ç”Ÿæˆå›¾åƒï¼Œè®©äººå»è¯„ä»·åŒä¸€ä¸ªtextä¸‹ä¸åŒæ¨¡å‹ç”Ÿæˆçš„å›¾åƒï¼Œè¿™ç§è¯„æµ‹æ–¹å¼æ¯”è¾ƒç›´æ¥ï¼Œä½†æ˜¯å¯èƒ½ä¹Ÿå—ä¸€äº›ä¸»è§‚å› ç´ çš„å½±å“ã€‚æ€»è€Œè¨€ä¹‹ï¼Œç›®å‰çš„è¯„ä»·æ–¹å¼éƒ½æœ‰ä¸€å®šçš„å±€é™æ€§ï¼Œæœ€å¥½è¿˜æ˜¯ç›´æ¥ä¸Šæ‰‹ä½¿ç”¨æ¥æ¯”è¾ƒä¸åŒçš„æ¨¡å‹ã€‚</p>
<h2 id="SDçš„ä¸»è¦åº”ç”¨"><strong>SDçš„ä¸»è¦åº”ç”¨</strong></h2>
<p>ä¸‹é¢æ¥ä»‹ç»SDçš„ä¸»è¦åº”ç”¨ï¼Œè¿™åŒ…æ‹¬<strong>æ–‡ç”Ÿå›¾</strong>ï¼Œ<strong>å›¾ç”Ÿå›¾</strong>ä»¥åŠ<strong>å›¾åƒinpainting</strong>ã€‚å…¶ä¸­æ–‡ç”Ÿå›¾æ˜¯SDçš„åŸºç¡€åŠŸèƒ½ï¼šæ ¹æ®è¾“å…¥æ–‡æœ¬ç”Ÿæˆç›¸åº”çš„å›¾åƒï¼Œè€Œå›¾ç”Ÿå›¾å’Œå›¾åƒinpaintingæ˜¯åœ¨æ–‡ç”Ÿå›¾çš„åŸºç¡€ä¸Šå»¶ä¼¸å‡ºæ¥çš„ä¸¤ä¸ªåŠŸèƒ½ã€‚</p>
<h3 id="æ–‡ç”Ÿå›¾"><strong>æ–‡ç”Ÿå›¾</strong></h3>
<p>æ ¹æ®æ–‡æœ¬ç”Ÿæˆå›¾åƒè¿™æ˜¯æ–‡ç”Ÿå›¾çš„æœ€æ ¸å¿ƒçš„åŠŸèƒ½ï¼Œä¸‹å›¾ä¸ºSDçš„æ–‡ç”Ÿå›¾çš„æ¨ç†æµç¨‹å›¾ï¼šé¦–å…ˆæ ¹æ®è¾“å…¥textç”¨text encoderæå–text embeddingsï¼ŒåŒæ—¶åˆå§‹åŒ–ä¸€ä¸ªéšæœºå™ªéŸ³noiseï¼ˆlatentä¸Šçš„ï¼Œ512x512å›¾åƒå¯¹åº”çš„noiseç»´åº¦ä¸º64x64x4ï¼‰ï¼Œç„¶åå°†text embeddingså’Œnoiseé€å…¥æ‰©æ•£æ¨¡å‹UNetä¸­ç”Ÿæˆå»å™ªåçš„latentï¼Œæœ€åé€å…¥autoencoderçš„decoderæ¨¡å—å¾—åˆ°ç”Ÿæˆçš„å›¾åƒã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic3.zhimg.com/80/v2-4b69474b69a10f7963cc8a6f68ede756_1440w.webp" alt=""></p>
<p>ä½¿ç”¨diffusersåº“ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è°ƒç”¨<code>StableDiffusionPipeline</code>æ¥å®ç°æ–‡ç”Ÿå›¾ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> diffusers <span class="keyword">import</span> StableDiffusionPipeline</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»„åˆå›¾åƒï¼Œç”Ÿæˆgrid</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">image_grid</span>(<span class="params">imgs, rows, cols</span>):</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(imgs) == rows*cols</span><br><span class="line"></span><br><span class="line">    w, h = imgs[<span class="number">0</span>].size</span><br><span class="line">    grid = Image.new(<span class="string">&#x27;RGB&#x27;</span>, size=(cols*w, rows*h))</span><br><span class="line">    grid_w, grid_h = grid.size</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i, img <span class="keyword">in</span> <span class="built_in">enumerate</span>(imgs):</span><br><span class="line">        grid.paste(img, box=(i%cols*w, i//cols*h))</span><br><span class="line">    <span class="keyword">return</span> grid</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½æ–‡ç”Ÿå›¾pipeline</span></span><br><span class="line">pipe = StableDiffusionPipeline.from_pretrained(</span><br><span class="line">    <span class="string">&quot;runwayml/stable-diffusion-v1-5&quot;</span>, <span class="comment"># æˆ–è€…ä½¿ç”¨ SD v1.4: &quot;CompVis/stable-diffusion-v1-4&quot;</span></span><br><span class="line">    torch_dtype=torch.float16</span><br><span class="line">).to(<span class="string">&quot;cuda&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¾“å…¥textï¼Œè¿™é‡Œtextåˆç§°ä¸ºprompt</span></span><br><span class="line">prompts = [</span><br><span class="line">    <span class="string">&quot;a photograph of an astronaut riding a horse&quot;</span>,</span><br><span class="line">    <span class="string">&quot;A cute otter in a rainbow whirlpool holding shells, watercolor&quot;</span>,</span><br><span class="line">    <span class="string">&quot;An avocado armchair&quot;</span>,</span><br><span class="line">    <span class="string">&quot;A white dog wearing sunglasses&quot;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">generator = torch.Generator(<span class="string">&quot;cuda&quot;</span>).manual_seed(<span class="number">42</span>) <span class="comment"># å®šä¹‰éšæœºseedï¼Œä¿è¯å¯é‡å¤æ€§</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œæ¨ç†</span></span><br><span class="line">images = pipe(</span><br><span class="line">    prompts,</span><br><span class="line">    height=<span class="number">512</span>,</span><br><span class="line">    width=<span class="number">512</span>,</span><br><span class="line">    num_inference_steps=<span class="number">50</span>,</span><br><span class="line">    guidance_scale=<span class="number">7.5</span>,</span><br><span class="line">    negative_prompt=<span class="literal">None</span>,</span><br><span class="line">    num_images_per_prompt=<span class="number">1</span>,</span><br><span class="line">    generator=generator</span><br><span class="line">).images</span><br><span class="line"></span><br><span class="line">grid = image_grid(images, rows=<span class="number">1</span>, cols=<span class="number">4</span>)</span><br><span class="line">grid</span><br></pre></td></tr></table></figure>
<p>ç”Ÿæˆçš„å›¾åƒæ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic2.zhimg.com/80/v2-e2da18f32ca57ed37f36d5099da636ad_1440w.webp" alt=""></p>
<p>è¿™é‡Œå¯ä»¥é€šè¿‡æŒ‡å®šwidthå’Œheightæ¥å†³å®šç”Ÿæˆå›¾åƒçš„å¤§å°ï¼Œå‰é¢è¯´è¿‡SDæœ€åæ˜¯åœ¨512x512å°ºåº¦ä¸Šè®­ç»ƒçš„ï¼Œæ‰€ä»¥ç”Ÿæˆ512x512å°ºå¯¸æ•ˆæœæ˜¯æœ€å¥½çš„ï¼Œä½†æ˜¯å®é™…ä¸ŠSDå¯ä»¥ç”Ÿæˆä»»æ„å°ºå¯¸çš„å›¾ç‰‡ï¼šä¸€æ–¹é¢autoencoderæ”¯æŒä»»æ„å°ºå¯¸çš„å›¾ç‰‡çš„ç¼–ç å’Œè§£ç ï¼Œå¦å¤–ä¸€æ–¹é¢æ‰©æ•£æ¨¡å‹UNetä¹Ÿæ˜¯æ”¯æŒä»»æ„å°ºå¯¸çš„latentsç”Ÿæˆçš„ï¼ˆUNetæ˜¯å·ç§¯+attentionçš„æ··åˆç»“æ„ï¼‰ã€‚ç„¶è€Œï¼Œç”Ÿæˆ512x512ä»¥å¤–çš„å›¾ç‰‡ä¼šå­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚ç”Ÿæˆä½åˆ†è¾¨ç‡å›¾åƒæ—¶ï¼Œå›¾åƒçš„è´¨é‡å¤§å¹…åº¦ä¸‹é™ï¼Œä¸‹å›¾ä¸ºåŒæ ·çš„æ–‡æœ¬åœ¨256x256å°ºå¯¸ä¸‹çš„ç”Ÿæˆæ•ˆæœï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic4.zhimg.com/80/v2-17adfbcb66d31299a2c397c16066c463_1440w.webp" alt=""></p>
<p>å¦‚æœæ˜¯ç”Ÿæˆ512x512ä»¥ä¸Šåˆ†è¾¨ç‡çš„å›¾åƒï¼Œå›¾åƒè´¨é‡è™½ç„¶æ²¡é—®é¢˜ï¼Œä½†æ˜¯å¯èƒ½ä¼šå‡ºç°é‡å¤ç‰©ä½“ä»¥åŠç‰©ä½“è¢«æ‹‰é•¿çš„æƒ…å†µï¼Œä¸‹å›¾ä¸ºåˆ†åˆ«ä¸º768x512å’Œ512x768å°ºå¯¸ä¸‹çš„ç”Ÿæˆæ•ˆæœï¼Œå¯ä»¥çœ‹åˆ°éƒ¨åˆ†å›¾åƒå­˜åœ¨ä¸€å®šçš„é—®é¢˜ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.zhimg.com/80/v2-76de42ced2d2cda89bb0aebe7086bc2c_1440w.webp" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.zhimg.com/80/v2-6259780a378b797cbb58d12471acbca8_1440w.webp" alt=""></p>
<p>æ‰€ä»¥è™½ç„¶SDçš„æ¶æ„ä¸Šæ”¯æŒä»»æ„å°ºå¯¸çš„å›¾åƒç”Ÿæˆï¼Œä½†è®­ç»ƒæ˜¯åœ¨å›ºå®šå°ºå¯¸ä¸Šï¼ˆ512x512ï¼‰ï¼Œç”Ÿæˆå…¶å®ƒå°ºå¯¸å›¾åƒè¿˜æ˜¯ä¼šå­˜åœ¨ä¸€å®šçš„é—®é¢˜ã€‚è§£å†³è¿™ä¸ªé—®é¢˜çš„åŠæ³•å°±ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯é‡‡ç”¨å¤šå°ºåº¦ç­–ç•¥è®­ç»ƒï¼Œæ¯”å¦‚NovelAIæå‡ºé‡‡ç”¨<a href="https://link.zhihu.com/?target=https%3A//github.com/NovelAI/novelai-aspect-ratio-bucketing">Aspect Ratio Bucketing</a>ç­–ç•¥æ¥åœ¨äºŒæ¬¡å…ƒæ•°æ®é›†ä¸Šç²¾è°ƒæ¨¡å‹ï¼Œè¿™æ ·å¾—åˆ°çš„æ¨¡å‹å°±å¾ˆå¤§ç¨‹åº¦ä¸Šé¿å…SDçš„è¿™ä¸ªé—®é¢˜ï¼Œç›®å‰å¤§éƒ¨åˆ†å¼€æºçš„åŸºäºSDçš„ç²¾è°ƒæ¨¡å‹å¾€å¾€éƒ½é‡‡ç”¨ç±»ä¼¼çš„å¤šå°ºåº¦ç­–ç•¥æ¥ç²¾è°ƒã€‚æ¯”å¦‚æˆ‘ä»¬é‡‡ç”¨å¼€æºçš„<a href="https://link.zhihu.com/?target=https%3A//huggingface.co/dreamlike-art/dreamlike-diffusion-1.0">dreamlike-diffusion-1.0</a>æ¨¡å‹ï¼ˆåŸºäºSD v1.5ç²¾è°ƒçš„ï¼‰ï¼Œå…¶ç”Ÿæˆçš„å›¾åƒæ•ˆæœåœ¨å˜å°ºå¯¸ä¸Šå°±å¥½å¾ˆå¤šï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic3.zhimg.com/80/v2-89b25d80d68f3e818beaa1c909a1b026_1440w.webp" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.zhimg.com/80/v2-f571223e3f3022460808f6ba072a0934_1440w.webp" alt=""></p>
<p>å¦å¤–ä¸€ä¸ªå‚æ•°æ˜¯<code>num_inference_steps</code>ï¼Œå®ƒæ˜¯æŒ‡<strong>æ¨ç†è¿‡ç¨‹ä¸­çš„å»å™ªæ­¥æ•°æˆ–è€…é‡‡æ ·æ­¥æ•°</strong>ã€‚SDåœ¨è®­ç»ƒè¿‡ç¨‹é‡‡ç”¨çš„æ˜¯æ­¥æ•°ä¸º1000çš„noise schedulerï¼Œä½†æ˜¯åœ¨æ¨ç†æ—¶å¾€å¾€é‡‡ç”¨é€Ÿåº¦æ›´å¿«çš„schedulerï¼šåªéœ€è¦å°‘é‡çš„é‡‡æ ·æ­¥æ•°å°±èƒ½ç”Ÿæˆä¸é”™çš„å›¾åƒï¼Œæ¯”å¦‚SDé»˜è®¤é‡‡ç”¨<a href="https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2202.09778">PNDM scheduler</a>ï¼Œå®ƒåªéœ€è¦é‡‡æ ·50æ­¥å°±å¯ä»¥å‡ºå›¾ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æ¢ç”¨å…¶å®ƒç±»å‹çš„schedulerï¼Œæ¯”å¦‚<a href="https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2010.02502">DDIM scheduler</a>å’Œ<a href="https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2206.00927">DPM-Solver scheduler</a>ã€‚æˆ‘ä»¬å¯ä»¥åœ¨diffusersä¸­ç›´æ¥æ›¿æ¢schedulerï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³ä½¿ç”¨DDIMï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> diffusers <span class="keyword">import</span> DDIMScheduler</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ³¨æ„è¿™é‡Œçš„clip_sampleè¦å…³é—­ï¼Œå¦åˆ™ç”Ÿæˆå›¾åƒå­˜åœ¨é—®é¢˜ï¼Œå› ä¸ºä¸èƒ½å¯¹latentè¿›è¡Œclip</span></span><br><span class="line">pipe.scheduler = DDIMScheduler.from_config(pipe.scheduler.config, clip_sample=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<p>æ¢æˆDDIMåï¼ŒåŒæ ·çš„é‡‡æ ·æ­¥æ•°ç”Ÿæˆçš„å›¾åƒå¦‚ä¸‹æ‰€ç¤ºï¼Œåœ¨éƒ¨åˆ†ç»†èŠ‚ä¸Šå’ŒPNDMæœ‰å·®å¼‚ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic3.zhimg.com/80/v2-88ed3ce8a9b3847c8ac90e89faee5e5a_1440w.webp" alt=""></p>
<p>å½“ç„¶<strong>é‡‡æ ·æ­¥æ•°è¶Šå¤§ï¼Œç”Ÿæˆçš„å›¾åƒè´¨é‡è¶Šå¥½ï¼Œä½†æ˜¯ç›¸åº”çš„æ¨ç†æ—¶é—´ä¹Ÿæ›´ä¹…</strong>ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥è¯•éªŒä¸€ä¸‹ä¸åŒé‡‡æ ·æ­¥æ•°ä¸‹çš„ç”Ÿæˆæ•ˆæœï¼Œä»¥å®‡èˆªå‘˜éª‘é©¬ä¸ºä¾‹ï¼Œä¸‹å›¾å±•ç¤ºäº†é‡‡æ ·æ­¥æ•°ä¸º10ï¼Œ20ï¼Œ30ï¼Œ50ï¼Œ70å’Œ100æ—¶çš„ç”Ÿæˆå›¾åƒï¼Œå¯ä»¥çœ‹åˆ°é‡‡æ ·æ­¥æ•°å¢åŠ åï¼Œå›¾åƒç”Ÿæˆè´¨é‡æ˜¯æœ‰ä¸€å®šçš„æå‡çš„ï¼Œå½“é‡‡æ ·æ­¥æ•°ä¸º30æ—¶å°±èƒ½ç”Ÿæˆç›¸å¯¹ç¨³å®šçš„å›¾åƒã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic4.zhimg.com/80/v2-ef712b5422e00d7497ec9afb9822359f_1440w.webp" alt=""></p>
<p>æˆ‘ä»¬è¦è®¨è®ºçš„ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯<code>guidance_scale</code>ï¼Œå‰é¢è¯´è¿‡å½“CFGçš„<code>guidance_scale</code>è¶Šå¤§æ—¶ï¼Œç”Ÿæˆçš„å›¾åƒåº”è¯¥ä¼šå’Œè¾“å…¥æ–‡æœ¬æ›´ä¸€è‡´ï¼Œè¿™é‡Œæˆ‘ä»¬åŒæ ·ä»¥å®‡èˆªå‘˜éª‘é©¬ä¸ºä¾‹æ¥æµ‹è¯•ä¸åŒguidance_scaleä¸‹çš„å›¾åƒç”Ÿæˆæ•ˆæœã€‚ä¸‹å›¾ä¸ºguidance_scaleä¸º1ï¼Œ3ï¼Œ5ï¼Œ7ï¼Œ9å’Œ11ä¸‹ç”Ÿæˆçš„å›¾åƒå¯¹æ¯”ï¼Œå¯ä»¥çœ‹åˆ°å½“guidance_scaleè¾ƒä½æ—¶ç”Ÿæˆçš„å›¾åƒæ•ˆæœæ˜¯æ¯”è¾ƒå·®çš„ï¼Œ<strong>å½“guidance_scaleåœ¨7ï½9æ—¶ï¼Œç”Ÿæˆçš„å›¾åƒæ•ˆæœæ˜¯å¯ä»¥çš„</strong>ï¼Œå½“é‡‡ç”¨æ›´å¤§çš„guidance_scaleæ¯”å¦‚11ï¼Œå›¾åƒçš„è‰²å½©è¿‡é¥±å’Œè€Œçœ‹èµ·æ¥ä¸è‡ªç„¶ï¼Œæ‰€ä»¥SD<strong>é»˜è®¤é‡‡ç”¨çš„guidance_scaleä¸º7.5</strong>ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic4.zhimg.com/80/v2-8337dbec38f8c3e7f684cf49ed64cecf_1440w.webp" alt=""></p>
<p>è¿‡å¤§çš„guidance_scaleä¹‹æ‰€ä»¥å‡ºç°é—®é¢˜ï¼Œä¸»è¦æ˜¯ç”±äºè®­ç»ƒå’Œæµ‹è¯•çš„ä¸ä¸€è‡´ï¼Œè¿‡å¤§çš„guidance_scaleä¼šå¯¼è‡´ç”Ÿæˆçš„æ ·æœ¬è¶…å‡ºèŒƒå›´ã€‚è°·æ­Œçš„Imagenè®ºæ–‡æå‡ºä¸€ç§dynamic thresholdingç­–ç•¥æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ‰€è°“çš„dynamic thresholdingæ˜¯ç›¸å¯¹äºåŸæ¥çš„static thresholdingï¼Œstatic thresholdingç­–ç•¥æ˜¯ç›´æ¥å°†ç”Ÿæˆçš„æ ·æœ¬clipåˆ°[-1, 1]èŒƒå›´å†…ï¼ˆImagenæ˜¯åŸºäºpixelçš„æ‰©æ•£æ¨¡å‹ï¼Œè¿™é‡Œæ˜¯å°†å›¾åƒåƒç´ å€¼å½’ä¸€åŒ–åˆ°-1åˆ°1ä¹‹é—´ï¼‰ï¼Œä½†æ˜¯ä¼šåœ¨è¿‡å¤§çš„guidance_scaleæ—¶äº§ç”Ÿå¾ˆå¤šçš„é¥±å«åƒç´ ç‚¹ã€‚è€Œdynamic thresholdingç­–ç•¥æ˜¯å…ˆè®¡ç®—æ ·æœ¬åœ¨æŸä¸ªç™¾åˆ†ä½ä¸‹ï¼ˆæ¯”å¦‚99%ï¼‰çš„åƒç´ ç»å¯¹å€¼ï¼Œç„¶åå¦‚æœå®ƒè¶…è¿‡1æ—¶å°±é‡‡ç”¨æ¥è¿›è¡Œclipï¼Œè¿™æ ·å°±å¯ä»¥å¤§å¤§å‡å°‘è¿‡é¥±å’Œçš„åƒç´ ã€‚ä¸¤ç§ç­–ç•¥çš„å…·ä½“å®ç°ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic2.zhimg.com/80/v2-ab0405eb00a79be6eb953227e565cfcd_1440w.webp" alt=""></p>
<p>dynamic thresholdingç­–ç•¥å¯¹äºImagenæ˜¯æ¯”è¾ƒå…³é”®çš„ï¼Œå®ƒä½¿å¾—Imagenå¯ä»¥é‡‡ç”¨è¾ƒå¤§çš„guidance_scaleæ¥ç”Ÿæˆæ›´è‡ªç„¶çš„å›¾åƒã€‚ä¸‹å›¾ä¸ºä¸¤ç§thresholdingç­–ç•¥ä¸‹ç”Ÿæˆå›¾åƒçš„å¯¹æ¯”ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.zhimg.com/80/v2-942d6e58a310f24136134fc89f6eac0c_1440w.webp" alt=""></p>
<p>è™½ç„¶SDæ˜¯åŸºäºlatentçš„æ‰©æ•£æ¨¡å‹ï¼Œä½†ä¾ç„¶å¯ä»¥é‡‡ç”¨ç±»ä¼¼çš„dynamic thresholdingç­–ç•¥ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å‚è€ƒç›®å‰çš„ä¸€ä¸ªå¼€æºå®ç°ï¼š<a href="https://link.zhihu.com/?target=https%3A//github.com/mcmonkeyprojects/sd-dynamic-thresholding">sd-dynamic-thresholding</a>ï¼Œä½¿ç”¨dynamic thresholdingç­–ç•¥åï¼ŒSDå¯ä»¥åœ¨è¾ƒå¤§çš„guidance_scaleä¸‹ç”Ÿæˆç›¸å¯¹è‡ªç„¶çš„å›¾åƒã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic2.zhimg.com/80/v2-b097ffe7c5bcb131341b9b6a6b3241e9_1440w.webp" alt=""></p>
<p>å¦å¤–ä¸€ä¸ªæ¯”è¾ƒå®¹æ˜“å¿½ç•¥çš„å‚æ•°æ˜¯<code>negative_prompt</code>ï¼Œè¿™ä¸ªå‚æ•°å’ŒCFGæœ‰å…³ï¼Œå‰é¢è¯´è¿‡ï¼ŒSDé‡‡ç”¨äº†CFGæ¥æå‡ç”Ÿæˆå›¾åƒçš„è´¨é‡ã€‚ä½¿ç”¨CFGï¼Œå»å™ªè¿‡ç¨‹çš„å™ªéŸ³é¢„æµ‹ä¸ä»…ä»…ä¾èµ–æ¡ä»¶æ‰©æ•£æ¨¡å‹ï¼Œä¹Ÿä¾èµ–æ— æ¡ä»¶æ‰©æ•£æ¨¡å‹ï¼šÂ Â è¿™é‡Œçš„<code>negative_prompt</code>ä¾¿æ˜¯æ— æ¡ä»¶æ‰©æ•£æ¨¡å‹çš„textè¾“å…¥ï¼Œå‰é¢è¯´è¿‡è®­ç»ƒè¿‡ç¨‹ä¸­æˆ‘ä»¬å°†textç½®ä¸ºç©ºå­—ç¬¦ä¸²æ¥å®ç°æ— æ¡ä»¶æ‰©æ•£æ¨¡å‹ï¼Œæ‰€ä»¥è¿™é‡Œï¼š<code>negative_prompt = None = &quot;&quot;</code>ã€‚ä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬å¯ä»¥<strong>ä½¿ç”¨ä¸ä¸ºç©ºçš„negative_promptæ¥é¿å…æ¨¡å‹ç”Ÿæˆçš„å›¾åƒåŒ…å«ä¸æƒ³è¦çš„ä¸œè¥¿</strong>ï¼Œå› ä¸ºä»ä¸Šè¿°å…¬å¼å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„æ— æ¡ä»¶æ‰©æ•£æ¨¡å‹æ˜¯æˆ‘ä»¬æƒ³è¿œç¦»çš„éƒ¨åˆ†ã€‚ä¸‹é¢æˆ‘ä»¬æ¥ä¸¾å‡ ä¸ªå…·ä½“çš„ä¾‹å­ï¼Œé¦–å…ˆæ¥çœ‹ç”Ÿæˆäººç‰©å›¾åƒçš„ä¸€ä¸ªä¾‹å­ï¼Œè¿™é‡Œçš„è¾“å…¥æ–‡æœ¬ä¸º&quot;a portrait of a beautiful blonde woman&quot;ï¼Œå…¶ç”Ÿæˆçš„å›¾åƒå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.zhimg.com/80/v2-477a9a38dfe2ed22e37d39a8021108ac_1440w.webp" alt=""></p>
<p>å¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„å›¾åƒæ•ˆæœå¹¶ä¸å¥½ï¼Œæ¯”å¦‚å‡ºç°ä¸€äº›è„¸éƒ¨çš„ç•¸å˜ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥è®¾ç½®negative_promptæ¥æå‡ç”Ÿæˆæ•ˆæœï¼Œè¿™é‡Œæˆ‘ä»¬å°†negative_promptè®¾ç½®ä¸º&quot;cropped, lowres, poorly drawn face, out of frame, poorly drawn hands, blurry&quot;ï¼Œè¿™äº›æè¿°éƒ½æ˜¯è´Ÿé¢çš„ã€‚æ”¹å˜negative_promptåï¼Œç”Ÿæˆçš„å›¾åƒæ•ˆæœæœ‰ä¸€ä¸ªæ˜æ˜¾çš„æå‡ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.zhimg.com/80/v2-40c14e5aa7d107dec744d8581904db9c_1440w.webp" alt=""></p>
<p>ç¬¬äºŒä¸ªä¾‹å­æ˜¯ä¸€ä¸ªå»ºç­‘ç‰©ï¼Œè¿™é‡Œçš„è¾“å…¥æ–‡æœ¬ä¸º&quot;A Hyperrealistic photograph of German architectural modern home&quot;ï¼Œé»˜è®¤å›¾åƒç”Ÿæˆæ•ˆæœå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic2.zhimg.com/80/v2-3904adb4555d7461331f9c2f7e600771_1440w.webp" alt=""></p>
<p>è™½ç„¶ç”Ÿæˆçš„å›¾åƒæ•ˆæœä¸é”™ï¼Œä½†æ˜¯å¦‚æœåªæƒ³è¦ä¸€ä¸ªå¹²å‡€çš„å»ºç­‘ç‰©ï¼Œè€Œä¸æƒ³èƒŒæ™¯ä¸­å«æœ‰æ ‘æœ¨å’Œè‰åœ°ç­‰ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®negative promptæ¥è¾¾åˆ°è¿™ç§æ•ˆæœã€‚è¿™é‡Œå°†negative promptè®¾ä¸º&quot;trees, bushes, leaves, greenery&quot;ï¼Œå…¶ç”Ÿæˆçš„å»ºç­‘ç‰©å°±å¹²å‡€äº†å¾ˆå¤šï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic3.zhimg.com/80/v2-9cf023a14899f7b60d3edeb360a45616_1440w.webp" alt=""></p>
<p>å¯ä»¥çœ‹åˆ°åˆç†ä½¿ç”¨negative promptèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å»é™¤ä¸æƒ³è¦çš„ä¸œè¥¿æ¥æå‡å›¾åƒç”Ÿæˆæ•ˆæœã€‚ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¾“å…¥çš„textæˆ–è€…promptæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œ<strong>æ­£å‘æç¤ºè¯</strong>â€ï¼Œè€Œnegative promptç§°ä¹‹ä¸ºâ€œ<strong>åå‘æç¤ºè¯</strong>â€ï¼Œæƒ³è¦ç”Ÿæˆçš„å¥½çš„å›¾åƒï¼Œä¸ä»…è¦é€‰æ‹©å¥½çš„æ­£å‘æç¤ºè¯ï¼Œä¹Ÿéœ€è¦å¥½çš„åå‘æç¤ºè¯ï¼Œè¿™å’Œæ–‡æœ¬ç”Ÿæˆæ¨¡å‹ä¹Ÿæ¯”è¾ƒç±»ä¼¼ï¼šéƒ½éœ€è¦å¥½çš„promptã€‚è¿™é‡Œä¹Ÿä¸¾ä¸€ä¸ªå¯¹æ­£å‘promptä¼˜åŒ–çš„ä¾‹å­ï¼ˆè¿™ä¸ªä¾‹å­æ¥æºäºå¾®è½¯çš„å·¥ä½œ<a href="https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2212.09611">Optimizing Prompts for Text-to-Image Generation</a>ï¼‰ï¼Œè¿™é‡Œçš„åŸå§‹promptä¸º&quot;A rabbit is wearing a space suit&quot;ï¼Œå¯ä»¥çœ‹åˆ°ç›´æ¥ç”Ÿæˆçš„æ•ˆæœå…¶å®æ˜¯ä¸å°½äººæ„çš„ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic2.zhimg.com/80/v2-04235db0adbeb2e5f4edab3ded4d5c75_1440w.webp" alt=""></p>
<p>ä½†æ˜¯å¦‚æœæˆ‘ä»¬å°†promptæ”¹ä¸º&quot;A rabbit is wearing a space suit, digital Art, Greg rutkowski, Trending cinematographic artstation&quot;ï¼Œå…¶ç”Ÿæˆçš„æ•ˆæœå°±å¤§å¤§æå‡ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic3.zhimg.com/80/v2-74b0506d89da4ca89e8be8e0b5bf57a2_1440w.webp" alt=""></p>
<p>è¿™é‡Œæˆ‘ä»¬å…¶å®åªæ˜¯åœ¨åŸæœ‰çš„promptåŸºç¡€åŠ ä¸Šäº†ä¸€äº›æè¿°è¯ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œ<strong>é­”å’’</strong>â€ï¼Œä¸åŒçš„æ¨¡å‹å¯èƒ½ä¼šæœ‰ä¸åŒçš„é­”å’’ã€‚ ä¸Šè¿°æˆ‘ä»¬è®¨è®ºäº†SDçš„æ–‡ç”Ÿå›¾çš„ä¸»è¦å‚æ•°ï¼Œè¿™é‡Œç®€å•æ€»ç»“ä¸€ä¸‹ï¼š</p>
<ul>
<li>SDé»˜è®¤ç”Ÿæˆ512x512å¤§å°çš„å›¾åƒï¼Œä½†å®é™…ä¸Šå¯ä»¥ç”Ÿæˆå…¶å®ƒåˆ†è¾¨ç‡çš„å›¾åƒï¼Œä½†æ˜¯å¯èƒ½ä¼šå‡ºç°ä¸åè°ƒï¼Œå¦‚æœé‡‡ç”¨å¤šå°ºåº¦ç­–ç•¥è®­ç»ƒï¼Œä¼šæ”¹å–„è¿™ç§æƒ…å†µï¼›</li>
<li>é‡‡ç”¨å¿«é€Ÿçš„noise schedulerï¼ŒSDåœ¨å»å™ªæ­¥æ•°ä¸º30ï½50æ­¥æ—¶å°±èƒ½ç”Ÿæˆç¨³å®šçš„å›¾åƒï¼›</li>
<li>SDçš„guidance_scaleè®¾ç½®ä¸º7ï½9æ˜¯æ¯”è¾ƒç¨³å®šçš„ï¼Œè¿‡å°å’Œè¿‡å¤§éƒ½ä¼šå‡ºç°å›¾åƒè´¨é‡ä¸‹é™ï¼Œå®é™…ä½¿ç”¨ä¸­å¯ä»¥æ ¹æ®å…·ä½“æƒ…å†µçµæ´»è°ƒèŠ‚ï¼›</li>
<li>å¯ä»¥ä½¿ç”¨negative promptæ¥å»é™¤ä¸æƒ³è¦çš„ä¸œè¥¿æ¥æ”¹å–„å›¾åƒç”Ÿæˆæ•ˆæœï¼›</li>
<li>å¥½çš„promptå¯¹å›¾åƒç”Ÿæˆæ•ˆæœæ˜¯è‡³å…³é‡è¦çš„ã€‚</li>
</ul>
<p>ä¸Šè¾¹æˆ‘ä»¬ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨SDè¿›è¡Œæ–‡ç”Ÿå›¾ä»¥åŠä¸€äº›ä¸»è¦å‚æ•°ï¼Œåœ¨æœ€åæˆ‘ä»¬ä¹Ÿç»™å‡ºæ–‡ç”Ÿå›¾è¿™ä¸ªpipelineçš„å†…éƒ¨æµç¨‹ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> diffusers <span class="keyword">import</span> AutoencoderKL, UNet2DConditionModel, DDIMScheduler</span><br><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> CLIPTextModel, CLIPTokenizer</span><br><span class="line"><span class="keyword">from</span> tqdm.auto <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">model_id = <span class="string">&quot;runwayml/stable-diffusion-v1-5&quot;</span></span><br><span class="line"><span class="comment"># 1. åŠ è½½autoencoder</span></span><br><span class="line">vae = AutoencoderKL.from_pretrained(model_id, subfolder=<span class="string">&quot;vae&quot;</span>)</span><br><span class="line"><span class="comment"># 2. åŠ è½½tokenizerå’Œtext encoder </span></span><br><span class="line">tokenizer = CLIPTokenizer.from_pretrained(model_id, subfolder=<span class="string">&quot;tokenizer&quot;</span>)</span><br><span class="line">text_encoder = CLIPTextModel.from_pretrained(model_id, subfolder=<span class="string">&quot;text_encoder&quot;</span>)</span><br><span class="line"><span class="comment"># 3. åŠ è½½æ‰©æ•£æ¨¡å‹UNet</span></span><br><span class="line">unet = UNet2DConditionModel.from_pretrained(model_id, subfolder=<span class="string">&quot;unet&quot;</span>)</span><br><span class="line"><span class="comment"># 4. å®šä¹‰noise scheduler</span></span><br><span class="line">noise_scheduler = DDIMScheduler(</span><br><span class="line">    num_train_timesteps=<span class="number">1000</span>,</span><br><span class="line">    beta_start=<span class="number">0.00085</span>,</span><br><span class="line">    beta_end=<span class="number">0.012</span>,</span><br><span class="line">    beta_schedule=<span class="string">&quot;scaled_linear&quot;</span>,</span><br><span class="line">    clip_sample=<span class="literal">False</span>, <span class="comment"># don&#x27;t clip sample, the x0 in stable diffusion not in range [-1, 1]</span></span><br><span class="line">    set_alpha_to_one=<span class="literal">False</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†æ¨¡å‹å¤åˆ¶åˆ°GPUä¸Š</span></span><br><span class="line">device = <span class="string">&quot;cuda&quot;</span></span><br><span class="line">vae.to(device, dtype=torch.float16)</span><br><span class="line">text_encoder.to(device, dtype=torch.float16)</span><br><span class="line">unet = unet.to(device, dtype=torch.float16)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰å‚æ•°</span></span><br><span class="line">prompt = [</span><br><span class="line">    <span class="string">&quot;A dragon fruit wearing karate belt in the snow&quot;</span>,</span><br><span class="line">    <span class="string">&quot;A small cactus wearing a straw hat and neon sunglasses in the Sahara desert&quot;</span>,</span><br><span class="line">    <span class="string">&quot;A photo of a raccoon wearing an astronaut helmet, looking out of the window at night&quot;</span>,</span><br><span class="line">    <span class="string">&quot;A cute otter in a rainbow whirlpool holding shells, watercolor&quot;</span></span><br><span class="line">]</span><br><span class="line">height = <span class="number">512</span></span><br><span class="line">width = <span class="number">512</span></span><br><span class="line">num_inference_steps = <span class="number">50</span></span><br><span class="line">guidance_scale = <span class="number">7.5</span></span><br><span class="line">negative_prompt = <span class="string">&quot;&quot;</span></span><br><span class="line">batch_size = <span class="built_in">len</span>(prompt)</span><br><span class="line"><span class="comment"># éšæœºç§å­</span></span><br><span class="line">generator = torch.Generator(device).manual_seed(<span class="number">2023</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line"> <span class="comment"># è·å–text_embeddings</span></span><br><span class="line"> text_input = tokenizer(prompt, padding=<span class="string">&quot;max_length&quot;</span>, max_length=tokenizer.model_max_length, truncation=<span class="literal">True</span>, return_tensors=<span class="string">&quot;pt&quot;</span>)</span><br><span class="line">    text_embeddings = text_encoder(text_input.input_ids.to(device))[<span class="number">0</span>]</span><br><span class="line"> <span class="comment"># è·å–unconditional text embeddings</span></span><br><span class="line"> max_length = text_input.input_ids.shape[-<span class="number">1</span>]</span><br><span class="line"> uncond_input = tokenizer(</span><br><span class="line">     [negative_prompt] * batch_size, padding=<span class="string">&quot;max_length&quot;</span>, max_length=max_length, return_tensors=<span class="string">&quot;pt&quot;</span></span><br><span class="line"> )</span><br><span class="line">      uncond_embeddings = text_encoder(uncond_input.input_ids.to(device))[<span class="number">0</span>]</span><br><span class="line"> <span class="comment"># æ‹¼æ¥ä¸ºbatchï¼Œæ–¹ä¾¿å¹¶è¡Œè®¡ç®—</span></span><br><span class="line"> text_embeddings = torch.cat([uncond_embeddings, text_embeddings])</span><br><span class="line"></span><br><span class="line"> <span class="comment"># ç”Ÿæˆlatentsçš„åˆå§‹å™ªéŸ³</span></span><br><span class="line"> latents = torch.randn(</span><br><span class="line">     (batch_size, unet.in_channels, height // <span class="number">8</span>, width // <span class="number">8</span>),</span><br><span class="line">     generator=generator, device=device</span><br><span class="line"> )</span><br><span class="line"> latents = latents.to(device, dtype=torch.float16)</span><br><span class="line"></span><br><span class="line"> <span class="comment"># è®¾ç½®é‡‡æ ·æ­¥æ•°</span></span><br><span class="line"> noise_scheduler.set_timesteps(num_inference_steps, device=device)</span><br><span class="line"></span><br><span class="line"> <span class="comment"># scale the initial noise by the standard deviation required by the scheduler</span></span><br><span class="line"> latents = latents * noise_scheduler.init_noise_sigma <span class="comment"># for DDIM, init_noise_sigma = 1.0</span></span><br><span class="line"></span><br><span class="line"> timesteps_tensor = noise_scheduler.timesteps</span><br><span class="line"></span><br><span class="line"> <span class="comment"># Do denoise steps</span></span><br><span class="line"> <span class="keyword">for</span> t <span class="keyword">in</span> tqdm(timesteps_tensor):</span><br><span class="line">     <span class="comment"># è¿™é‡Œlatensæ‰©å±•2ä»½ï¼Œæ˜¯ä¸ºäº†åŒæ—¶è®¡ç®—unconditional prediction</span></span><br><span class="line">     latent_model_input = torch.cat([latents] * <span class="number">2</span>)</span><br><span class="line">     latent_model_input = noise_scheduler.scale_model_input(latent_model_input, t) <span class="comment"># for DDIM, do nothing</span></span><br><span class="line"></span><br><span class="line">     <span class="comment"># ä½¿ç”¨UNeté¢„æµ‹å™ªéŸ³</span></span><br><span class="line">        noise_pred = unet(latent_model_input, t, encoder_hidden_states=text_embeddings).sample</span><br><span class="line"></span><br><span class="line">     <span class="comment"># æ‰§è¡ŒCFG</span></span><br><span class="line">     noise_pred_uncond, noise_pred_text = noise_pred.chunk(<span class="number">2</span>)</span><br><span class="line">     noise_pred = noise_pred_uncond + guidance_scale * (noise_pred_text - noise_pred_uncond)</span><br><span class="line"></span><br><span class="line">     <span class="comment"># è®¡ç®—ä¸Šä¸€æ­¥çš„noisy latentsï¼šx_t -&gt; x_t-1</span></span><br><span class="line">     latents = noise_scheduler.step(noise_pred, t, latents).prev_sample</span><br><span class="line">    </span><br><span class="line"> <span class="comment"># æ³¨æ„è¦å¯¹latentsè¿›è¡Œscale</span></span><br><span class="line"> latents = <span class="number">1</span> / <span class="number">0.18215</span> * latents</span><br><span class="line"> <span class="comment"># ä½¿ç”¨vaeè§£ç å¾—åˆ°å›¾åƒ</span></span><br><span class="line">    image = vae.decode(latents).sample</span><br></pre></td></tr></table></figure>
<h3 id="å›¾ç”Ÿå›¾"><strong>å›¾ç”Ÿå›¾</strong></h3>
<p><strong>å›¾ç”Ÿå›¾ï¼ˆimage2imageï¼‰æ˜¯å¯¹æ–‡ç”Ÿå›¾åŠŸèƒ½çš„ä¸€ä¸ªæ‰©å±•</strong>ï¼Œè¿™ä¸ªåŠŸèƒ½æ¥æºäº<a href="https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2108.01073">SDEdit</a>è¿™ä¸ªå·¥ä½œï¼Œå…¶æ ¸å¿ƒæ€è·¯ä¹Ÿéå¸¸ç®€å•ï¼šç»™å®šä¸€ä¸ªç¬”ç”»çš„è‰²å—å›¾åƒï¼Œå¯ä»¥å…ˆç»™å®ƒåŠ ä¸€å®šçš„é«˜æ–¯å™ªéŸ³ï¼ˆæ‰§è¡Œæ‰©æ•£è¿‡ç¨‹ï¼‰å¾—åˆ°å™ªéŸ³å›¾åƒï¼Œç„¶ååŸºäºæ‰©æ•£æ¨¡å‹å¯¹è¿™ä¸ªå™ªéŸ³å›¾åƒè¿›è¡Œå»å™ªï¼Œå°±å¯ä»¥ç”Ÿæˆæ–°çš„å›¾åƒï¼Œä½†æ˜¯è¿™ä¸ªå›¾åƒåœ¨ç»“æ„å’Œå¸ƒå±€å’Œè¾“å…¥å›¾åƒåŸºæœ¬ä¸€è‡´ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic4.zhimg.com/80/v2-88ea5b0999db0f14b270847ab12610b3_1440w.webp" alt=""></p>
<p>å¯¹äºSDæ¥è¯´ï¼Œå›¾ç”Ÿå›¾çš„æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºï¼Œç›¸æ¯”æ–‡ç”Ÿå›¾æµç¨‹æ¥è¯´ï¼Œè¿™é‡Œçš„åˆå§‹latentä¸å†æ˜¯ä¸€ä¸ªéšæœºå™ªéŸ³ï¼Œè€Œæ˜¯ç”±åˆå§‹å›¾åƒç»è¿‡autoencoderç¼–ç ä¹‹åçš„latentåŠ é«˜æ–¯å™ªéŸ³å¾—åˆ°ï¼Œè¿™é‡Œçš„åŠ å™ªè¿‡ç¨‹å°±æ˜¯æ‰©æ•£è¿‡ç¨‹ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œå»å™ªè¿‡ç¨‹çš„æ­¥æ•°è¦å’ŒåŠ å™ªè¿‡ç¨‹çš„æ­¥æ•°ä¸€è‡´ï¼Œå°±æ˜¯è¯´ä½ åŠ äº†å¤šå°‘å™ªéŸ³ï¼Œå°±åº”è¯¥å»æ‰å¤šå°‘å™ªéŸ³ï¼Œè¿™æ ·æ‰èƒ½ç”Ÿæˆæƒ³è¦çš„æ— å™ªéŸ³å›¾åƒã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic4.zhimg.com/80/v2-1f760753b2577060a67963f6532634cb_1440w.webp" alt=""></p>
<p>åœ¨diffusersä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>StableDiffusionImg2ImgPipeline</code>æ¥å®ç°æ–‡ç”Ÿå›¾ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> diffusers <span class="keyword">import</span> StableDiffusionImg2ImgPipeline</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½å›¾ç”Ÿå›¾pipeline</span></span><br><span class="line">model_id = <span class="string">&quot;runwayml/stable-diffusion-v1-5&quot;</span></span><br><span class="line">pipe = StableDiffusionImg2ImgPipeline.from_pretrained(model_id, torch_dtype=torch.float16).to(<span class="string">&quot;cuda&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å–åˆå§‹å›¾ç‰‡</span></span><br><span class="line">init_image = Image.<span class="built_in">open</span>(<span class="string">&quot;init_image.png&quot;</span>).convert(<span class="string">&quot;RGB&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¨ç†</span></span><br><span class="line">prompt = <span class="string">&quot;A fantasy landscape, trending on artstation&quot;</span></span><br><span class="line">generator = torch.Generator(device=<span class="string">&quot;cuda&quot;</span>).manual_seed(<span class="number">2023</span>)</span><br><span class="line"></span><br><span class="line">image = pipe(</span><br><span class="line">    prompt=prompt,</span><br><span class="line">    image=init_image,</span><br><span class="line">    strength=<span class="number">0.8</span>,</span><br><span class="line">    guidance_scale=<span class="number">7.5</span>,</span><br><span class="line">    generator=generator</span><br><span class="line">).images[<span class="number">0</span>]</span><br><span class="line">image</span><br></pre></td></tr></table></figure>
<p>ç›¸æ¯”æ–‡ç”Ÿå›¾çš„pipelineï¼Œå›¾ç”Ÿå›¾çš„pipelineè¿˜å¤šäº†ä¸€ä¸ªå‚æ•°<code>strength</code>ï¼Œè¿™ä¸ªå‚æ•°ä»‹äº0-1ä¹‹é—´ï¼Œè¡¨ç¤ºå¯¹è¾“å…¥å›¾ç‰‡åŠ å™ªéŸ³çš„ç¨‹åº¦ï¼Œè¿™ä¸ªå€¼è¶Šå¤§åŠ çš„å™ªéŸ³è¶Šå¤šï¼Œå¯¹åŸå§‹å›¾ç‰‡çš„ç ´åä¹Ÿå°±è¶Šå¤§ï¼Œå½“strength=1æ—¶ï¼Œå…¶å®å°±å˜æˆäº†ä¸€ä¸ªéšæœºå™ªéŸ³ï¼Œæ­¤æ—¶å°±ç›¸å½“äºçº¯ç²¹çš„æ–‡ç”Ÿå›¾pipelineäº†ã€‚ä¸‹é¢å±•ç¤ºäº†ä¸€ä¸ªå…·ä½“çš„å®ä¾‹ï¼Œè¿™é‡Œçš„ç¬¬ä¸€å¼ å›¾ä¸ºè¾“å…¥çš„åˆå§‹å›¾ç‰‡ï¼Œå®ƒæ˜¯ä¸€ä¸ªç¬”ç”»çš„è‰²å—ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å›¾ç”Ÿå›¾å°†å®ƒç”Ÿæˆä¸€å¹…å…·ä½“çš„å›¾åƒï¼Œå…¶ä¸­ç¬¬2å¼ å›¾å’Œç¬¬3å¼ å›¾çš„strengthåˆ†åˆ«æ˜¯0.5å’Œ0.8ï¼Œå¯ä»¥çœ‹åˆ°å½“strength=0.5æ—¶ï¼Œç”Ÿæˆçš„å›¾åƒå’ŒåŸå›¾æ¯”è¾ƒä¸€è‡´ï¼Œä½†æ˜¯å°±æ¯”è¾ƒç®€å•äº†ï¼Œå½“strength=0.8æ—¶ï¼Œç”Ÿæˆçš„å›¾åƒåç¦»åŸå›¾æ›´å¤šï¼Œä½†æ˜¯å›¾åƒçš„è´¨æ„Ÿæœ‰ä¸€ä¸ªæ˜æ˜¾çš„æå‡ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic3.zhimg.com/80/v2-4e0affea8868b71ca483fc0a4c324b26_1440w.webp" alt=""></p>
<p>å›¾ç”Ÿå›¾è¿™ä¸ªåŠŸèƒ½ä¸€ä¸ªæ›´å¹¿æ³›çš„åº”ç”¨æ˜¯åœ¨é£æ ¼è½¬æ¢ä¸Šï¼Œæ¯”å¦‚ç»™å®šä¸€å¼ äººåƒï¼Œæƒ³ç”ŸæˆåŠ¨æ¼«é£æ ¼çš„å›¾åƒã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åŠ¨æ¼«é£æ ¼çš„å¼€æºæ¨¡å‹<a href="https://link.zhihu.com/?target=https%3A//huggingface.co/andite/anything-v4.0">anything-v4.0</a>ï¼Œå®ƒæ˜¯åŸºäºSD v1.5åœ¨åŠ¨æ¼«é£æ ¼æ•°æ®é›†ä¸Šfinetuneçš„ï¼Œä½¿ç”¨å®ƒå¯ä»¥æ›´å¥½åœ°åˆ©ç”¨å›¾ç”Ÿå›¾å°†äººç‰©åŠ¨æ¼«åŒ–ã€‚ä¸‹é¢çš„ç¬¬1å¼ ä¸ºè¾“å…¥äººç‰©å›¾åƒï¼Œé‡‡ç”¨çš„promptä¸º&quot;masterpiece, best quality, 1girl, red hair, medium hair, green eyes&quot;ï¼Œåé¢çš„å›¾åƒæ˜¯strengthåˆ†åˆ«ä¸º0.3-0.9ä¸‹ç”Ÿæˆçš„å›¾åƒã€‚å¯ä»¥çœ‹åˆ°åœ¨ä¸åŒçš„strengthä¸‹å›¾åƒæœ‰ä¸åŒçš„ç”Ÿæˆæ•ˆæœï¼Œå…¶ä¸­strength=0.6æ—¶æˆ‘è§‰å¾—æ•ˆæœæ˜¯æœ€å¥½çš„ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.zhimg.com/80/v2-9ff42eb6049882d71ff76c97ce7a8a80_1440w.webp" alt=""></p>
<p>æ€»ç»“æ¥çœ‹ï¼Œ<strong>å›¾ç”Ÿå›¾å…¶å®æ ¸å¿ƒä¹Ÿæ˜¯ä¾èµ–äº†æ–‡ç”Ÿå›¾çš„èƒ½åŠ›ï¼Œå…¶ä¸­strengthè¿™ä¸ªå‚æ•°éœ€è¦çµæ´»è°ƒèŠ‚æ¥å¾—åˆ°æ»¡æ„çš„å›¾åƒ</strong>ã€‚åœ¨æœ€åï¼Œæˆ‘ä»¬ä¹Ÿç»™å‡ºå›¾ç”Ÿå›¾pipelineçš„å†…éƒ¨ä¸»è¦ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> PIL</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> diffusers <span class="keyword">import</span> AutoencoderKL, UNet2DConditionModel, DDIMScheduler</span><br><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> CLIPTextModel, CLIPTokenizer</span><br><span class="line"><span class="keyword">from</span> tqdm.auto <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">model_id = <span class="string">&quot;runwayml/stable-diffusion-v1-5&quot;</span></span><br><span class="line"><span class="comment"># 1. åŠ è½½autoencoder</span></span><br><span class="line">vae = AutoencoderKL.from_pretrained(model_id, subfolder=<span class="string">&quot;vae&quot;</span>)</span><br><span class="line"><span class="comment"># 2. åŠ è½½tokenizerå’Œtext encoder </span></span><br><span class="line">tokenizer = CLIPTokenizer.from_pretrained(model_id, subfolder=<span class="string">&quot;tokenizer&quot;</span>)</span><br><span class="line">text_encoder = CLIPTextModel.from_pretrained(model_id, subfolder=<span class="string">&quot;text_encoder&quot;</span>)</span><br><span class="line"><span class="comment"># 3. åŠ è½½æ‰©æ•£æ¨¡å‹UNet</span></span><br><span class="line">unet = UNet2DConditionModel.from_pretrained(model_id, subfolder=<span class="string">&quot;unet&quot;</span>)</span><br><span class="line"><span class="comment"># 4. å®šä¹‰noise scheduler</span></span><br><span class="line">noise_scheduler = DDIMScheduler(</span><br><span class="line">    num_train_timesteps=<span class="number">1000</span>,</span><br><span class="line">    beta_start=<span class="number">0.00085</span>,</span><br><span class="line">    beta_end=<span class="number">0.012</span>,</span><br><span class="line">    beta_schedule=<span class="string">&quot;scaled_linear&quot;</span>,</span><br><span class="line">    clip_sample=<span class="literal">False</span>, <span class="comment"># don&#x27;t clip sample, the x0 in stable diffusion not in range [-1, 1]</span></span><br><span class="line">    set_alpha_to_one=<span class="literal">False</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†æ¨¡å‹å¤åˆ¶åˆ°GPUä¸Š</span></span><br><span class="line">device = <span class="string">&quot;cuda&quot;</span></span><br><span class="line">vae.to(device, dtype=torch.float16)</span><br><span class="line">text_encoder.to(device, dtype=torch.float16)</span><br><span class="line">unet = unet.to(device, dtype=torch.float16)</span><br><span class="line"></span><br><span class="line"><span class="comment"># é¢„å¤„ç†init_image</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">preprocess</span>(<span class="params">image</span>):</span><br><span class="line">    w, h = image.size</span><br><span class="line">    w, h = <span class="built_in">map</span>(<span class="keyword">lambda</span> x: x - x % <span class="number">32</span>, (w, h))  <span class="comment"># resize to integer multiple of 32</span></span><br><span class="line">    image = image.resize((w, h), resample=PIL.Image.LANCZOS)</span><br><span class="line">    image = np.array(image).astype(np.float32) / <span class="number">255.0</span></span><br><span class="line">    image = image[<span class="literal">None</span>].transpose(<span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">    image = torch.from_numpy(image)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2.0</span> * image - <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å‚æ•°è®¾ç½®</span></span><br><span class="line">prompt = [<span class="string">&quot;A fantasy landscape, trending on artstation&quot;</span>]</span><br><span class="line">num_inference_steps = <span class="number">50</span></span><br><span class="line">guidance_scale = <span class="number">7.5</span></span><br><span class="line">strength = <span class="number">0.8</span></span><br><span class="line">batch_size = <span class="number">1</span></span><br><span class="line">negative_prompt = <span class="string">&quot;&quot;</span></span><br><span class="line">generator = torch.Generator(device).manual_seed(<span class="number">2023</span>)</span><br><span class="line"></span><br><span class="line">init_image = PIL.Image.<span class="built_in">open</span>(<span class="string">&quot;init_image.png&quot;</span>).convert(<span class="string">&quot;RGB&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line"> <span class="comment"># è·å–promptçš„text_embeddings</span></span><br><span class="line"> text_input = tokenizer(prompt, padding=<span class="string">&quot;max_length&quot;</span>, max_length=tokenizer.model_max_length, truncation=<span class="literal">True</span>, return_tensors=<span class="string">&quot;pt&quot;</span>)</span><br><span class="line">    text_embeddings = text_encoder(text_input.input_ids.to(device))[<span class="number">0</span>]</span><br><span class="line"> <span class="comment"># è·å–unconditional text embeddings</span></span><br><span class="line"> max_length = text_input.input_ids.shape[-<span class="number">1</span>]</span><br><span class="line"> uncond_input = tokenizer(</span><br><span class="line">     [negative_prompt] * batch_size, padding=<span class="string">&quot;max_length&quot;</span>, max_length=max_length, return_tensors=<span class="string">&quot;pt&quot;</span></span><br><span class="line"> )</span><br><span class="line">      uncond_embeddings = text_encoder(uncond_input.input_ids.to(device))[<span class="number">0</span>]</span><br><span class="line"> <span class="comment"># æ‹¼æ¥batch</span></span><br><span class="line"> text_embeddings = torch.cat([uncond_embeddings, text_embeddings])</span><br><span class="line"></span><br><span class="line"> <span class="comment"># è®¾ç½®é‡‡æ ·æ­¥æ•°</span></span><br><span class="line"> noise_scheduler.set_timesteps(num_inference_steps, device=device)</span><br><span class="line"> <span class="comment"># æ ¹æ®strengthè®¡ç®—timesteps</span></span><br><span class="line"> init_timestep = <span class="built_in">min</span>(<span class="built_in">int</span>(num_inference_steps * strength), num_inference_steps)</span><br><span class="line"> t_start = <span class="built_in">max</span>(num_inference_steps - init_timestep, <span class="number">0</span>)</span><br><span class="line"> timesteps = noise_scheduler.timesteps[t_start:]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment"># é¢„å¤„ç†init_image</span></span><br><span class="line"> init_input = preprocess(init_image)</span><br><span class="line">    init_latents = vae.encode(init_input.to(device, dtype=torch.float16)).latent_dist.sample(generator)</span><br><span class="line">    init_latents = <span class="number">0.18215</span> * init_latents</span><br><span class="line"></span><br><span class="line"> <span class="comment"># ç»™init_latentsåŠ å™ªéŸ³</span></span><br><span class="line"> noise = torch.randn(init_latents.shape, generator=generator, device=device, dtype=init_latents.dtype)</span><br><span class="line"> init_latents = noise_scheduler.add_noise(init_latents, noise, timesteps[:<span class="number">1</span>])</span><br><span class="line"> latents = init_latents <span class="comment"># ä½œä¸ºåˆå§‹latents</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment"># Do denoise steps</span></span><br><span class="line"> <span class="keyword">for</span> t <span class="keyword">in</span> tqdm(timesteps):</span><br><span class="line">     <span class="comment"># è¿™é‡Œlatensæ‰©å±•2ä»½ï¼Œæ˜¯ä¸ºäº†åŒæ—¶è®¡ç®—unconditional prediction</span></span><br><span class="line">     latent_model_input = torch.cat([latents] * <span class="number">2</span>)</span><br><span class="line">     latent_model_input = noise_scheduler.scale_model_input(latent_model_input, t) <span class="comment"># for DDIM, do nothing</span></span><br><span class="line"></span><br><span class="line">     <span class="comment"># é¢„æµ‹å™ªéŸ³</span></span><br><span class="line">        noise_pred = unet(latent_model_input, t, encoder_hidden_states=text_embeddings).sample</span><br><span class="line"></span><br><span class="line">     <span class="comment"># CFG</span></span><br><span class="line">     noise_pred_uncond, noise_pred_text = noise_pred.chunk(<span class="number">2</span>)</span><br><span class="line">     noise_pred = noise_pred_uncond + guidance_scale * (noise_pred_text - noise_pred_uncond)</span><br><span class="line"></span><br><span class="line">     <span class="comment"># è®¡ç®—ä¸Šä¸€æ­¥çš„noisy latentsï¼šx_t -&gt; x_t-1</span></span><br><span class="line">     latents = noise_scheduler.step(noise_pred, t, latents).prev_sample</span><br><span class="line">    </span><br><span class="line"> <span class="comment"># æ³¨æ„è¦å¯¹latentsè¿›è¡Œscale</span></span><br><span class="line"> latents = <span class="number">1</span> / <span class="number">0.18215</span> * latents</span><br><span class="line">    <span class="comment"># è§£ç </span></span><br><span class="line">    image = vae.decode(latents).sample</span><br></pre></td></tr></table></figure>
<h3 id="å›¾åƒinpainting"><strong>å›¾åƒinpainting</strong></h3>
<p>æœ€åæˆ‘ä»¬è¦ä»‹ç»çš„ä¸€é¡¹åŠŸèƒ½æ˜¯å›¾åƒinpaintingï¼Œå®ƒå’Œå›¾ç”Ÿå›¾ä¸€æ ·ä¹Ÿæ˜¯æ–‡ç”Ÿå›¾åŠŸèƒ½çš„ä¸€ä¸ªæ‰©å±•ã€‚SDçš„å›¾åƒinpaintingä¸æ˜¯ç”¨åœ¨å›¾åƒä¿®å¤ä¸Šï¼Œè€Œæ˜¯ä¸»è¦ç”¨åœ¨<strong>å›¾åƒç¼–è¾‘</strong>ä¸Šï¼šç»™å®šä¸€ä¸ªè¾“å…¥å›¾åƒå’Œæƒ³è¦ç¼–è¾‘çš„åŒºåŸŸmaskï¼Œæˆ‘ä»¬æƒ³é€šè¿‡æ–‡ç”Ÿå›¾æ¥ç¼–è¾‘maskåŒºåŸŸçš„å†…å®¹ã€‚SDçš„å›¾åƒinpaintingåŸç†å¯ä»¥å‚è€ƒè®ºæ–‡<a href="https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2206.02779">Blended Latent Diffusion</a>ï¼Œå…¶ä¸»è¦åŸç†å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic4.zhimg.com/80/v2-927c1583cfcb13dfab39f9fcda1ab96b_1440w.webp" alt=""></p>
<p>å®ƒå’Œå›¾ç”Ÿå›¾ä¸€æ ·ï¼šé¦–å…ˆå°†è¾“å…¥å›¾åƒé€šè¿‡autoencoderç¼–ç ä¸ºlatentï¼Œç„¶ååŠ å…¥ä¸€å®šçš„é«˜æ–¯å™ªéŸ³ç”Ÿæˆnoisy latentï¼Œå†è¿›è¡Œå»å™ªç”Ÿæˆå›¾åƒï¼Œä½†æ˜¯è¿™é‡Œä¸ºäº†ä¿è¯maskä»¥å¤–çš„åŒºåŸŸä¸å‘ç”Ÿå˜åŒ–ï¼Œåœ¨å»å™ªè¿‡ç¨‹çš„æ¯ä¸€æ­¥ï¼Œéƒ½å°†æ‰©æ•£æ¨¡å‹é¢„æµ‹çš„noisy latentç”¨çœŸå®å›¾åƒåŒlevelçš„nosiy latentæ›¿æ¢ã€‚ åœ¨diffusersä¸­ï¼Œä½¿ç”¨<code>StableDiffusionInpaintPipelineLegacy</code>å¯ä»¥å®ç°æ–‡æœ¬å¼•å¯¼ä¸‹çš„å›¾åƒinpaintingï¼Œå…·ä½“ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> diffusers <span class="keyword">import</span> StableDiffusionInpaintPipelineLegacy</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŠ è½½inpainting pipeline</span></span><br><span class="line">model_id = <span class="string">&quot;runwayml/stable-diffusion-v1-5&quot;</span></span><br><span class="line">pipe = StableDiffusionInpaintPipelineLegacy.from_pretrained(model_id, torch_dtype=torch.float16).to(<span class="string">&quot;cuda&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯»å–è¾“å…¥å›¾åƒå’Œè¾“å…¥mask</span></span><br><span class="line">input_image = Image.<span class="built_in">open</span>(<span class="string">&quot;overture-creations-5sI6fQgYIuo.png&quot;</span>).resize((<span class="number">512</span>, <span class="number">512</span>))</span><br><span class="line">input_mask = Image.<span class="built_in">open</span>(<span class="string">&quot;overture-creations-5sI6fQgYIuo_mask.png&quot;</span>).resize((<span class="number">512</span>, <span class="number">512</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰§è¡Œæ¨ç†</span></span><br><span class="line">prompt = [<span class="string">&quot;a mecha robot sitting on a bench&quot;</span>, <span class="string">&quot;a cat sitting on a bench&quot;</span>]</span><br><span class="line">generator = torch.Generator(<span class="string">&quot;cuda&quot;</span>).manual_seed(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> torch.autocast(<span class="string">&quot;cuda&quot;</span>):</span><br><span class="line">    images = pipe(</span><br><span class="line">        prompt=prompt,</span><br><span class="line">        image=input_image,</span><br><span class="line">        mask_image=input_mask,</span><br><span class="line">        num_inference_steps=<span class="number">50</span>,</span><br><span class="line">        strength=<span class="number">0.75</span>,</span><br><span class="line">        guidance_scale=<span class="number">7.5</span>,</span><br><span class="line">        num_images_per_prompt=<span class="number">1</span>,</span><br><span class="line">        generator=generator,</span><br><span class="line">    ).images</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªå…·ä½“çš„ç”Ÿæˆæ•ˆæœï¼Œè¿™é‡Œæˆ‘ä»¬å°†è¾“å…¥å›¾åƒçš„dogæ¢æˆäº†mecha robotæˆ–è€…catï¼Œä»è€Œå®ç°äº†å›¾åƒç¼–è¾‘ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.zhimg.com/80/v2-d46397655ae48aa691ec55b4c8e8ba98_1440w.webp" alt=""></p>
<p>è¦æ³¨æ„çš„æ˜¯è¿™é‡Œçš„å‚æ•°guidance_scaleä¹Ÿå’Œå›¾ç”Ÿå›¾ä¸€æ ·æ¯”è¾ƒé‡è¦ï¼Œè¦ç”Ÿæˆå¥½çš„å›¾åƒï¼Œéœ€è¦é€‰æ‹©åˆé€‚çš„guidance_scaleã€‚å¦‚æœguidance_scale=0.5æ—¶ï¼Œç”Ÿæˆçš„å›¾åƒç”±äºè¿‡äºå—åˆ°åŸå›¾å¹²æ‰°è€Œäº§ç”Ÿä¸€äº›ä¸åè°ƒï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic3.zhimg.com/80/v2-ec7dc58bc0ea6fe71e68559eda72acae_1440w.webp" alt=""></p>
<p>åˆé€‚çš„promptä¹Ÿæ¯”è¾ƒé‡è¦ï¼Œæ¯”å¦‚å¦‚æœæˆ‘ä»¬å»æ‰promptä¸­çš„&quot;sitting on a bench&quot;ï¼Œé‚£ä¹ˆç¼–è¾‘çš„å›¾åƒæ•ˆæœä¹Ÿä¼šå‡ºç°ä¸åè°ƒï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.zhimg.com/80/v2-6e559a47524be82c50c5f00b502bc204_1440w.webp" alt=""></p>
<p>æ— è®ºæ˜¯ä¸Šé¢çš„å›¾ç”Ÿå›¾è¿˜æ˜¯è¿™é‡Œçš„å›¾åƒinpaintingï¼Œæˆ‘ä»¬å…¶å®å¹¶æ²¡æœ‰å»finetune SDæ¨¡å‹ï¼Œåªæ˜¯æ‰©å±•äº†å®ƒçš„èƒ½åŠ›ï¼Œä½†æ˜¯è¿™ä¸¤æ ·åŠŸèƒ½å°±éœ€è¦ç²¾ç¡®è°ƒæ•´å‚æ•°æ‰èƒ½å¾—åˆ°æ»¡æ„çš„ç”Ÿæˆæ•ˆæœã€‚ è¿™é‡Œï¼Œæˆ‘ä»¬ä¹Ÿç»™å‡º<code>StableDiffusionInpaintPipelineLegacy</code>è¿™ä¸ªpipelineå†…éƒ¨çš„æ ¸å¿ƒä»£ç ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> PIL</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> diffusers <span class="keyword">import</span> AutoencoderKL, UNet2DConditionModel, DDIMScheduler</span><br><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> CLIPTextModel, CLIPTokenizer</span><br><span class="line"><span class="keyword">from</span> tqdm.auto <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">preprocess_mask</span>(<span class="params">mask</span>):</span><br><span class="line">    mask = mask.convert(<span class="string">&quot;L&quot;</span>)</span><br><span class="line">    w, h = mask.size</span><br><span class="line">    w, h = <span class="built_in">map</span>(<span class="keyword">lambda</span> x: x - x % <span class="number">32</span>, (w, h))  <span class="comment"># resize to integer multiple of 32</span></span><br><span class="line">    mask = mask.resize((w // <span class="number">8</span>, h // <span class="number">8</span>), resample=PIL.Image.NEAREST)</span><br><span class="line">    mask = np.array(mask).astype(np.float32) / <span class="number">255.0</span></span><br><span class="line">    mask = np.tile(mask, (<span class="number">4</span>, <span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">    mask = mask[<span class="literal">None</span>].transpose(<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)  <span class="comment"># what does this step do?</span></span><br><span class="line">    mask = <span class="number">1</span> - mask  <span class="comment"># repaint white, keep black</span></span><br><span class="line">    mask = torch.from_numpy(mask)</span><br><span class="line">    <span class="keyword">return</span> mask</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">preprocess</span>(<span class="params">image</span>):</span><br><span class="line">    w, h = image.size</span><br><span class="line">    w, h = <span class="built_in">map</span>(<span class="keyword">lambda</span> x: x - x % <span class="number">32</span>, (w, h))  <span class="comment"># resize to integer multiple of 32</span></span><br><span class="line">    image = image.resize((w, h), resample=PIL.Image.LANCZOS)</span><br><span class="line">    image = np.array(image).astype(np.float32) / <span class="number">255.0</span></span><br><span class="line">    image = image[<span class="literal">None</span>].transpose(<span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">    image = torch.from_numpy(image)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2.0</span> * image - <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">model_id = <span class="string">&quot;runwayml/stable-diffusion-v1-5&quot;</span></span><br><span class="line"><span class="comment"># 1. åŠ è½½autoencoder</span></span><br><span class="line">vae = AutoencoderKL.from_pretrained(model_id, subfolder=<span class="string">&quot;vae&quot;</span>)</span><br><span class="line"><span class="comment"># 2. åŠ è½½tokenizerå’Œtext encoder </span></span><br><span class="line">tokenizer = CLIPTokenizer.from_pretrained(model_id, subfolder=<span class="string">&quot;tokenizer&quot;</span>)</span><br><span class="line">text_encoder = CLIPTextModel.from_pretrained(model_id, subfolder=<span class="string">&quot;text_encoder&quot;</span>)</span><br><span class="line"><span class="comment"># 3. åŠ è½½æ‰©æ•£æ¨¡å‹UNet</span></span><br><span class="line">unet = UNet2DConditionModel.from_pretrained(model_id, subfolder=<span class="string">&quot;unet&quot;</span>)</span><br><span class="line"><span class="comment"># 4. å®šä¹‰noise scheduler</span></span><br><span class="line">noise_scheduler = DDIMScheduler(</span><br><span class="line">    num_train_timesteps=<span class="number">1000</span>,</span><br><span class="line">    beta_start=<span class="number">0.00085</span>,</span><br><span class="line">    beta_end=<span class="number">0.012</span>,</span><br><span class="line">    beta_schedule=<span class="string">&quot;scaled_linear&quot;</span>,</span><br><span class="line">    clip_sample=<span class="literal">False</span>, <span class="comment"># don&#x27;t clip sample, the x0 in stable diffusion not in range [-1, 1]</span></span><br><span class="line">    set_alpha_to_one=<span class="literal">False</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†æ¨¡å‹å¤åˆ¶åˆ°GPUä¸Š</span></span><br><span class="line">device = <span class="string">&quot;cuda&quot;</span></span><br><span class="line">vae.to(device, dtype=torch.float16)</span><br><span class="line">text_encoder.to(device, dtype=torch.float16)</span><br><span class="line">unet = unet.to(device, dtype=torch.float16)</span><br><span class="line"></span><br><span class="line">prompt = <span class="string">&quot;a mecha robot sitting on a bench&quot;</span></span><br><span class="line">strength = <span class="number">0.75</span></span><br><span class="line">guidance_scale = <span class="number">7.5</span></span><br><span class="line">batch_size = <span class="number">1</span></span><br><span class="line">num_inference_steps = <span class="number">50</span></span><br><span class="line">negative_prompt = <span class="string">&quot;&quot;</span></span><br><span class="line">generator = torch.Generator(device).manual_seed(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> torch.no_grad():</span><br><span class="line">    <span class="comment"># è·å–promptçš„text_embeddings</span></span><br><span class="line">    text_input = tokenizer(prompt, padding=<span class="string">&quot;max_length&quot;</span>, max_length=tokenizer.model_max_length, truncation=<span class="literal">True</span>, return_tensors=<span class="string">&quot;pt&quot;</span>)</span><br><span class="line">    text_embeddings = text_encoder(text_input.input_ids.to(device))[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># è·å–unconditional text embeddings</span></span><br><span class="line">    max_length = text_input.input_ids.shape[-<span class="number">1</span>]</span><br><span class="line">    uncond_input = tokenizer(</span><br><span class="line">        [negative_prompt] * batch_size, padding=<span class="string">&quot;max_length&quot;</span>, max_length=max_length, return_tensors=<span class="string">&quot;pt&quot;</span></span><br><span class="line">    )</span><br><span class="line">    uncond_embeddings = text_encoder(uncond_input.input_ids.to(device))[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># æ‹¼æ¥batch</span></span><br><span class="line">    text_embeddings = torch.cat([uncond_embeddings, text_embeddings])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®é‡‡æ ·æ­¥æ•°</span></span><br><span class="line">    noise_scheduler.set_timesteps(num_inference_steps, device=device)</span><br><span class="line">    <span class="comment"># æ ¹æ®strengthè®¡ç®—timesteps</span></span><br><span class="line">    init_timestep = <span class="built_in">min</span>(<span class="built_in">int</span>(num_inference_steps * strength), num_inference_steps)</span><br><span class="line">    t_start = <span class="built_in">max</span>(num_inference_steps - init_timestep, <span class="number">0</span>)</span><br><span class="line">    timesteps = noise_scheduler.timesteps[t_start:]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># é¢„å¤„ç†init_image</span></span><br><span class="line">    init_input = preprocess(input_image)</span><br><span class="line">    init_latents = vae.encode(init_input.to(device, dtype=torch.float16)).latent_dist.sample(generator)</span><br><span class="line">    init_latents = <span class="number">0.18215</span> * init_latents</span><br><span class="line">    init_latents = torch.cat([init_latents] * batch_size, dim=<span class="number">0</span>)</span><br><span class="line">    init_latents_orig = init_latents</span><br><span class="line">    <span class="comment"># å¤„ç†mask</span></span><br><span class="line">    mask_image = preprocess_mask(input_mask)</span><br><span class="line">    mask_image = mask_image.to(device=device, dtype=init_latents.dtype)</span><br><span class="line">    mask = torch.cat([mask_image] * batch_size)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ç»™init_latentsåŠ å™ªéŸ³</span></span><br><span class="line">    noise = torch.randn(init_latents.shape, generator=generator, device=device, dtype=init_latents.dtype)</span><br><span class="line">    init_latents = noise_scheduler.add_noise(init_latents, noise, timesteps[:<span class="number">1</span>])</span><br><span class="line">    latents = init_latents <span class="comment"># ä½œä¸ºåˆå§‹latents</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Do denoise steps</span></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> tqdm(timesteps):</span><br><span class="line">        <span class="comment"># è¿™é‡Œlatensæ‰©å±•2ä»½ï¼Œæ˜¯ä¸ºäº†åŒæ—¶è®¡ç®—unconditional prediction</span></span><br><span class="line">        latent_model_input = torch.cat([latents] * <span class="number">2</span>)</span><br><span class="line">        latent_model_input = noise_scheduler.scale_model_input(latent_model_input, t) <span class="comment"># for DDIM, do nothing</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># é¢„æµ‹å™ªéŸ³</span></span><br><span class="line">        noise_pred = unet(latent_model_input, t, encoder_hidden_states=text_embeddings).sample</span><br><span class="line"></span><br><span class="line">        <span class="comment"># CFG</span></span><br><span class="line">        noise_pred_uncond, noise_pred_text = noise_pred.chunk(<span class="number">2</span>)</span><br><span class="line">        noise_pred = noise_pred_uncond + guidance_scale * (noise_pred_text - noise_pred_uncond)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è®¡ç®—ä¸Šä¸€æ­¥çš„noisy latentsï¼šx_t -&gt; x_t-1</span></span><br><span class="line">        latents = noise_scheduler.step(noise_pred, t, latents).prev_sample</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># å°†unmaskåŒºåŸŸæ›¿æ¢åŸå§‹å›¾åƒçš„nosiy latents</span></span><br><span class="line">        init_latents_proper = noise_scheduler.add_noise(init_latents_orig, noise, torch.tensor([t]))</span><br><span class="line">        latents = (init_latents_proper * mask) + (latents * (<span class="number">1</span> - mask))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ³¨æ„è¦å¯¹latentsè¿›è¡Œscale</span></span><br><span class="line">    latents = <span class="number">1</span> / <span class="number">0.18215</span> * latents</span><br><span class="line">    image = vae.decode(latents).sample</span><br></pre></td></tr></table></figure>
<p>å¦å¤–ï¼Œrunwaymlåœ¨å‘å¸ƒSD 1.5ç‰ˆæœ¬çš„åŒæ—¶è¿˜å‘å¸ƒäº†ä¸€ä¸ªinpaintingæ¨¡å‹ï¼š<a href="https://link.zhihu.com/?target=https%3A//huggingface.co/runwayml/stable-diffusion-inpainting">runwayml/stable-diffusion-inpainting</a>ï¼Œä¸å‰é¢æ‰€è®²ä¸åŒçš„æ˜¯ï¼Œè¿™æ˜¯ä¸€ä¸ª<strong>åœ¨SD 1.2ä¸Šfinetuneçš„æ¨¡å‹</strong>ã€‚åŸæ¥SDçš„UNetçš„è¾“å…¥æ˜¯64x64x4ï¼Œä¸ºäº†å®ç°inpaintingï¼Œç°åœ¨ç»™UNetçš„ç¬¬ä¸€ä¸ªå·æœºå±‚å¢åŠ 5ä¸ªchannelsï¼Œåˆ†åˆ«ä¸ºmaskedå›¾åƒçš„latentsï¼ˆç»è¿‡autoencoderç¼–ç ï¼Œ64x64x4ï¼‰å’Œmaskå›¾åƒï¼ˆç›´æ¥ä¸‹é‡‡æ ·8xï¼Œ64x64x1ï¼‰ï¼Œå¢åŠ çš„æƒé‡å¡«é›¶åˆå§‹åŒ–ã€‚åœ¨diffusersä¸­ï¼Œå¯ä»¥ä½¿ç”¨<code>StableDiffusionInpaintPipeline</code>æ¥è°ƒç”¨è¿™ä¸ªæ¨¡å‹ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> diffusers <span class="keyword">import</span> StableDiffusionInpaintPipeline</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> tqdm.auto <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">import</span> PIL</span><br><span class="line"></span><br><span class="line"><span class="comment"># Load pipeline</span></span><br><span class="line">model_id = <span class="string">&quot;runwayml/stable-diffusion-inpainting/&quot;</span></span><br><span class="line">pipe = StableDiffusionInpaintPipeline.from_pretrained(model_id, torch_dtype=torch.float16).to(<span class="string">&quot;cuda&quot;</span>)</span><br><span class="line"></span><br><span class="line">prompt = [<span class="string">&quot;a mecha robot sitting on a bench&quot;</span>, <span class="string">&quot;a dog sitting on a bench&quot;</span>, <span class="string">&quot;a bench&quot;</span>]</span><br><span class="line"></span><br><span class="line">generator = torch.Generator(<span class="string">&quot;cuda&quot;</span>).manual_seed(<span class="number">2023</span>)</span><br><span class="line"></span><br><span class="line">input_image = Image.<span class="built_in">open</span>(<span class="string">&quot;overture-creations-5sI6fQgYIuo.png&quot;</span>).resize((<span class="number">512</span>, <span class="number">512</span>))</span><br><span class="line">input_mask = Image.<span class="built_in">open</span>(<span class="string">&quot;overture-creations-5sI6fQgYIuo_mask.png&quot;</span>).resize((<span class="number">512</span>, <span class="number">512</span>))</span><br><span class="line"></span><br><span class="line">images = pipe(</span><br><span class="line">    prompt=prompt,</span><br><span class="line">    image=input_image,</span><br><span class="line">    mask_image=input_mask,</span><br><span class="line">    num_inference_steps=<span class="number">50</span>,</span><br><span class="line">    generator=generator,</span><br><span class="line">    ).images</span><br></pre></td></tr></table></figure>
<p>å…¶ç”Ÿæˆçš„æ•ˆæœå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic4.zhimg.com/80/v2-71940530603f265d2f2597cf8570ef97_1440w.webp" alt=""></p>
<p>ç»è¿‡finetuneçš„inpaintingåœ¨ç”Ÿæˆç»†èŠ‚ä¸Šå¯èƒ½ä¼šæ›´å¥½ï¼Œä½†æ˜¯æœ‰å¯èƒ½ä¼šä¸§å¤±éƒ¨åˆ†æ–‡ç”Ÿå›¾çš„èƒ½åŠ›ï¼Œè€Œä¸”ä¹Ÿæ¯”è¾ƒéš¾è¿ç§»å…¶å®ƒfinetuneçš„SDæ¨¡å‹ã€‚</p>
<h2 id="SD-2-0"><strong>SD 2.0</strong></h2>
<h3 id="SD-2-0-2"><strong>SD 2.0</strong></h3>
<p>Stability AIå…¬å¸åœ¨2022å¹´11æœˆï¼ˆ<a href="https://link.zhihu.com/?target=https%3A//stability.ai/blog/stable-diffusion-v2-release">stable-diffusion-v2-release</a>ï¼‰æ”¾å‡ºäº†<a href="https://link.zhihu.com/?target=https%3A//huggingface.co/stabilityai/stable-diffusion-2-base">SD 2.0ç‰ˆæœ¬</a>ï¼Œè¿™é‡Œæˆ‘ä»¬ä¹Ÿç®€å•ä»‹ç»ä¸€ä¸‹ç›¸æ¯”SD 1.xç‰ˆæœ¬SD 2.0çš„å…·ä½“æ”¹è¿›ç‚¹ã€‚SD 2.0ç›¸æ¯”SD 1.xç‰ˆæœ¬çš„ä¸»è¦å˜åŠ¨åœ¨äº<strong>æ¨¡å‹ç»“æ„</strong>å’Œ<strong>è®­ç»ƒæ•°æ®</strong>ä¸¤ä¸ªéƒ¨åˆ†ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic2.zhimg.com/80/v2-b9c901beba87587f110fc603f79b7b79_1440w.webp" alt=""></p>
<p>é¦–å…ˆæ˜¯æ¨¡å‹ç»“æ„æ–¹é¢ï¼ŒSD 1.xç‰ˆæœ¬çš„text encoderé‡‡ç”¨çš„æ˜¯OpenAIçš„CLIP ViT-L/14æ¨¡å‹ï¼Œå…¶æ¨¡å‹å‚æ•°é‡ä¸º123.65Mï¼›è€ŒSD 2.0é‡‡ç”¨äº†æ›´å¤§çš„text encoderï¼šåŸºäºOpenCLIPåœ¨laion-2bæ•°æ®é›†ä¸Šè®­ç»ƒçš„<a href="https://link.zhihu.com/?target=https%3A//huggingface.co/laion/CLIP-ViT-H-14-laion2B-s32B-b79K">CLIP ViT-H/14</a>æ¨¡å‹ï¼Œå…¶å‚æ•°é‡ä¸º354.03Mï¼Œç›¸æ¯”åŸæ¥çš„text encoderæ¨¡å‹å¤§äº†çº¦3å€ã€‚ä¸¤ä¸ªCLIPæ¨¡å‹çš„å¯¹æ¯”å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.zhimg.com/80/v2-f4f57a7cbcdfabb12dc11e57792d42c8_1440w.webp" alt=""></p>
<p>å¯ä»¥çœ‹åˆ°CLIP ViT-H/14æ¨¡å‹ç›¸æ¯”åŸæ¥çš„OpenAIçš„L/14æ¨¡å‹ï¼Œåœ¨imagenet1Kä¸Šåˆ†ç±»å‡†ç¡®ç‡å’Œmscocoå¤šæ¨¡æ€æ£€ç´¢ä»»åŠ¡ä¸Šå‡æœ‰æ˜æ˜¾çš„æå‡ï¼Œè¿™ä¹Ÿæ„å‘³ç€å¯¹åº”çš„text encoderæ›´å¼ºï¼Œèƒ½å¤ŸæŠ“ä½æ›´å‡†ç¡®çš„æ–‡æœ¬è¯­ä¹‰ä¿¡æ¯ã€‚å¦å¤–æ˜¯ä¸€ä¸ªå°ç»†èŠ‚æ˜¯SD 2.0æå–çš„æ˜¯text encoderå€’æ•°ç¬¬äºŒå±‚çš„ç‰¹å¾ï¼Œè€ŒSD 1.xæå–çš„æ˜¯å€’æ•°ç¬¬ä¸€å±‚çš„ç‰¹å¾ã€‚ç”±äºå€’æ•°ç¬¬ä¸€å±‚çš„ç‰¹å¾ä¹‹åå°±æ˜¯CLIPçš„å¯¹æ¯”å­¦ä¹ ä»»åŠ¡ï¼Œæ‰€ä»¥å€’æ•°ç¬¬ä¸€å±‚çš„ç‰¹å¾å¯èƒ½éƒ¨åˆ†ä¸¢å¤±ç»†ç²’åº¦è¯­ä¹‰ä¿¡æ¯ï¼ŒImagenè®ºæ–‡ï¼ˆè§è®ºæ–‡D.1éƒ¨åˆ†ï¼‰å’Œnovelaiï¼ˆè§<a href="https://link.zhihu.com/?target=https%3A//blog.novelai.net/novelai-improvements-on-stable-diffusion-e10d38db82ac">novelai blog</a>ï¼‰å‡é‡‡ç”¨äº†å€’æ•°ç¬¬äºŒå±‚ç‰¹å¾ã€‚å¯¹äºUNetæ¨¡å‹ï¼ŒSD 2.0ç›¸æ¯”SD 1.xå‡ ä¹æ²¡æœ‰æ”¹å˜ï¼Œå°±æ˜¯ç”±äºæ¢äº†CLIPæ¨¡å‹ï¼Œcross attention dimensionä»åŸæ¥çš„768å˜æˆäº†1024ï¼Œè¿™ä¸ªå¯¼è‡´å‚æ•°é‡æœ‰è½»å¾®å˜åŒ–ã€‚å¦å¤–ä¸€ä¸ªå°çš„å˜åŠ¨æ˜¯ï¼šSD 2.0ä¸åŒstageçš„attentionæ¨¡å—æ˜¯å›ºå®šattention head dimä¸º64ï¼Œè€ŒSD 1.0åˆ™æ˜¯ä¸åŒstageçš„attentionæ¨¡å—é‡‡ç”¨å›ºå®šattention headæ•°é‡ï¼Œæ˜æ˜¾SD 2.0çš„è¿™ç§è®¾å®šæ›´å¸¸ç”¨ï¼Œä½†æ˜¯è¿™ä¸ªå˜åŠ¨ä¸ä¼šå½±å“æ¨¡å‹å‚æ•°ã€‚ ç„¶åæ˜¯è®­ç»ƒæ•°æ®ï¼Œå‰é¢è¯´è¿‡SD 1.xç‰ˆæœ¬å…¶å®æœ€åä¸»è¦é‡‡ç”¨laion-2Bä¸­ç¾å­¦è¯„åˆ†ä¸º5ä»¥ä¸Šçš„å­é›†æ¥è®­ç»ƒï¼Œè€ŒSD 2.0ç‰ˆæœ¬é‡‡ç”¨è¯„åˆ†åœ¨4.5ä»¥ä¸Šçš„å­é›†ï¼Œç›¸å½“äºæ‰©å¤§äº†è®­ç»ƒæ•°æ®é›†ï¼Œå…·ä½“çš„è®­ç»ƒç»†èŠ‚è§<a href="https://link.zhihu.com/?target=https%3A//huggingface.co/stabilityai/stable-diffusion-2">model card</a>ã€‚ å¦å¤–SD 2.0é™¤äº†512x512ç‰ˆæœ¬çš„æ¨¡å‹ï¼Œè¿˜åŒ…æ‹¬768x768ç‰ˆæœ¬çš„æ¨¡å‹ï¼ˆ<a href="https://link.zhihu.com/?target=https%3A//huggingface.co/stabilityai/stable-diffusion-2">https://huggingface.co/stabilityai/stable-diffusion-2</a>ï¼‰ï¼Œæ‰€è°“çš„768x768æ¨¡å‹æ˜¯åœ¨512x512æ¨¡å‹åŸºç¡€ä¸Šç”¨å›¾åƒåˆ†è¾¨ç‡å¤§äº768x768çš„å­é›†ç»§ç»­è®­ç»ƒçš„ï¼Œä¸è¿‡ä¼˜åŒ–ç›®æ ‡ä¸å†æ˜¯noise_predictionï¼Œè€Œæ˜¯é‡‡ç”¨<a href="https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2202.00512">Progressive Distillation for Fast Sampling of Diffusion Models</a>è®ºæ–‡ä¸­æ‰€æå‡ºçš„ v-objectiveã€‚ ä¸‹å›¾ä¸ºSD 2.0å’ŒSD 1.xç‰ˆæœ¬åœ¨COCO2017éªŒè¯é›†ä¸Šè¯„æµ‹çš„å¯¹æ¯”ï¼Œå¯ä»¥çœ‹åˆ°2.0ç›¸æ¯”1.5ï¼ŒCLIP scoreæœ‰ä¸€ä¸ªæ˜æ˜¾çš„æå‡ï¼ŒåŒæ—¶FIDä¹Ÿæœ‰ä¸€å®šçš„æå‡ã€‚ä½†æ˜¯æ­£å¦‚å‰é¢æ‰€è®¨è®ºçš„ï¼ŒFIDå’ŒCLIP scoreè¿™ä¸¤ä¸ªæŒ‡æ ‡å‡æœ‰ä¸€å®šçš„å±€é™æ€§ï¼Œæ‰€ä»¥å…·ä½“æ•ˆæœè¿˜æ˜¯ä¸Šæ‰‹ä½¿ç”¨æ¥å¯¹æ¯”ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic4.zhimg.com/80/v2-9526ce01305b9226d1f15ce4d25079cb_1440w.webp" alt=""></p>
<p>Stability AIåœ¨å‘å¸ƒSD 2.0çš„åŒæ—¶ï¼Œè¿˜å‘å¸ƒäº†å¦å¤–3ä¸ªæ¨¡å‹ï¼š<a href="https://link.zhihu.com/?target=https%3A//huggingface.co/stabilityai/stable-diffusion-x4-upscaler">stable-diffusion-x4-upscaler</a>ï¼Œ<a href="https://link.zhihu.com/?target=https%3A//huggingface.co/stabilityai/stable-diffusion-2-inpainting">stable-diffusion-2-inpainting</a>å’Œ<a href="https://link.zhihu.com/?target=https%3A//huggingface.co/stabilityai/stable-diffusion-2-depth">stable-diffusion-2-depth</a>ã€‚Â <a href="https://link.zhihu.com/?target=https%3A//huggingface.co/stabilityai/stable-diffusion-x4-upscaler">stable-diffusion-x4-upscaler</a>æ˜¯ä¸€ä¸ªåŸºäºæ‰©æ•£æ¨¡å‹çš„4xè¶…åˆ†æ¨¡å‹ï¼Œå®ƒä¹Ÿæ˜¯åŸºäºlatent diffusionï¼Œä¸è¿‡è¿™é‡Œé‡‡ç”¨çš„autoencoderæ˜¯åŸºäºVQ-regçš„ï¼Œä¸‹é‡‡æ ·ç‡ä¸ºã€‚åœ¨å®ç°ä¸Šï¼Œå®ƒæ˜¯å°†ä½åˆ†è¾¨ç‡å›¾åƒç›´æ¥å’Œnoisy latentæ‹¼æ¥åœ¨ä¸€èµ·é€å…¥UNetï¼Œå› ä¸ºautoencoderå°†é«˜åˆ†è¾¨ç‡å›¾åƒå‹ç¼©ä¸ºåŸæ¥çš„1/4ï¼Œè€Œä½åˆ†è¾¨ç‡å›¾åƒä¹Ÿä¸ºé«˜åˆ†è¾¨ç‡å›¾åƒçš„1/4ï¼Œæ‰€ä»¥ä½åˆ†è¾¨ç‡å›¾åƒçš„ç©ºé—´ç»´åº¦å’Œlatentæ˜¯ä¸€è‡´çš„ã€‚å¦å¤–ï¼Œè¿™ä¸ªè¶…åˆ†æ¨¡å‹ä¹Ÿé‡‡ç”¨äº†<a href="https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2106.15282">Cascaded Diffusion Models for High Fidelity Image Generation</a>æ‰€æå‡ºçš„noise conditioning augmentationï¼Œç®€å•æ¥è¯´å°±æ˜¯åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ç»™ä½åˆ†è¾¨ç‡å›¾åƒåŠ ä¸Šé«˜æ–¯å™ªéŸ³ï¼Œå¯ä»¥é€šè¿‡æ‰©æ•£è¿‡ç¨‹æ¥å®ç°ï¼Œæ³¨æ„è¿™é‡Œçš„æ‰©æ•£è¿‡ç¨‹çš„schedulerä¸ä¸»æ‰©æ•£æ¨¡å‹çš„schedulerå¯ä»¥ä¸ä¸€æ ·ï¼ŒåŒæ—¶ä¹Ÿå°†å¯¹åº”çš„noise_levelï¼ˆå¯¹åº”æ‰©æ•£æ¨¡å‹çš„time stepï¼‰é€šè¿‡class labelsçš„æ–¹å¼é€å…¥UNetï¼Œè®©UNetçŸ¥é“åŠ å…¥å™ªéŸ³çš„ç¨‹åº¦ã€‚stable-diffusion-x4-upscaleræ˜¯ä½¿ç”¨LAIONä¸­&gt;2048x2048å¤§å°çš„å­é›†ï¼ˆ10Mï¼‰è®­ç»ƒçš„ï¼Œè®­ç»ƒè¿‡ç¨‹ä¸­é‡‡ç”¨512x512çš„cropsæ¥è®­ç»ƒï¼ˆé™ä½æ˜¾å­˜æ¶ˆè€—ï¼‰ã€‚SDæ¨¡å‹å¯ä»¥ç”¨æ¥ç”Ÿæˆ512x512å›¾åƒï¼ŒåŠ ä¸Šè¿™ä¸ªè¶…åˆ†æ¨¡å‹ï¼Œå°±å¯ä»¥å¾—åˆ°2048x2048å¤§å°çš„å›¾åƒã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic2.zhimg.com/80/v2-b00157e0603f4da6bccc9b7a184406b9_1440w.webp" alt=""></p>
<p>åœ¨diffusersåº“ä¸­ï¼Œå¯ä»¥å¦‚ä¸‹ä½¿ç”¨è¿™ä¸ªè¶…åˆ†æ¨¡å‹ï¼ˆè¿™é‡Œçš„noise levelæ˜¯æŒ‡æ¨ç†æ—¶å¯¹ä½åˆ†è¾¨ç‡å›¾åƒåŠ å…¥å™ªéŸ³çš„ç¨‹åº¦ï¼‰ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">from</span> diffusers <span class="keyword">import</span> StableDiffusionUpscalePipeline</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line"><span class="comment"># load model and scheduler</span></span><br><span class="line">model_id = <span class="string">&quot;stabilityai/stable-diffusion-x4-upscaler&quot;</span></span><br><span class="line">pipeline = StableDiffusionUpscalePipeline.from_pretrained(model_id, torch_dtype=torch.float16)</span><br><span class="line">pipeline = pipeline.to(<span class="string">&quot;cuda&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># let&#x27;s download an  image</span></span><br><span class="line">url = <span class="string">&quot;https://huggingface.co/datasets/hf-internal-testing/diffusers-images/resolve/main/sd2-upscale/low_res_cat.png&quot;</span></span><br><span class="line">response = requests.get(url)</span><br><span class="line">low_res_img = Image.<span class="built_in">open</span>(BytesIO(response.content)).convert(<span class="string">&quot;RGB&quot;</span>)</span><br><span class="line">low_res_img = low_res_img.resize((<span class="number">128</span>, <span class="number">128</span>))</span><br><span class="line"></span><br><span class="line">prompt = <span class="string">&quot;a white cat&quot;</span></span><br><span class="line"></span><br><span class="line">upscaled_image = pipeline(prompt=prompt, image=low_res_img, noise_level=<span class="number">20</span>).images[<span class="number">0</span>]</span><br><span class="line">upscaled_image.save(<span class="string">&quot;upsampled_cat.png&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><a href="https://link.zhihu.com/?target=https%3A//huggingface.co/stabilityai/stable-diffusion-2-inpainting">stable-diffusion-2-inpainting</a>æ˜¯å›¾åƒinpaintingæ¨¡å‹ï¼Œå’Œå‰é¢æ‰€è¯´çš„<a href="https://link.zhihu.com/?target=https%3A//huggingface.co/runwayml/stable-diffusion-inpainting">runwayml/stable-diffusion-inpainting</a>åŸºæœ¬ä¸€æ ·ï¼Œä¸è¿‡å®ƒæ˜¯åœ¨SD 2.0çš„512x512ç‰ˆæœ¬ä¸Šfinetuneçš„ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic4.zhimg.com/80/v2-3e7314c658c27783635a47dee1ed3ea3_1440w.webp" alt=""></p>
<p><a href="https://link.zhihu.com/?target=https%3A//huggingface.co/stabilityai/stable-diffusion-2-depth">stable-diffusion-2-depth</a>æ˜¯ä¹Ÿæ˜¯åœ¨SD 2.0çš„512x512ç‰ˆæœ¬ä¸Šfinetuneçš„æ¨¡å‹ï¼Œå®ƒæ˜¯é¢å¤–å¢åŠ äº†å›¾åƒçš„æ·±åº¦å›¾ä½œä¸ºconditionï¼Œè¿™é‡Œæ˜¯ç›´æ¥å°†æ·±åº¦å›¾ä¸‹é‡‡æ ·8xï¼Œç„¶åå’Œnosiy latentæ‹¼æ¥åœ¨ä¸€èµ·é€å…¥UNetæ¨¡å‹ä¸­ã€‚æ·±åº¦å›¾å¯ä»¥ä½œä¸ºä¸€ç§ç»“æ„æ§åˆ¶ï¼Œä¸‹å›¾å±•ç¤ºäº†åŠ å…¥æ·±åº¦å›¾åç”Ÿæˆçš„å›¾åƒæ•ˆæœï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.zhimg.com/80/v2-ba0c12df1d24ee074a06412493e397c8_1440w.webp" alt=""></p>
<p>ä½ å¯ä»¥è°ƒç”¨diffusersåº“ä¸­çš„<code>StableDiffusionDepth2ImgPipeline</code>æ¥å®ç°åŸºäºæ·±åº¦å›¾æ§åˆ¶çš„æ–‡ç”Ÿå›¾ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> diffusers <span class="keyword">import</span> StableDiffusionDepth2ImgPipeline</span><br><span class="line"></span><br><span class="line">pipe = StableDiffusionDepth2ImgPipeline.from_pretrained(</span><br><span class="line">   <span class="string">&quot;stabilityai/stable-diffusion-2-depth&quot;</span>,</span><br><span class="line">   torch_dtype=torch.float16,</span><br><span class="line">).to(<span class="string">&quot;cuda&quot;</span>)</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://images.cocodataset.org/val2017/000000039769.jpg&quot;</span></span><br><span class="line">init_image = Image.<span class="built_in">open</span>(requests.get(url, stream=<span class="literal">True</span>).raw)</span><br><span class="line"></span><br><span class="line">prompt = <span class="string">&quot;two tigers&quot;</span></span><br><span class="line">n_propmt = <span class="string">&quot;bad, deformed, ugly, bad anotomy&quot;</span></span><br><span class="line">image = pipe(prompt=prompt, image=init_image, negative_prompt=n_propmt, strength=<span class="number">0.7</span>).images[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<p>é™¤æ­¤ä¹‹å¤–ï¼ŒStability AIå…¬å¸è¿˜å¼€æºäº†ä¸¤ä¸ªåŠ å¼ºç‰ˆçš„autoencoderï¼š<a href="https://link.zhihu.com/?target=https%3A//huggingface.co/stabilityai/sd-vae-ft-mse-original">ft-EMAå’Œft-MSE</a>ï¼ˆå‰è€…ä½¿ç”¨L1 lossåè€…ä½¿ç”¨MSE lossï¼‰ï¼Œå‰é¢å·²ç»è¯´è¿‡ï¼Œå®ƒä»¬æ˜¯åœ¨LAIONæ•°æ®é›†ç»§ç»­finetune decoderæ¥å¢å¼ºé‡å»ºæ•ˆæœã€‚</p>
<h3 id="SD-2-1"><strong>SD 2.1</strong></h3>
<p>åœ¨SD 2.0ç‰ˆæœ¬å‘å¸ƒå‡ å‘¨åï¼ŒStability AIåˆå‘å¸ƒäº†<a href="https://link.zhihu.com/?target=https%3A//stability.ai/blog/stablediffusion2-1-release7-dec-2022">SD 2.1</a>ã€‚SD 2.0åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­é‡‡ç”¨NSFWæ£€æµ‹å™¨è¿‡æ»¤æ‰äº†å¯èƒ½åŒ…å«è‰²æƒ…çš„å›¾åƒï¼ˆpunsafe=0.1ï¼‰ï¼Œä½†æ˜¯ä¹ŸåŒæ—¶è¿‡æ»¤äº†å¾ˆå¤šäººåƒå›¾ç‰‡ï¼Œè¿™å¯¼è‡´SD 2.0åœ¨äººåƒç”Ÿæˆä¸Šæ•ˆæœå¯èƒ½è¾ƒå·®ï¼Œæ‰€ä»¥SD 2.1æ˜¯åœ¨SD 2.0çš„åŸºç¡€ä¸Šæ”¾å¼€äº†é™åˆ¶ï¼ˆpunsafe=0.98ï¼‰ç»§ç»­finetuneï¼Œæ‰€ä»¥å¢å¼ºäº†äººåƒçš„ç”Ÿæˆæ•ˆæœã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic2.zhimg.com/80/v2-904f2a50d768c499948deb0be938ba65_1440w.webp" alt=""></p>
<p>å’ŒSD 2.0ä¸€æ ·ï¼ŒSD 2.1ä¹ŸåŒ…å«ä¸¤ä¸ªç‰ˆæœ¬ï¼š<a href="https://link.zhihu.com/?target=https%3A//huggingface.co/stabilityai/stable-diffusion-2-1-base">512x512ç‰ˆæœ¬</a>å’Œ<a href="https://link.zhihu.com/?target=https%3A//huggingface.co/stabilityai/stable-diffusion-2-1">768x768ç‰ˆæœ¬</a>ã€‚</p>
<h3 id="SD-unclip"><strong>SD unclip</strong></h3>
<p>Stability AIåœ¨2023å¹´3æœˆä»½ï¼Œåˆæ”¾å‡ºäº†åŸºäºSDçš„å¦å¤–ä¸€ä¸ªæ¨¡å‹ï¼š<a href="https://link.zhihu.com/?target=https%3A//stability.ai/blog/stable-diffusion-reimagine">stable-diffusion-reimagine</a>ï¼Œå®ƒå¯ä»¥å®ç°å•ä¸ªå›¾åƒçš„å˜æ¢ï¼Œå³image variationsï¼Œç›®å‰è¯¥æ¨¡å‹å·²ç»åœ¨åœ¨huggingfaceä¸Šå¼€æºï¼š<a href="https://link.zhihu.com/?target=https%3A//huggingface.co/stabilityai/stable-diffusion-2-1-unclip">stable-diffusion-2-1-unclip</a>ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic3.zhimg.com/80/v2-e4cf221f07f5873312e9e6f3fa1f977a_1440w.webp" alt=""></p>
<p>è¿™ä¸ªæ¨¡å‹æ˜¯å€Ÿé‰´äº†OpenAIçš„DALLE2ï¼ˆåˆç§°unCLIP)ï¼ŒunCLIPæ˜¯åŸºäºCLIPçš„image encoderæå–çš„image embeddingsä½œä¸ºconditionæ¥å®ç°å›¾åƒçš„ç”Ÿæˆã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic3.zhimg.com/80/v2-8add1d6507e924f1b60b6854f86cf53a_1440w.webp" alt=""></p>
<p>SD unCLIPæ˜¯åœ¨åŸæ¥çš„SDæ¨¡å‹çš„åŸºç¡€ä¸Šå¢åŠ äº†CLIPçš„image encoderçš„nosiy image embeddingsä½œä¸ºconditionã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­æ˜¯å¯¹æå–çš„image embeddingsæ–½åŠ ä¸€å®šçš„é«˜æ–¯å™ªéŸ³ï¼ˆä¹Ÿæ˜¯é€šè¿‡æ‰©æ•£è¿‡ç¨‹ï¼‰ï¼Œç„¶åå°†noise levelå¯¹åº”çš„time embeddingså’Œimage embeddingsæ‹¼æ¥åœ¨ä¸€èµ·ï¼Œæœ€åå†ä»¥class labelsçš„æ–¹å¼é€å…¥UNetã€‚åœ¨diffusersä¸­ï¼Œä½ å¯ä»¥è°ƒç”¨<code>StableUnCLIPImg2ImgPipeline</code>æ¥å®ç°å›¾åƒçš„å˜æ¢ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> diffusers <span class="keyword">import</span> StableUnCLIPImg2ImgPipeline</span><br><span class="line"></span><br><span class="line"><span class="comment">#Start the StableUnCLIP Image variations pipeline</span></span><br><span class="line">pipe = StableUnCLIPImg2ImgPipeline.from_pretrained(</span><br><span class="line">    <span class="string">&quot;stabilityai/stable-diffusion-2-1-unclip&quot;</span>, torch_dtype=torch.float16, variation=<span class="string">&quot;fp16&quot;</span></span><br><span class="line">)</span><br><span class="line">pipe = pipe.to(<span class="string">&quot;cuda&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Get image from URL</span></span><br><span class="line">url = <span class="string">&quot;https://huggingface.co/datasets/hf-internal-testing/diffusers-images/resolve/main/stable_unclip/tarsila_do_amaral.png&quot;</span></span><br><span class="line">response = requests.get(url)</span><br><span class="line">init_image = Image.<span class="built_in">open</span>(BytesIO(response.content)).convert(<span class="string">&quot;RGB&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Pipe to make the variation</span></span><br><span class="line">images = pipe(init_image).images</span><br><span class="line">images[<span class="number">0</span>].save(<span class="string">&quot;tarsila_variation.png&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>å…¶å®åœ¨SD unCLIPä¹‹å‰ï¼Œå·²ç»æœ‰<a href="https://link.zhihu.com/?target=https%3A//lambdalabs.com/">Lambda Labs</a>å¼€æºçš„<a href="https://link.zhihu.com/?target=https%3A//lambdalabs.com/">sd-image-variations-diffusers</a>ï¼Œå®ƒæ˜¯åœ¨SD 1.4çš„åŸºç¡€ä¸Šfinetuneçš„æ¨¡å‹ï¼Œä¸è¿‡å®ç°æ–¹å¼æ˜¯ç›´æ¥å°†text embeddingsæ›¿æ¢ä¸ºimage embeddingsï¼Œè¿™æ ·ä¹ŸåŒæ ·å¯ä»¥å®ç°å›¾åƒçš„å˜æ¢ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic3.zhimg.com/80/v2-6baa63b6a282ab9b55c301af2a94dd86_1440w.webp" alt=""></p>
<p>è¿™é‡ŒSD unCLIPæœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼šsd21-unclip-lå’Œsd21-unclip-hï¼Œä¸¤è€…åˆ†åˆ«æ˜¯é‡‡ç”¨OpenAI CLIP-Lå’ŒOpenCLIP-Hæ¨¡å‹çš„image embeddingsä½œä¸ºconditionã€‚å¦‚æœè¦å®ç°æ–‡ç”Ÿå›¾ï¼Œè¿˜éœ€è¦åƒDALLE2é‚£æ ·è®­ç»ƒä¸€ä¸ªprioræ¨¡å‹ï¼Œå®ƒå¯ä»¥å®ç°åŸºäºæ–‡æœ¬æ¥é¢„æµ‹å¯¹åº”çš„image embeddingsï¼Œæˆ‘ä»¬å°†prioræ¨¡å‹å’ŒSD unCLIPæ¥åœ¨ä¸€èµ·å°±å¯ä»¥å®ç°æ–‡ç”Ÿå›¾äº†ã€‚<a href="https://link.zhihu.com/?target=https%3A//kakaobrain.com/">KakaoBrain</a>è¿™ä¸ªå…¬å¸å·²ç»å¼€æºäº†ä¸€ä¸ªDALLE2çš„å¤ç°ç‰ˆæœ¬ï¼š<a href="https://link.zhihu.com/?target=https%3A//github.com/kakaobrain/karlo">Karlo</a>ï¼Œå®ƒæ˜¯åŸºäºOpenAI CLIP-Læ¥å®ç°çš„ï¼Œä½ å¯ä»¥åŸºäºè¿™ä¸ªæ¨¡å‹ä¸­prioræ¨¡å—åŠ ä¸Šsd21-unclip-læ¥å®ç°æ–‡æœ¬åˆ°å›¾åƒçš„ç”Ÿæˆï¼Œç›®å‰è¿™ä¸ªå·²ç»é›†æˆäº†åœ¨<a href="https://link.zhihu.com/?target=https%3A//github.com/huggingface/diffusers/blob/main/src/diffusers/pipelines/stable_diffusion/pipeline_stable_unclip.py">StableUnCLIPPipeline</a>ä¸­ï¼Œæˆ–è€…åŸºäº<a href="https://link.zhihu.com/?target=https%3A//github.com/Stability-AI/stablediffusion/blob/main/scripts/streamlit/stableunclip.py">stablediffusionå®˜æ–¹ä»“åº“</a>æ¥å®ç°ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic3.zhimg.com/80/v2-030ded0b7cca24ffb813d26fc887b1a6_1440w.webp" alt=""></p>
<h2 id="SDçš„å…¶å®ƒç‰¹è‰²åº”ç”¨"><strong>SDçš„å…¶å®ƒç‰¹è‰²åº”ç”¨</strong></h2>
<p>åœ¨SDæ¨¡å‹å¼€æºä¹‹åï¼Œç¤¾åŒºå’Œç ”ç©¶æœºæ„ä¹ŸåŸºäºSDå®ç°äº†å½¢å¼å¤šæ ·çš„ç‰¹è‰²åº”ç”¨ï¼Œè¿™é‡Œæˆ‘ä»¬ä¹Ÿé€‰æ‹©ä¸€äº›æ¯”è¾ƒç«çš„åº”ç”¨æ¥ä»‹ç»ä¸€ä¸‹ã€‚</p>
<h3 id="ä¸ªæ€§åŒ–ç”Ÿæˆ"><strong>ä¸ªæ€§åŒ–ç”Ÿæˆ</strong></h3>
<p>ä¸ªæ€§åŒ–ç”Ÿæˆæ˜¯æŒ‡çš„ç”Ÿæˆç‰¹å®šçš„è§’è‰²æˆ–è€…é£æ ¼ï¼Œæ¯”å¦‚ç»™å®šè‡ªå·±å‡ å¼ è‚–åƒæ¥åˆ©ç”¨SDæ¥ç”Ÿæˆä¸ªæ€§åŒ–å¤´åƒã€‚åœ¨ä¸ªæ€§åŒ–ç”Ÿæˆæ–¹é¢ï¼Œæ¯”è¾ƒé‡è¦çš„ä¸¤ä¸ªå·¥ä½œæ˜¯è‹±ä¼Ÿè¾¾çš„<a href="https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2208.01618">Textual Inversion</a>å’Œè°·æ­Œçš„<a href="https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2208.12242">DreamBooth</a>ã€‚Â <strong>Textual Inversion</strong>è¿™ä¸ªå·¥ä½œçš„æ ¸å¿ƒæ€è·¯æ˜¯åŸºäºç”¨æˆ·æä¾›çš„3ï½5å¼ ç‰¹å®šæ¦‚å¿µï¼ˆç‰©ä½“æˆ–è€…é£æ ¼ï¼‰çš„å›¾åƒæ¥å­¦ä¹ ä¸€ä¸ªç‰¹å®šçš„text embeddingsï¼Œå®é™…ä¸Šåªç”¨ä¸€ä¸ªword embeddingå°±è¶³å¤Ÿäº†ã€‚<strong>Textual Inversion</strong>ä¸éœ€è¦finetune UNetï¼Œè€Œä¸”ç”±äºtext embeddingsè¾ƒå°ï¼Œå­˜å‚¨æˆæœ¬å¾ˆä½ã€‚ç›®å‰diffusersåº“å·²ç»æ”¯æŒ<a href="https://link.zhihu.com/?target=https%3A//github.com/huggingface/diffusers/tree/main/examples/textual_inversion">textual_inversionçš„è®­ç»ƒ</a>ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.zhimg.com/80/v2-2e5448b758b8b67f77c0c7278c70db60_1440w.webp" alt=""></p>
<p><strong>DreamBooth</strong>åŸæœ¬æ˜¯è°·æ­Œæå‡ºçš„åº”ç”¨åœ¨Imagenä¸Šçš„ä¸ªæ€§åŒ–ç”Ÿæˆï¼Œä½†æ˜¯å®ƒå®é™…ä¸Šä¹Ÿå¯ä»¥æ‰©å±•åˆ°SDä¸Šï¼ˆæ›´æ–°ç‰ˆè®ºæ–‡å·²ç»å¢åŠ äº†SDï¼‰ã€‚DreamBoothé¦–å…ˆä¸ºç‰¹å®šçš„æ¦‚å¿µå¯»æ‰¾ä¸€ä¸ªç‰¹å®šçš„æè¿°è¯[V]ï¼Œè¿™ä¸ªç‰¹å®šçš„æè¿°è¯åªè¦æ˜¯ç¨€æœ‰çš„å°±å¯ä»¥ï¼Œç„¶åä¸Textual Inversionä¸åŒçš„æ˜¯DreamBoothéœ€è¦finetune UNetï¼Œè¿™é‡Œä¸ºäº†é˜²æ­¢è¿‡æ‹Ÿåˆï¼Œå¢åŠ äº†ä¸€ä¸ªclass-specific prior preservation lossï¼ˆåŸºäºSDç”ŸæˆåŒclasså›¾åƒåŠ å…¥batché‡Œé¢è®­ç»ƒï¼‰æ¥è¿›è¡Œæ­£åˆ™åŒ–ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic4.zhimg.com/80/v2-810d8ba5757afe4fa4a22a72b8bf345f_1440w.webp" alt=""></p>
<p>ç”±äºfinetuneäº†UNetï¼ŒDreamBoothå¾€å¾€æ¯”Textual Inversionè¦è¡¨ç°çš„è¦å¥½ï¼Œä½†æ˜¯DreamBoothçš„å­˜å‚¨æˆæœ¬è¾ƒé«˜ã€‚ç›®å‰diffusersåº“å·²ç»æ”¯æŒ<a href="https://link.zhihu.com/?target=https%3A//github.com/huggingface/diffusers/tree/main/examples/dreambooth">dreamboothè®­ç»ƒ</a>ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨<a href="https://link.zhihu.com/?target=https%3A//huggingface.co/sd-dreambooth-library">sd-dreambooth-library</a>ä¸­æ‰¾åˆ°å…¶ä»–äººä¸Šä¼ çš„æ¨¡å‹ã€‚ DreamBoothå’ŒTextual Inversionæ˜¯æœ€å¸¸ç”¨çš„ä¸ªæ€§åŒ–ç”Ÿæˆæ–¹æ³•ï¼Œä½†å…¶å®é™¤äº†è¿™ä¸¤ç§ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶å®ƒçš„ç ”ç©¶å·¥ä½œï¼Œæ¯”å¦‚Adobeæå‡ºçš„<a href="https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2212.04488">Custom Diffusion</a>ï¼Œç›¸æ¯”DreamBoothï¼Œå®ƒåªfinetuneäº†UNetçš„attentionæ¨¡å—çš„KVæƒé‡çŸ©é˜µï¼ŒåŒæ—¶ä¼˜åŒ–ä¸€ä¸ªæ–°æ¦‚å¿µçš„tokenã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.zhimg.com/80/v2-9f3d22dbfbd59c76a2e9ae23b34cfb7c_1440w.webp" alt=""></p>
<h3 id="é£æ ¼åŒ–finetuneæ¨¡å‹"><strong>é£æ ¼åŒ–finetuneæ¨¡å‹</strong></h3>
<p>SDçš„å¦å¤–ä¸€å¤§åº”ç”¨æ˜¯é‡‡ç”¨ç‰¹å®šé£æ ¼çš„æ•°æ®é›†è¿›è¡Œfinetuneï¼Œè¿™ä½¿å¾—<strong>æ¨¡å‹â€œè¿‡æ‹Ÿåˆâ€åœ¨ç‰¹å®šçš„é£æ ¼ä¸Š</strong>ã€‚ä¹‹å‰æ¯”è¾ƒç«çš„novelaiå°±æ˜¯åŸºäºäºŒæ¬¡å…ƒæ•°æ®åœ¨SDä¸Šfinetuneçš„æ¨¡å‹ï¼Œè™½ç„¶å®ƒå¤±å»äº†ç”Ÿæˆå…¶å®ƒé£æ ¼å›¾åƒçš„èƒ½åŠ›ï¼Œä½†æ˜¯å®ƒåœ¨äºŒæ¬¡å…ƒå›¾åƒçš„ç”Ÿæˆæ•ˆæœä¸Šæ¯”åŸæ¥çš„SDè¦å¥½å¾ˆå¤šã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic2.zhimg.com/80/v2-8e8aae59e87393c49ef39820263ed9ed_1440w.webp" alt=""></p>
<p>ç›®å‰å·²ç»æœ‰å¾ˆå¤šé£æ ¼åŒ–çš„æ¨¡å‹åœ¨huggingfaceä¸Šå¼€æºï¼Œè¿™é‡Œä¹Ÿåˆ—å‡ºä¸€äº›ï¼š</p>
<ul>
<li><a href="https://link.zhihu.com/?target=https%3A//huggingface.co/andite/anything-v4.0">andite/anything-v4.0</a>ï¼šäºŒæ¬¡å…ƒæˆ–è€…åŠ¨æ¼«é£æ ¼å›¾åƒ</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic2.zhimg.com/80/v2-6b783d310eab94176f3e1886a94073ad_1440w.webp" alt=""></p>
<p>grid-0018.png</p>
<ul>
<li><a href="https://link.zhihu.com/?target=https%3A//huggingface.co/dreamlike-art/dreamlike-diffusion-1.0">dreamlike-art/dreamlike-diffusion-1.0</a>ï¼šè‰ºæœ¯é£æ ¼å›¾åƒ</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.zhimg.com/80/v2-90e406ec533680de88ebc8536d6db20c_1440w.webp" alt=""></p>
<p>image.png</p>
<ul>
<li><a href="https://link.zhihu.com/?target=https%3A//huggingface.co/prompthero/openjourney">prompthero/openjourney</a>ï¼šmdjrny-v4é£æ ¼å›¾åƒ</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.zhimg.com/80/v2-96f85e8e85e7b9f53075708acbe2f938_1440w.webp" alt=""></p>
<p>æ›´å¤šçš„æ¨¡å‹å¯ä»¥ç›´æ¥åœ¨<a href="https://link.zhihu.com/?target=https%3A//huggingface.co/models%3Fpipeline_tag%3Dtext-to-image%26sort%3Ddownloads">huggingface text-to-imageæ¨¡å‹åº“</a>ä¸Šæ‰¾åˆ°ã€‚æ­¤å¤–ï¼Œå¾ˆå¤šåŸºäºSDè¿›è¡Œfinetuneçš„æ¨¡å‹å¼€æºåœ¨<a href="https://link.zhihu.com/?target=https%3A//civitai.com/">civitai</a>ä¸Šï¼Œä½ ä¹Ÿå¯ä»¥åœ¨è¿™ä¸ªç½‘ç«™ä¸Šæ‰¾åˆ°æ›´å¤šé£æ ¼çš„æ¨¡å‹ã€‚ å€¼å¾—è¯´æ˜çš„ä¸€ç‚¹æ˜¯ï¼Œç›®å‰finetune SDæ¨¡å‹çš„æ–¹æ³•ä¸»è¦æœ‰ä¸¤ç§ï¼šä¸€ç§æ˜¯ç›´æ¥finetuneäº†UNetï¼Œä½†æ˜¯å®¹æ˜“è¿‡æ‹Ÿåˆï¼Œè€Œä¸”å­˜å‚¨æˆæœ¬ï¼›å¦å¤–ä¸€ç§ä½æˆæœ¬çš„æ–¹æ³•æ˜¯åŸºäºå¾®è½¯çš„<a href="https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2106.09685">LoRA</a>ï¼ŒLoRAæœ¬æ¥æ˜¯ç”¨äºfinetuneè¯­è¨€æ¨¡å‹çš„ï¼Œä½†æ˜¯ç°åœ¨å·²ç»å¯ä»¥ç”¨æ¥finetune SDæ¨¡å‹äº†ï¼Œå…·ä½“å¯ä»¥è§åšå®¢<a href="https://link.zhihu.com/?target=https%3A//huggingface.co/blog/lora">Using LoRA for Efficient Stable Diffusion Fine-Tuning</a>ã€‚</p>
<h3 id="å›¾åƒç¼–è¾‘"><strong>å›¾åƒç¼–è¾‘</strong></h3>
<p>å›¾åƒç¼–è¾‘ä¹Ÿæ˜¯SDæ¯”è¾ƒç«çš„åº”ç”¨æ–¹å‘ï¼Œè¿™é‡Œæ‰€è¯´çš„å›¾åƒç¼–è¾‘æ˜¯æŒ‡çš„æ˜¯ä½¿ç”¨SDæ¥å®ç°å¯¹å›¾ç‰‡çš„å±€éƒ¨ç¼–è¾‘ã€‚è¿™é‡Œåˆ—ä¸¾ä¸¤ä¸ªæ¯”è¾ƒå¥½çš„å·¥ä½œï¼šè°·æ­Œçš„<a href="https://link.zhihu.com/?target=https%3A//prompt-to-prompt.github.io/">prompt-to-prompt</a>å’ŒåŠ å·ä¼¯å…‹åˆ©çš„<a href="https://link.zhihu.com/?target=https%3A//www.timothybrooks.com/instruct-pix2pix">instruct-pix2pix</a>ã€‚ è°·æ­Œçš„<strong>prompt-to-prompt</strong>çš„æ ¸å¿ƒæ˜¯åŸºäºUNetçš„cross attention mapsæ¥å®ç°å¯¹å›¾åƒçš„ç¼–è¾‘ï¼Œå®ƒçš„å¥½å¤„æ˜¯ä¸éœ€è¦finetuneæ¨¡å‹ï¼Œä½†æ˜¯ä¸»è¦ç”¨åœ¨ç¼–è¾‘ç”¨SDç”Ÿæˆçš„å›¾åƒã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic3.zhimg.com/80/v2-e030e7244f8b2cc2ffea6df0d8fd8f92_1440w.webp" alt=""></p>
<p>è°·æ­Œåé¢çš„å·¥ä½œ<a href="https://link.zhihu.com/?target=https%3A//null-text-inversion.github.io/">Null-text Inversion</a>æœ‰è¿›ä¸€æ­¥å®ç°äº†å¯¹çœŸå®å›¾ç‰‡çš„ç¼–è¾‘ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.zhimg.com/80/v2-3df9637930f5e7041e5174e3e5491754_1440w.webp" alt=""></p>
<p><strong>instruct-pix2pix</strong>è¿™ä¸ªå·¥ä½œåŸºäºGPT-3å’Œprompt-to-promptæ„å»ºäº†pairçš„æ•°æ®é›†ï¼Œç„¶ååœ¨SDä¸Šè¿›è¡Œfinetuneï¼Œå®ƒå¯ä»¥è¾“å…¥text instructå¯¹å›¾åƒè¿›è¡Œç¼–è¾‘ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.zhimg.com/80/v2-d1ef06288b3e9e55fe8c5e06834d0288_1440w.webp" alt=""></p>
<h3 id="å¯æ§ç”Ÿæˆ"><strong>å¯æ§ç”Ÿæˆ</strong></h3>
<p>å¯æ§ç”Ÿæˆæ˜¯SDæœ€è¿‘æ¯”è¾ƒç«çš„åº”ç”¨ï¼Œè¿™ä¸»è¦å½’åŠŸäº<a href="https://link.zhihu.com/?target=https%3A//github.com/lllyasviel/ControlNet">ControlNet</a>ï¼ŒåŸºäºControlNetå¯ä»¥å®ç°å¯¹å¾ˆå¤šç§ç±»çš„å¯æ§ç”Ÿæˆï¼Œæ¯”å¦‚è¾¹ç¼˜ï¼Œäººä½“å…³é”®ç‚¹ï¼Œè‰å›¾å’Œæ·±åº¦å›¾ç­‰ç­‰ã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic4.zhimg.com/80/v2-3292ad0f7cf01d1007ddee10c1417963_1440w.webp" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic2.zhimg.com/80/v2-47f7a07f07658468255e4eee08da2e19_1440w.webp" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic1.zhimg.com/80/v2-99f30fa18f1a09a75e88c4a12463a23c_1440w.webp" alt=""></p>
<p>å…¶å®åœ¨ControlNetä¹‹å‰ï¼Œä¹Ÿæœ‰ä¸€äº›å¯æ§ç”Ÿæˆçš„å·¥ä½œï¼Œæ¯”å¦‚<a href="https://link.zhihu.com/?target=https%3A//huggingface.co/stabilityai/stable-diffusion-2-depth">stable-diffusion-2-depth</a>ä¹Ÿå±äºå¯æ§ç”Ÿæˆï¼Œä½†æ˜¯éƒ½æ²¡æœ‰å¤ªç«ã€‚æˆ‘è§‰å¾—ControlNetä¹‹æ‰€ä»¥ç«ï¼Œæ˜¯å› ä¸ºè¿™ä¸ªå·¥ä½œç›´æ¥å®ç°äº†å„ç§å„ç§çš„å¯æ§ç”Ÿæˆï¼Œè€Œä¸”è®­ç»ƒçš„ControlNetå¯ä»¥è¿ç§»åˆ°å…¶å®ƒåŸºäºSD finetuneçš„æ¨¡å‹ä¸Šï¼ˆè§<a href="https://link.zhihu.com/?target=https%3A//github.com/lllyasviel/ControlNet/discussions/12">Transfer Control to Other SD1.X Models</a>ï¼‰ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic2.zhimg.com/80/v2-85d938ca6266b4f8c3ed899b868e6bb5_1440w.webp" alt=""></p>
<p>ä¸ControlNetåŒæœŸçš„å·¥ä½œè¿˜æœ‰è…¾è®¯çš„<a href="https://link.zhihu.com/?target=https%3A//github.com/TencentARC/T2I-Adapter">T2I-Adapter</a>ä»¥åŠé˜¿é‡Œçš„<a href="https://link.zhihu.com/?target=https%3A//damo-vilab.github.io/composer-page/">composer-page</a>ï¼š</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic4.zhimg.com/80/v2-ef724be09052bb0c7b1144369dd41963_1440w.webp" alt=""></p>
<h3 id="stable-diffusion-webui"><strong>stable-diffusion-webui</strong></h3>
<p>æœ€åè¦ä»‹ç»çš„ä¸€ä¸ªæ¯”è¾ƒç«çš„åº”ç”¨<a href="https://link.zhihu.com/?target=https%3A//github.com/AUTOMATIC1111/stable-diffusion-webui">stable-diffusion-webui</a>å…¶å®æ˜¯ç”¨æ¥æ”¯æŒSDå‡ºå›¾çš„ä¸€ä¸ªwebå·¥å…·ï¼Œå®ƒç®—æ˜¯åŸºäº<a href="https://link.zhihu.com/?target=https%3A//gradio.app/">gradio</a>æ¡†æ¶å®ç°äº†SDçš„å¿«é€Ÿéƒ¨ç½²ï¼Œä¸ä»…æ”¯æŒSDçš„æœ€åŸºç¡€çš„æ–‡ç”Ÿå›¾ã€å›¾ç”Ÿå›¾ä»¥åŠå›¾åƒinpaintingåŠŸèƒ½ï¼Œè¿˜æ”¯æŒSDçš„å…¶å®ƒæ‹“å±•åŠŸèƒ½ï¼Œå¾ˆå¤šåŸºäºSDçš„æ‹“å±•åº”ç”¨å¯ä»¥ç”¨æ’ä»¶çš„æ–¹å¼å®‰è£…åœ¨webuiä¸Šã€‚</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://pic3.zhimg.com/80/v2-40b6807bb357a446ec1acbad13bd4d0e_1440w.webp" alt=""></p>
<h2 id="åè¯"><strong>åè¯</strong></h2>
<p>åœ¨OpenAIæœ€æ—©æ”¾å‡ºDALLE2çš„æ—¶å€™ï¼Œæˆ‘æ›¾è¢«å®ƒç”Ÿæˆçš„å›¾åƒæ‰€æƒŠè‰³åˆ°ï¼Œä½†æ˜¯æˆ‘ä»æ¥æ²¡æœ‰æƒ³åˆ°å›¾åƒç”Ÿæˆçš„AIGCä¼šå¦‚æ­¤ç«çˆ†ï¼ŒæŠ€æœ¯çš„å‘å±•å¤ªå¿«äº†ï¼Œè¿™å¾—ç›Šäºäº’è”ç½‘ç‹¬æœ‰çš„å¼€æºç²¾ç¥ã€‚æˆ‘æƒ³ï¼Œæ²¡æœ‰SDçš„å¼€æºï¼Œä¼°è®¡è¿™ä¸ªæ–¹å‘å¯èƒ½è¿˜ä¼šæ²‰å¯‚ä¸€æ®µæ—¶é—´ã€‚</p>
<h2 id="å‚è€ƒ"><strong>å‚è€ƒ</strong></h2>
<ul>
<li><a href="https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2112.10752">High-Resolution Image Synthesis with Latent Diffusion Models</a></li>
<li><a href="https://link.zhihu.com/?target=https%3A//huggingface.co/CompVis/stable-diffusion-v1-4">https://huggingface.co/CompVis/stable-diffusion-v1-4</a></li>
<li><a href="https://link.zhihu.com/?target=https%3A//huggingface.co/runwayml/stable-diffusion-v1-5">https://huggingface.co/runwayml/stable-diffusion-v1-5</a></li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/huggingface/diffusers">https://github.com/huggingface/diffusers</a></li>
<li><a href="https://link.zhihu.com/?target=https%3A//huggingface.co/blog/stable_diffusion">https://huggingface.co/blog/stable_diffusion</a></li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/CompVis/latent-diffusion">https://github.com/CompVis/latent-diffusion</a></li>
<li><a href="https://link.zhihu.com/?target=https%3A//laion.ai/blog/laion-5b/">https://laion.ai/blog/laion-5b/</a></li>
<li><a href="https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2303.05511">https://arxiv.org/abs/2303.05511</a></li>
<li><a href="https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2211.01324">https://arxiv.org/abs/2211.01324</a></li>
<li><a href="https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2205.11487">https://arxiv.org/abs/2205.11487</a></li>
<li><a href="https://link.zhihu.com/?target=https%3A//keras.io/guides/keras_cv/generate_images_with_stable_diffusion/">https://keras.io/guides/keras_cv/generate_images_with_stable_diffusion/</a></li>
<li><a href="https://link.zhihu.com/?target=https%3A//stability.ai/blog/stablediffusion2-1-release7-dec-2022">https://stability.ai/blog/stablediffusion2-1-release7-dec-2022</a></li>
</ul>
<p>ç¼–è¾‘äº 2023-07-14 00:03ãƒ»IP å±åœ°å¹¿ä¸œ</p>
</article><div class="tag_share"><div class="post-meta__tag-list"></div></div><link rel="stylesheet" href="/css/coin.css" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">æŠ•å–‚ä½œè€…</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://tuchuang.voooe.cn/images/2023/01/04/2.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://tuchuang.voooe.cn/images/2023/01/04/2.webp" alt="å¾®ä¿¡"/></a><div class="post-qr-code-desc">å¾®ä¿¡</div></li><li class="reward-item"><a href="https://tuchuang.voooe.cn/images/2023/01/04/20f8e49805975b8f8.webp" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://tuchuang.voooe.cn/images/2023/01/04/20f8e49805975b8f8.webp" alt="æ”¯ä»˜å®"/></a><div class="post-qr-code-desc">æ”¯ä»˜å®</div></li></ul></div></button></div><audio id="coinAudio" src="https://npm.elemecdn.com/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer="defer" src="/js/coin.js"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/3596161d.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://picss.sunbangyan.cn/2023/12/09/38a386e44035563b5554b58bffb506fa.jpeg - https://picss.sunbangyan.cn/2023/12/09/38a386e44035563b5554b58bffb506fa.jpeg" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">ç½‘é¡µåµŒå¥—WEBSDRæŠ€æœ¯æµ‹è¯•</div></div></a></div><div class="next-post pull-right"><a href="/posts/2683becb.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://picss.sunbangyan.cn/2023/12/09/38a386e44035563b5554b58bffb506fa.jpeg - https://picss.sunbangyan.cn/2023/12/09/38a386e44035563b5554b58bffb506fa.jpeg" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">å…³äºStable Diffusion AIç»˜å›¾</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><svg class="meta_icon" style="width:22px;height:22px;position:relative;top:5px"><use xlink:href="#icon-mulu1"></use></svg><span style="font-weight:bold">ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#SD%E6%A8%A1%E5%9E%8B%E5%8E%9F%E7%90%86"><span class="toc-text">SDæ¨¡å‹åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#autoencoder"><span class="toc-text">autoencoder</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CLIP-text-encoder"><span class="toc-text">CLIP text encoder</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UNet"><span class="toc-text">UNet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%AD%E7%BB%83%E7%BB%86%E8%8A%82"><span class="toc-text">è®­ç»ƒç»†èŠ‚</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%9E%8B%E8%AF%84%E6%B5%8B"><span class="toc-text">æ¨¡å‹è¯„æµ‹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SD%E7%9A%84%E4%B8%BB%E8%A6%81%E5%BA%94%E7%94%A8"><span class="toc-text">SDçš„ä¸»è¦åº”ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E7%94%9F%E5%9B%BE"><span class="toc-text">æ–‡ç”Ÿå›¾</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%BE%E7%94%9F%E5%9B%BE"><span class="toc-text">å›¾ç”Ÿå›¾</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%BE%E5%83%8Finpainting"><span class="toc-text">å›¾åƒinpainting</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SD-2-0"><span class="toc-text">SD 2.0</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SD-2-0-2"><span class="toc-text">SD 2.0</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SD-2-1"><span class="toc-text">SD 2.1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SD-unclip"><span class="toc-text">SD unclip</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SD%E7%9A%84%E5%85%B6%E5%AE%83%E7%89%B9%E8%89%B2%E5%BA%94%E7%94%A8"><span class="toc-text">SDçš„å…¶å®ƒç‰¹è‰²åº”ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AA%E6%80%A7%E5%8C%96%E7%94%9F%E6%88%90"><span class="toc-text">ä¸ªæ€§åŒ–ç”Ÿæˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A3%8E%E6%A0%BC%E5%8C%96finetune%E6%A8%A1%E5%9E%8B"><span class="toc-text">é£æ ¼åŒ–finetuneæ¨¡å‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%BE%E5%83%8F%E7%BC%96%E8%BE%91"><span class="toc-text">å›¾åƒç¼–è¾‘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E6%8E%A7%E7%94%9F%E6%88%90"><span class="toc-text">å¯æ§ç”Ÿæˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stable-diffusion-webui"><span class="toc-text">stable-diffusion-webui</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E8%AF%9D"><span class="toc-text">åè¯</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-text">å‚è€ƒ</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background-color: transparent;"><div id="footer-wrap"><div id="ft"><div class="ft-item-1"><div class="t-top"><div class="t-t-l"><p class="ft-t t-l-t">æ ¼è¨€ğŸ§¬</p><div class="bg-ad"><div>å†çœ‹çœ‹é‚£ä¸ªå…‰ç‚¹ï¼Œå®ƒå°±åœ¨è¿™é‡Œï¼Œè¿™æ˜¯å®¶å›­ï¼Œè¿™æ˜¯æˆ‘ä»¬ â€”â€” ä½ æ‰€çˆ±çš„æ¯ä¸€ä¸ªäººï¼Œä½ è®¤è¯†çš„ä¸€ä¸ªäººï¼Œä½ å¬è¯´è¿‡çš„æ¯ä¸€ä¸ªäººï¼Œæ›¾ç»æœ‰è¿‡çš„æ¯ä¸€ä¸ªäººï¼Œéƒ½åœ¨å®ƒä¸Šé¢åº¦è¿‡ä»–ä»¬çš„ä¸€ç”Ÿâœ¨</div><div class="btn-xz-box"><a class="btn-xz" target="_blank" rel="noopener" href="https://stellarium.org/">ç‚¹å‡»å¼€å¯æ˜Ÿè¾°ä¹‹æ—…</a></div></div></div><div class="t-t-r"><p class="ft-t t-l-t">çŒœä½ æƒ³çœ‹ğŸ’¡</p><ul class="ft-links"><li><a href="/posts/eec9786.html">é­”æ”¹æŒ‡å—</a><a href="/box/nav/">ç½‘å€å¯¼èˆª</a></li><li><a href="/social/link/">æˆ‘çš„æœ‹å‹</a><a href="/comments/">ç•™ç‚¹ä»€ä¹ˆ</a></li><li><a href="/personal/about/">å…³äºä½œè€…</a><a href="/archives/">æ–‡ç« å½’æ¡£</a></li><li><a href="/categories/">æ–‡ç« åˆ†ç±»</a><a href="/tags/">æ–‡ç« æ ‡ç­¾</a></li><li><a href="/box/Gallery/">æˆ‘çš„ç”»å»Š</a><a href="/personal/bb/">æˆ‘çš„å” å¨</a></li><li><a href="/site/time/">å»ºè®¾è¿›ç¨‹</a><a href="/site/census/">ç½‘ç«™ç»Ÿè®¡</a></li></ul></div></div></div><div class="ft-item-2"><p class="ft-t">æ¨èå‹é“¾âŒ›</p><div class="ft-img-group"><div class="img-group-item"><a href="https://www.fomal.cc/" title="FomalhautğŸ¥"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/60e5d4e39da7c077.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div><div class="img-group-item"><a href="javascript:void(0)" title="å¹¿å‘Šä½æ‹›ç§Ÿ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://lskypro.acozycotage.net/LightPicture/2022/12/65307a5828af6790.webp" alt=""/></a></div></div></div></div><div class="copyright"><span><b>&copy;2022-2023</b></span><span><b>&nbsp;&nbsp;By æŸŠé‡</b></span></div><div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" title="åšå®¢æ¡†æ¶ä¸ºHexo_v6.3.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Frame-Hexo-blue.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" title="ä¸»é¢˜ç‰ˆæœ¬Butterfly_v4.3.1"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Theme-Butterfly-6513df.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://vercel.com/" style="margin-inline:5px" title="æœ¬ç«™é‡‡ç”¨å¤šçº¿éƒ¨ç½²ï¼Œä¸»çº¿è·¯æ‰˜ç®¡äºVercel"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Hosted-Vercel-brightgreen.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://user.51.la/" style="margin-inline:5px" title="æœ¬ç«™æ•°æ®åˆ†æå¾—ç›Šäº51laæŠ€æœ¯æ”¯æŒ"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/Analytics-51la-3db1eb.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://icp.gov.moe/?keyword=20226665" style="margin-inline:5px" title="æœ¬ç«™å·²åŠ å…¥èŒICPè±ªåå¥—é¤ï¼ŒèŒICPå¤‡20226665å·"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/èŒICPå¤‡-20226665-fe1384.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://bitiful.dogecast.com/buckets" style="margin-inline:5px" title="æœ¬ç½‘ç«™ç»Service Workeråˆ†æµè‡³ç¼¤çº·äº‘å¯¹è±¡å­˜å‚¨"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=" https://sourcebucket.s3.ladydaily.com/badge/Bucket-ç¼¤çº·äº‘-9c62da.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://www.netdun.net/" style="margin-inline:5px" title="æœ¬ç«™ä½¿ç”¨ç½‘ç›¾æ˜Ÿçƒæä¾›CDNåŠ é€Ÿä¸é˜²æŠ¤"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sourcebucket.s3.ladydaily.com/badge/CDN-ç½‘ç›¾æ˜Ÿçƒ-fff2cc.svg" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" title="æœ¬ç½‘ç«™æºç ç”±Githubæä¾›å­˜å‚¨ä»“åº“"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src=" https://sourcebucket.s3.ladydaily.com/badge/Source-Github-d021d6.svg" alt=""/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button><button class="share" type="button" title="å³é”®æ¨¡å¼" onclick="changeMouseMode()"><i class="fas fa-mouse"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog right_side"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button class="share" type="button" title="åˆ†äº«é“¾æ¥" onclick="share()"><i class="fas fa-share-nodes"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button><button id="go-down" type="button" title="ç›´è¾¾åº•éƒ¨" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>å¤åˆ¶</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span>ç™¾åº¦æœç´¢</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>ç²˜è´´</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span>ç©ºé™è¯„è®º</span></a><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>å¤åˆ¶æœ¬æ–‡åœ°å€</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>ä¿å­˜å›¾ç‰‡</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>åœ¨æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶å›¾ç‰‡é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:randomPost()"><i class="fa fa-paper-plane"></i><span>éšä¾¿é€›é€›</span></a><a class="rightMenu-item" href="javascript:switchNightMode();"><i class="fa fa-moon"></i><span>æ˜¼å¤œåˆ‡æ¢</span></a><a class="rightMenu-item" href="/personal/about/"><i class="fa fa-info-circle"></i><span>å…³äºåšå®¢</span></a><a class="rightMenu-item" href="javascript:toggleWinbox();"><i class="fas fa-cog"></i><span>ç¾åŒ–è®¾ç½®</span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span>åˆ‡æ¢å…¨å±</span></a><a class="rightMenu-item" href="javascript:window.print();"><i class="fa-solid fa-print"></i><span>æ‰“å°é¡µé¢</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.umd.min.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/instant.page/5.1.0/instantpage.min.js" type="module"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/vanilla-lazyload/17.3.1/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 5000);
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})</script><div class="js-pjax"></div><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script async src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script defer type="text/javascript" src="https://cdn1.tianli0.top/npm/sweetalert2@8.19.0/dist/sweetalert2.all.js"></script><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script defer src="https://cdn1.tianli0.top/gh/nextapps-de/winbox/dist/winbox.bundle.min.js"></script><script async src="//at.alicdn.com/t/c/font_3586335_hsivh70x0fm.js"></script><script async src="//at.alicdn.com/t/c/font_3636804_gr02jmjr3y9.js"></script><script async src="//at.alicdn.com/t/c/font_3612150_kfv55xn3u2g.js"></script><script async src="https://cdn.wpon.cn/2022-sucai/Gold-ingot.js"></script><canvas id="universe"></canvas><canvas id="snow"></canvas><script defer src="/js/fomal.js"></script><script src="https://pv.sohu.com/cityjson?ie=utf-8"></script><script src="/js/ip_content.js"></script><link rel="stylesheet" href="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn1.tianli0.top/npm/js-heo@1.0.12/metingjs/Meting.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show","#web_bg",".js-pjax","#bibi","body > title","#app","#tag-echarts","#posts-echart","#categories-echarts"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://www.fomal.cc/categories/æ¼”ç¤º/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¥ ä½¿ç”¨æ¡ˆä¾‹æ¼”ç¤ºå­˜æ¡£ (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item" style="visibility: hidden"></div><div class="magnet_item" style="visibility: hidden"></div><a class="magnet_link_more"  href="https://www.fomal.cc/categories/" style="flex:1;text-align: center;margin-bottom: 10px;">æŸ¥çœ‹æ›´å¤š...</a></div></div>';
    console.log('å·²æŒ‚è½½magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(33.333333333333336% - 5px);background: #e9e9e9;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: var(--text-bg-hover)}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://picss.sunbangyan.cn/2023/12/09/38a386e44035563b5554b58bffb506fa.jpeg - https://picss.sunbangyan.cn/2023/12/09/38a386e44035563b5554b58bffb506fa.jpeg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-08-09</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">Markdownè¯­æ³•ä¸å¤–æŒ‚æ ‡ç­¾å†™æ³•æ±‡æ€»</a><div class="blog-slider__text">ğŸ¥§æœ¬æ–‡æ±‡æ€»Markdownæ ¼å¼ä»¥åŠå¤–æŒ‚æ ‡ç­¾åœ¨ç½‘é¡µç«¯çš„æ¸²æŸ“æ•ˆæœï¼Œå¯ä½œä¸ºæ–‡æ¡£è¿›è¡ŒæŸ¥è¯¢</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/2013454d.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('å·²æŒ‚è½½butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('gitZone');
      var item_html = '<div class="recent-post-item" id="gitcalendarBar" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 320px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('å·²æŒ‚è½½gitcalendar')
      }

    if( document.getElementById('gitZone') && (location.pathname ==='/site/census/'|| '/site/census/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("/api?null",['#d9e0df', '#c6e0dc', '#a8dcd4', '#9adcd2', '#89ded1', '#77e0d0', '#5fdecb', '#47dcc6', '#39dcc3', '#1fdabe', '#00dab9'],'null')
    }
  </script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><!-- hexo injector body_end end --></body></html>