<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="keywords" content="åŠ¨æ¼«,åœ£åœ°å·¡ç¤¼,æŸŠé‡">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- å“åº”å¼è§†å£è®¾ç½® -->
    <title>åœ£åœ°å·¡ç¤¼åœ°å›¾</title>
    <!-- å¼•å…¥ç™¾åº¦åœ°å›¾API -->
    <script type="text/javascript" src="https://api.map.baidu.com/api?v=3.0&ak=1XjLLEhZhQNUzd93EjU5nOGQ&s=1"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        #mapContainer {
            width: 100%;
            height: calc(100% - 70px); /* è€ƒè™‘åˆ°åº•éƒ¨è¡¨å•çš„é«˜åº¦ */
        }
        #searchForm {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 10px;
            background-color: white;
            z-index: 1000;
        }
        #searchForm label, #searchForm input, #searchForm button {
            margin-bottom: 5px;
        }
        @media screen and (max-width: 768px) {
            #searchForm label, #searchForm input, #searchForm button {
                font-size: 14px;
            }
        }
    </style>
    <script>
        // ç¡®ä¿BMapå¯¹è±¡å®šä¹‰å®Œæˆåå†æ‰§è¡Œåç»­ä»£ç 
        window.onload = function() {
            let map = null;
            // åˆå§‹åŒ–ç™¾åº¦åœ°å›¾
            function initBaiduMap() {
                map = new BMap.Map("mapContainer");
                // è®¾ç½®åœ°å›¾é€‰é¡¹
                map.enableScrollWheelZoom(true); // å¯ç”¨æ»šè½®ç¼©æ”¾
                map.addControl(new BMap.NavigationControl()); // æ·»åŠ å¯¼èˆªæ§ä»¶
                map.addControl(new BMap.ScaleControl()); // æ·»åŠ æ¯”ä¾‹å°ºæ§ä»¶
                // è®¾ç½®åœ°å›¾çš„åˆå§‹ä¸­å¿ƒç‚¹å’Œç¼©æ”¾çº§åˆ«
                map.centerAndZoom(new BMap.Point(116.404, 39.915), 12);
                return map;
            }
            // æ¸…é™¤åœ°å›¾ä¸Šçš„æ‰€æœ‰æ ‡è®°
            function clearMarkers(map) {
                var allOverlays = map.getOverlays();
                for (var i = 0; i < allOverlays.length; i++) {
                    if (allOverlays[i].setMap) {
                        allOverlays[i].setMap(null);
                    }
                }
            }
            // ä»APIè·å–æ•°æ®
            function fetchLandmarks(subjectID) {
                Promise.all([
                    fetch(`https://api.anitabi.cn/bangumi/${subjectID}/lite`),
                    fetch(`https://api.anitabi.cn/bangumi/${subjectID}/points/detail?haveImage=true`)
                ])
                .then(responses => Promise.all(responses.map(r => r.json())))
                .then(([bangumiData, landmarksData]) => {
                    if (!bangumiData || !Array.isArray(landmarksData)) {
                        alert('æ²¡æœ‰æ‰¾åˆ°ä¸æä¾›çš„Bangumiä½œå“IDåŒ¹é…çš„æ•°æ®QAQ');
                        return;
                    }
                    clearMarkers(map); // åœ¨æ·»åŠ æ–°çš„åœ°æ ‡ä¹‹å‰æ¸…é™¤æ—§çš„æ ‡è®°
                    landmarksData.forEach(point => {
                        addMarkerToMap(point, map, bangumiData);
                    });
                    if (bangumiData && bangumiData.geo && bangumiData.zoom) {
                        map.centerAndZoom(new BMap.Point(bangumiData.geo[1], bangumiData.geo[0]), bangumiData.zoom);
                    }
                })
                .catch(error => {
                    console.error('Error fetching landmarks:', error);
                    alert('Error,è¯·è¾“å…¥æœ‰æ•ˆçš„Bangumi IDğŸ˜‚');
                });
            }
            // åœ¨ç™¾åº¦åœ°å›¾ä¸Šæ·»åŠ æ ‡è®°
            function addMarkerToMap(point, map, bangumiData) {
                if (!point.geo || !point.geo[0] || !point.geo[1]) {
                    console.error('Invalid geo coordinates:', point);
                    return;
                }
                var p = new BMap.Point(point.geo[1], point.geo[0]); // æ³¨æ„åæ ‡é¡ºåº
                var marker = new BMap.Marker(p);  // åˆ›å»ºæ ‡æ³¨
                map.addOverlay(marker);              // å°†æ ‡æ³¨æ·»åŠ åˆ°åœ°å›¾ä¸­       
                // åˆ›å»ºä¿¡æ¯çª—å£
                var infoWindowContent = `
                    <b>${bangumiData ? bangumiData.cn : 'æœªçŸ¥ç•ªå‰§'}: ${point.cn || 'æœªçŸ¥åœ°æ ‡'}</b><br>
                    ${point.name || 'æœªçŸ¥åç§°'}<br>
                    <img src="${point.image ? point.image.replace('?plan=h160', '?plan=h360') : 'æ— å›¾ç‰‡'}" width="100" height="auto"><br>
                    Origin: ${point.origin || 'æœªçŸ¥æ¥æº'}<br>
                    <a href="${point.originURL || '#'}" target="_blank">${point.originURL || 'æ— é“¾æ¥'}</a>
                `;  // åˆ›å»ºä¿¡æ¯çª—å£å†…å®¹
                var infoWindow = new BMap.InfoWindow(infoWindowContent);  // åˆ›å»ºä¿¡æ¯çª—å£
                marker.addEventListener("click", function(){ // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    this.openInfoWindow(infoWindow, map, p); // æ‰“å¼€ä¿¡æ¯çª—å£
                });
            }
            // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶å¤„ç†ç¨‹åº
            document.getElementById('searchForm').addEventListener('submit', function(event) {
                event.preventDefault(); // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤è¡Œä¸º
                const subjectID = document.getElementById('subjectID').value;
                if (subjectID.trim() === '') {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„Bangumiä½œå“IDã€‚');
                    return;
                }
                fetchLandmarks(subjectID);
            });
            // åˆå§‹åŒ–åœ°å›¾
            initBaiduMap();
        }
    </script>
</head>
<body>
    <div id="mapContainer"></div>
    <!-- åº•éƒ¨æœç´¢è¡¨å• -->
    <form id="searchForm">
        <label for="subjectID">è¯·è¾“å…¥Bangumiç•ªå‰§ID:</label>
        <input type="text" id="subjectID" name="subjectID" placeholder="ä¾‹å¦‚: 328609ï¼ˆå­¤ç‹¬æ‘‡æ»šï¼‰">
        <button type="submit">æ£€ç´¢</button>
        <a href="/posts/ac0edfe5.html">ã€æ•™ç¨‹ã€‘å¦‚ä½•æŸ¥æ‰¾Bangumiç•ªå‰§ID</a>
    </form>
</body>
</html>